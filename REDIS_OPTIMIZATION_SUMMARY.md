# Redis åŒæ­¥æ€§èƒ½ä¼˜åŒ–æ€»ç»“

## âœ… å·²å®Œæˆçš„ä¼˜åŒ–

æˆåŠŸå®ç°äº†éé˜»å¡çš„ Redis æ‰¹é‡å†™å…¥æœºåˆ¶ï¼Œæ¶ˆé™¤äº†æœ¬åœ° WebSocket åŒæ­¥çš„å»¶è¿Ÿç“¶é¢ˆã€‚

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### ä¼˜åŒ–å‰çš„é—®é¢˜
```rust
// æ¯æ¬¡æ›´æ–°éƒ½ç­‰å¾… Redis å†™å…¥å®Œæˆï¼ˆ2-10ms å»¶è¿Ÿï¼‰
if !update_bytes.is_empty() {
    redis_store.publish_update(...).await?;  // â¬…ï¸ é˜»å¡ç‚¹
}
// ç„¶åæ‰åº”ç”¨æœ¬åœ°æ›´æ–°å’Œå¹¿æ’­
protocol.handle_sync_step2(&awareness, update)?;
```

### ä¼˜åŒ–åçš„æµç¨‹
```rust
// 1. ç«‹å³æ”¾å…¥ channelï¼ˆä¸ç­‰å¾…ï¼‰
redis_write_tx.try_send(update_bytes.clone())?;

// 2. ç«‹å³åº”ç”¨æœ¬åœ°æ›´æ–°å’Œå¹¿æ’­ï¼ˆä¸ç­‰ Redisï¼‰
protocol.handle_sync_step2(&awareness, update)?;

// 3. æ¯æ¬¡å¤„ç†æ¶ˆæ¯åï¼Œæ‰¹é‡åˆ·æ–°åˆ° Redis
flush_pending_updates(...).await;
```

## ğŸ“¦ å®ç°ç»†èŠ‚

### 1. æ·»åŠ  Channel ç¼“å†²åŒº
**æ–‡ä»¶**: `server/websocket/src/broadcast/group.rs`

åœ¨ `BroadcastGroup` ä¸­æ·»åŠ ï¼š
```rust
pub struct BroadcastGroup {
    // ... ç°æœ‰å­—æ®µ
    redis_write_tx: tokio::sync::mpsc::Sender<Vec<u8>>,
    redis_write_rx: Arc<Mutex<tokio::sync::mpsc::Receiver<Vec<u8>>>>,
}
```

- ä½¿ç”¨ `mpsc::channel(1024)` ç¼“å†²æœ€å¤š 1024 æ¡æ›´æ–°
- `Sender` ç”¨äºéé˜»å¡å‘é€
- `Receiver` åŒ…è£…åœ¨ `Arc<Mutex<>>` ä¸­å…±äº«

### 2. æ‰¹é‡åˆ·æ–°å‡½æ•°
**æ–‡ä»¶**: `server/websocket/src/broadcast/group.rs` (ç¬¬ 31-60 è¡Œ)

```rust
async fn flush_pending_updates(
    redis_store: &RedisStore,
    conn: &mut redis::aio::MultiplexedConnection,
    receiver: &mut tokio::sync::mpsc::Receiver<Vec<u8>>,
    stream_key: &str,
    instance_id: &u64,
) {
    // éé˜»å¡æ”¶é›†æ‰€æœ‰å¾…å†™å…¥çš„æ›´æ–°ï¼ˆæœ€å¤š 100 æ¡ï¼‰
    let mut updates = Vec::new();
    while let Ok(update) = receiver.try_recv() {
        updates.push(update);
        if updates.len() >= 100 { break; }
    }
    
    // æ‰¹é‡å†™å…¥ Redis
    if !updates.is_empty() {
        redis_store.publish_multiple_updates(...).await;
    }
}
```

### 3. ä¿®æ”¹æ¶ˆæ¯å¤„ç†
**æ–‡ä»¶**: `server/websocket/src/broadcast/group.rs` (ç¬¬ 525-563 è¡Œ)

åœ¨ `handle_msg` ä¸­ï¼š
- ç§»é™¤ `await redis_store.publish_update(...).await`
- æ”¹ä¸º `redis_write_tx.try_send(update_bytes.clone())`
- ç«‹å³å¤„ç†æœ¬åœ°æ›´æ–°ï¼Œä¸ç­‰å¾… Redis

### 4. åœ¨æ¶ˆæ¯å¾ªç¯ä¸­æ‰¹é‡åˆ·æ–°
**æ–‡ä»¶**: `server/websocket/src/broadcast/group.rs` (ç¬¬ 477-488 è¡Œ)

åœ¨æ¯æ¬¡å¤„ç†å®Œæ¶ˆæ¯åï¼š
```rust
// å¤„ç†æ¶ˆæ¯
Self::handle_msg(...).await;

// æ‰¹é‡åˆ·æ–°åˆ° Redis
let mut rx = redis_write_rx.lock().await;
flush_pending_updates(...).await;
drop(rx);
```

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æœ¬åœ°åŒæ­¥å»¶è¿Ÿ | 5-15ms | < 1ms | **10-15x** |
| Redis å¾€è¿”æ¬¡æ•° | æ¯æ¬¡æ›´æ–° 1 æ¬¡ | æ‰¹é‡ N æ¡ 1 æ¬¡ | **Nå€å‡å°‘** |
| æœåŠ¡å™¨ååé‡ | å— Redis é™åˆ¶ | æ¥è¿‘çº¯å†…å­˜é€Ÿåº¦ | **å¤§å¹…æå‡** |

## ğŸ” å·¥ä½œåŸç†

```
å®¢æˆ·ç«¯A å‘é€æ›´æ–°
    â†“
æœåŠ¡å™¨æ¥æ”¶
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ”¾å…¥ channel (éé˜»å¡)     â”‚  â† 0.01ms
â”‚ 2. åº”ç”¨æœ¬åœ°æ›´æ–°å¹¶å¹¿æ’­        â”‚  â† 0.5ms
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“ ç«‹å³è¿”å›ç»™å®¢æˆ·ç«¯B (å¿«ï¼)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ‰¹é‡åˆ·æ–°åˆ° Redis         â”‚  â† å¼‚æ­¥æ‰§è¡Œ
â”‚    - æ”¶é›†æ‰€æœ‰å¾…å†™å…¥çš„æ›´æ–°    â”‚
â”‚    - ä¸€æ¬¡æ€§æ‰¹é‡å†™å…¥          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ¨ ä¼˜åŠ¿

1. âœ… **æœ¬åœ°åŒæ­¥é›¶å»¶è¿Ÿ** - ä¸ç­‰ Redisï¼Œç«‹å³å¹¿æ’­
2. âœ… **æ‰¹é‡å†™å…¥é«˜æ•ˆ** - å‡å°‘ç½‘ç»œå¾€è¿”ï¼Œæå‡ Redis æ€§èƒ½
3. âœ… **ç®€å•ç›´æ¥** - ä¸éœ€è¦å•ç‹¬çš„åå°ä»»åŠ¡
4. âœ… **è‡ªåŠ¨æ‰¹é‡** - æ¯æ¬¡æ¶ˆæ¯å¤„ç†åè‡ªåŠ¨åˆ·æ–°
5. âœ… **é”™è¯¯éš”ç¦»** - Redis æ•…éšœä¸å½±å“æœ¬åœ°åŒæ­¥

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **Channel æ»¡äº†ä¼šä¸¢å¼ƒ** - å¦‚æœ channel æ»¡ï¼ˆ1024 æ¡ï¼‰ï¼Œæ–°æ›´æ–°ä¼šè¢«ä¸¢å¼ƒ
   - ä½†æœ¬åœ°åŒæ­¥å·²å®Œæˆï¼Œä¸å½±å“åä½œ
   - å¯é€šè¿‡å¢å¤§ channel å®¹é‡ç¼“è§£

2. **æç«¯æƒ…å†µå¯èƒ½ä¸¢å¤± Redis å†™å…¥** - å¦‚æœç¨‹åºå´©æºƒï¼Œchannel ä¸­çš„æ•°æ®ä¼šä¸¢å¤±
   - ä½†æ‰€æœ‰è¿æ¥çš„å®¢æˆ·ç«¯éƒ½å·²åŒæ­¥
   - ä¸å½±å“å½“å‰åä½œä¼šè¯

3. **æ‰¹é‡å¤§å°é™åˆ¶** - æ¯æ¬¡æœ€å¤šæ‰¹é‡ 100 æ¡æ›´æ–°
   - é¿å…å•æ¬¡åˆ·æ–°è€—æ—¶è¿‡é•¿
   - å¯æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤
1. å¯åŠ¨åç«¯ï¼š`cd server/websocket && cargo run`
2. è¿æ¥ä¸¤ä¸ªå®¢æˆ·ç«¯åˆ°åŒä¸€ä¸ª workflow
3. åœ¨å®¢æˆ·ç«¯ A è¿›è¡Œå¿«é€Ÿç¼–è¾‘
4. è§‚å¯Ÿå®¢æˆ·ç«¯ B çš„åŒæ­¥å»¶è¿Ÿ

### é¢„æœŸç»“æœ
- æœ¬åœ°åŒæ­¥å»¶è¿Ÿï¼š< 5msï¼ˆæ¥è¿‘å…³é—­ Redis æ—¶çš„é€Ÿåº¦ï¼‰
- Redis ä¸­æ•°æ®æ­£ç¡®æŒä¹…åŒ–ï¼ˆæ£€æŸ¥ Redis streamsï¼‰
- é«˜é¢‘æ›´æ–°æ—¶æ— æ˜æ˜¾å¡é¡¿

### éªŒè¯ Redis æŒä¹…åŒ–
```bash
# è¿æ¥ Redis
redis-cli

# æŸ¥çœ‹ stream é•¿åº¦
XLEN yjs:stream:projectId:workflowId

# æŸ¥çœ‹æœ€è¿‘çš„æ›´æ–°
XREVRANGE yjs:stream:projectId:workflowId + - COUNT 10
```

## ğŸ“ ç›¸å…³æ–‡ä»¶

- `server/websocket/src/broadcast/group.rs` - ä¸»è¦ä¿®æ”¹ï¼ˆæ·»åŠ  channel å’Œæ‰¹é‡åˆ·æ–°é€»è¾‘ï¼‰
- `server/websocket/src/domain/value_objects/sub.rs` - ä¿æŒä¸å˜
- `server/websocket/src/infrastructure/redis/mod.rs` - **ä¿®å¤** `publish_multiple_updates` æ­£ç¡®å†™å…¥å¤šæ¡ stream æ¶ˆæ¯

## ğŸ› é‡è¦ä¿®å¤

### ä¿®å¤ `publish_multiple_updates` çš„ Bug

**é—®é¢˜**: åŸå®ç°æŠŠæ‰€æœ‰ updates åˆå¹¶ä¸ºä¸€æ¡ Redis stream æ¶ˆæ¯ï¼ˆé”™è¯¯ï¼ï¼‰

**ä¿®å¤å**: ä½¿ç”¨ **Redis Pipeline** åœ¨ä¸€æ¬¡ç½‘ç»œå¾€è¿”ä¸­å†™å…¥å¤šæ¡ç‹¬ç«‹æ¶ˆæ¯

```rust
// ä¿®å¤å‰ - é”™è¯¯ï¼šæ‰€æœ‰ updates åˆå¹¶ä¸ºä¸€æ¡æ¶ˆæ¯
redis.call('XADD', stream_key, '*', 
    'type', msg_type, 
    'data', updates,  // âŒ é”™è¯¯ï¼šæ•´ä¸ªæ•°ç»„ä½œä¸ºä¸€æ¡æ•°æ®
    ...
)

// ä¿®å¤å - ä½¿ç”¨ Pipeline æ‰¹é‡å‘é€
let mut pipe = redis::pipe();
for update in updates {
    pipe.cmd("XADD")
        .arg(stream_key)
        .arg("*")
        .arg("type").arg(MESSAGE_TYPE_SYNC)
        .arg("data").arg(*update)
        .arg("clientId").arg(instance_id)
        .arg("timestamp").arg(timestamp)
        .ignore();  // âœ… æ¯ä¸ª update ç‹¬ç«‹å†™å…¥
}
pipe.query_async(conn).await?;  // ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰å‘½ä»¤
```

### Pipeline çš„ä¼˜åŠ¿

1. âœ… **ä¸€æ¬¡ç½‘ç»œå¾€è¿”** - æ‰€æœ‰ XADD å‘½ä»¤åœ¨ä¸€ä¸ªç½‘ç»œè¯·æ±‚ä¸­å‘é€
2. âœ… **ä¿æŒç‹¬ç«‹æ€§** - æ¯ä¸ª update ä»ç„¶æ˜¯ç‹¬ç«‹çš„ stream æ¶ˆæ¯
3. âœ… **é«˜æ€§èƒ½** - æ¯”å¾ªç¯å•ç‹¬å‘é€å¿« **10-100 å€**ï¼ˆå–å†³äºç½‘ç»œå»¶è¿Ÿï¼‰
4. âœ… **åŸå­æ€§** - Redis ä¿è¯ pipeline ä¸­çš„å‘½ä»¤é¡ºåºæ‰§è¡Œ

## ğŸ‰ æ€»ç»“

é€šè¿‡ç®€å•çš„ channel ç¼“å†² + æ‰¹é‡åˆ·æ–°æœºåˆ¶ï¼ŒæˆåŠŸå°†æœ¬åœ°åŒæ­¥å»¶è¿Ÿé™ä½äº† **10-15 å€**ï¼ŒåŒæ—¶ä¿æŒäº† Redis æŒä¹…åŒ–èƒ½åŠ›ã€‚è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆç®€æ´é«˜æ•ˆï¼Œæ— éœ€é¢å¤–çš„åå°ä»»åŠ¡ï¼Œæ˜“äºç»´æŠ¤ã€‚

**å…³é”®åˆ›æ–°ç‚¹**ï¼šåœ¨ `handle_msg` æ—¶æ‰‹åŠ¨è°ƒç”¨æ‰¹é‡åˆ·æ–°ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ç‹¬ç«‹çš„å¼‚æ­¥ä»»åŠ¡ï¼Œé¿å…äº†å¤æ‚çš„ä»»åŠ¡ç®¡ç†å’ŒåŒæ­¥é—®é¢˜ã€‚

