# yaml-language-server: $schema=https://raw.githubusercontent.com/reearth/reearth-flow/main/engine/schema/workflow.json
id: 6a8c4f2e-9b1d-4e7a-b3c5-6f8e2a4b9d7c
name: SolarRadiationWorkflow
entryGraphId: 34bf873b-3364-46b0-8153-efeb9568bb3c
with:
  bldgCityGmlPath:
  demCityGmlPath:
  roofFilterShapefilePath:
  roofFilterEpsgCode: 4326
  codelistsPath:
  schemasPath:
  codelists:
  schemas:
  prcs:
  startTime:
  endTime:
  workerArtifactPath:
  outputReflection: false
  dailySunDataPath:
  monthlyWeatherDataPath:
  snowDepthDataPath:
  maxRadiationPerDay: 7.5 # W/m^2
  directNormalIrradianceFactor: 1.367 # W/m^2
  photovoltaicConversionEfficiency: 0.167
  lossConstant: 0.88
  monthlyTransmissivity:
    - 0.75 # January
    - 0.72 # February
    - 0.67 # March
    - 0.64 # April
    - 0.64 # May
    - 0.62 # June
    - 0.63 # July
    - 0.64 # August
    - 0.68 # September
    - 0.71 # October
    - 0.74 # November
    - 0.75 # December
graphs:
  - !include ../../graphs/plateau4/folder_and_file_path_reader.yml
  - !include cloud_factor.yml
  - id: 34bf873b-3364-46b0-8153-efeb9568bb3c
    name: main
    nodes:
      - id: 00000001-0000-0000-0000-000000000001
        name: BldgFeatureCreator
        type: action
        action: FeatureCreator
        with:
          creator: |
            [
              #{
                cityGmlPath: env.get("bldgCityGmlPath"),
                cityCode: env.get("cityCode") ?? file::extract_filename(env.get("bldgCityGmlPath"))[0..5],
                baseCityCode: env.get("cityCode") ?? file::extract_filename(env.get("bldgCityGmlPath"))[0..5],
                codelists: env.get("codelistsPath") ?? env.get("codelists"),
                schemas: env.get("schemasPath") ?? env.get("schemas"),
              },
            ]

      - id: 00000001-0000-0000-0000-000000000111
        name: FolderAndFilePathReader
        type: subGraph
        subGraphId: c6863b71-953b-4d15-af56-396fc93fc617

      # ========================================
      # DEM Import Pipeline
      # ========================================

      - id: 00000002-0000-0000-0000-000000000001
        name: DEMFeatureCreator
        type: action
        action: FeatureCreator
        with:
          creator: |
            [
              #{
                cityGmlPath: env.get("demCityGmlPath"),
                cityCode: env.get("cityCode") ?? file::extract_filename(env.get("demCityGmlPath"))[0..5],
                baseCityCode: env.get("cityCode") ?? file::extract_filename(env.get("demCityGmlPath"))[0..5],
                codelists: env.get("codelistsPath") ?? env.get("codelists"),
                schemas: env.get("schemasPath") ?? env.get("schemas"),
              },
            ]

      - id: 00000002-0000-0000-0000-000000000002
        name: DEMDirectoryDecompressor
        type: action
        action: DirectoryDecompressor
        with:
          archiveAttributes:
            - codelists
            - schemas

      - id: 00000002-0000-0000-0000-000000000003
        name: DEMFeatureFilePathExtractor
        type: action
        action: FeatureFilePathExtractor
        with:
          sourceDataset: |
            env.get("__value")["cityGmlPath"]
          extractArchive: true
          destPrefix: udx

      - id: 00000002-0000-0000-0000-000000000004
        name: DEMFeatureFilterByGml
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value").extension == "gml"
              outputPort: default

      - id: 00000002-0000-0000-0000-000000000005
        name: DEMPLATEAU4UDXFolderExtractor
        type: action
        action: PLATEAU4.UDXFolderExtractor
        with:
          cityGmlPath: |
            env.get("__value")["path"]
          codelistsPath: codelists
          schemasPath: schemas

      - id: 00000002-0000-0000-0000-000000000006
        name: DEMPLATEAU4CityGmlMeshBuilder
        type: action
        action: PLATEAU4.CityGmlMeshBuilder
        with:
          errorAttribute: _validation_error
          epsgCode: |
            env.get("prcs")

      - id: 00000001-0000-0000-0000-000000000002
        name: CityGmlReader
        type: action
        action: FeatureCityGmlReader
        with:
          codelistsPath: env.get("__value").codelists
          flatten: true
          dataset: |
            env.get("__value")["path"]

      # Filter by LOD level: LOD2 → default (solar pipeline), LOD1/3/4 → separate 3DTiles writers, LOD0 → dropped
      - id: 00000001-0000-0000-0000-00000000003a
        name: LodFilter
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                let lod = env.get("__value").lod;
                lod == 1 || lod == "1";
              outputPort: lod1
            - expr: |
                let lod = env.get("__value").lod;
                lod == 2 || lod == "2";
              outputPort: default
            - expr: |
                let lod = env.get("__value").lod;
                lod == 3 || lod == "3";
              outputPort: lod3
            - expr: |
                let lod = env.get("__value").lod;
                lod == 4 || lod == "4";
              outputPort: lod4

      # Keep only featureType attribute to reduce memory footprint
      - id: 00000001-0000-0000-0000-00000000003b
        name: KeepFeatureType
        type: action
        action: AttributeMapper
        with:
          mappers:
          - attribute: featureType
            expr: env.get("__value").featureType
          - attribute: gmlId
            expr: env.get("__value").gmlId

      - id: 00000001-0000-0000-0000-000000000004
        name: GeometryPartExtractor
        type: action
        action: GeometryPartExtractor

      # Assign stable surfaceId per geometry part (before pipeline splits)
      - id: 00000001-0000-0000-0000-000000000041
        name: SurfaceIdCounter
        type: action
        action: FeatureCounter
        with:
          countStart: 0
          outputAttribute: surfaceId

      - id: 00000001-0000-0000-0000-000000000005
        name: HorizontalReprojector
        type: action
        action: HorizontalReprojector
        with:
          targetEpsgCode: |
            env.get("prcs")

      # ========================================
      # Optional Roof Restriction Polygon
      # ========================================

      - id: 00000004-0000-0000-0000-000000000001
        name: RoofFilterShapefileReader
        type: action
        action: ShapefileReader
        with:
          dataset: |
            env.get("roofFilterShapefilePath") ?? ""
          force2D: true

      - id: 00000004-0000-0000-0000-000000000002
        name: RoofFilterReprojector
        type: action
        action: HorizontalReprojector
        with:
          sourceEpsgCode: |
            env.get("roofFilterEpsgCode")
          targetEpsgCode: |
            env.get("prcs")

      - id: 00000004-0000-0000-0000-000000000003
        name: RoofSpatialFilter
        type: action
        action: SpatialFilter
        with:
          predicate: intersects

      - id: 00000001-0000-0000-0000-000000000006
        name: GeometrySplitter
        type: action
        action: GeometrySplitter
        with:
          splitLevel: polygon

      # Note: GeometryCoercer removed to preserve CityGmlGeometry for 3D tiles output
      # PolygonNormalExtractor now supports CityGmlGeometry directly

      # ========================================
      # Section 2: Surface Analysis
      # ========================================

      - id: 00000001-0000-0000-0000-000000000008
        name: PolygonNormalExtractor
        type: action
        action: PolygonNormalExtractor

      - id: 00000001-0000-0000-0000-000000000009
        name: GridDivider
        type: action
        action: GridDivider
        with:
          unitSquareSize: 1.0
          keepSquareOnly: true

      - id: 00000001-0000-0000-0000-00000000000a
        name: FilterRoofSurfaces
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["featureType"] == "bldg:RoofSurface";
              outputPort: default

      # Counter to assign stable cellId per physical grid cell (before timestep expansion)
      - id: 00000001-0000-0000-0000-000000000029
        name: GridCellIdCounter
        type: action
        action: FeatureCounter
        with:
          countStart: 0
          outputAttribute: cellId

      # ========================================
      # Section 3: Solar Position Calculation
      # ========================================

      - id: 00000001-0000-0000-0000-00000000000b
        name: SunPositionCalculator
        type: action
        action: PLATEAU4.SolarPositionCalculator
        with:
          type: duration
          start: |
            env.get("startTime")
          end: |
            env.get("endTime")
          step: "1"
          stepUnit: hour
          sourceEpsg: |
            env.get("prcs")
          outputType: both

      # Convert year, month, date, hour to integers from solarTime (RFC 3339)
      - id: 00000001-0000-0000-0000-000000000040
        name: ConvertDateTimeToIntegers
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: year
              method: create
              value: |
                let dt = env.get("__value")["solarTime"];
                parse_int(dt.split("-")[0])
            - attribute: month
              method: create
              value: |
                let dt = env.get("__value")["solarTime"];
                parse_int(dt.split("-")[1])
            - attribute: date
              method: create
              value: |
                let dt = env.get("__value")["solarTime"];
                let day_part = dt.split("T")[0];
                parse_int(day_part.split("-")[2])
            - attribute: hour
              method: create
              value: |
                let dt = env.get("__value")["solarTime"];
                let time_part = dt.split("T")[1];
                parse_int(time_part.split(":")[0])

      - id: 00000001-0000-0000-0000-00000000000c
        name: AreaCalculator
        type: action
        action: AreaCalculator
        with:
          areaType: slopedArea
          outputAttribute: cellArea
          multiplier: 1.0

      - id: 00000001-0000-0000-0000-000000000031
        name: GeometryRemover
        type: action
        action: GeometryRemover

      # Restrict attributes before the ray port to reduce feature payload
      - id: 00000001-0000-0000-0000-000000000032
        name: PreRayAttributeMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: gmlId
              expr: env.get("__value").gmlId
            - attribute: surfaceId
              expr: env.get("__value").surfaceId
            - attribute: cellId
              expr: env.get("__value").cellId
            - attribute: year
              expr: env.get("__value").year
            - attribute: month
              expr: env.get("__value").month
            - attribute: slope
              expr: env.get("__value").slope
            - attribute: solarAltitude
              expr: env.get("__value").solarAltitude
            - attribute: solarTime
              expr: env.get("__value").solarTime
            - attribute: cellArea
              expr: env.get("__value").cellArea
            - attribute: cosTheta
              expr: env.get("__value").cosTheta
            - attribute: groundReflectivity
              expr: env.get("__value").groundReflectivity
            - attribute: rayOriginX
              expr: env.get("__value").rayOriginX
            - attribute: rayOriginY
              expr: env.get("__value").rayOriginY
            - attribute: rayOriginZ
              expr: env.get("__value").rayOriginZ
            - attribute: solarDirectionX
              expr: env.get("__value").solarDirectionX
            - attribute: solarDirectionY
              expr: env.get("__value").solarDirectionY
            - attribute: solarDirectionZ
              expr: env.get("__value").solarDirectionZ
            - attribute: normalX
              expr: env.get("__value").normalX
            - attribute: normalY
              expr: env.get("__value").normalY
            - attribute: normalZ
              expr: env.get("__value").normalZ

      # ========================================
      # Section 5: Shadow Detection
      # ========================================

      - id: 00000001-0000-0000-0000-000000000010
        name: RayIntersectorShadow
        type: action
        action: RayIntersector
        with:
          # All rays are checked with all geometries
          pairId: |
            "all"
          closestIntersectionOnly: "true"
          includeRayOrigin: "false"
          tolerance: "0.01"
          outputGeometryType: lineSegmentToIntersection
          ray:
            posX: rayOriginX
            posY: rayOriginY
            posZ: rayOriginZ
            dirX: solarDirectionX
            dirY: solarDirectionY
            dirZ: solarDirectionZ


      # ========================================
      # Snow Factor Sub-flow
      # ========================================

      - id: 00000003-0000-0000-0000-000000000001
        name: SnowCSVReader
        type: action
        action: CsvReader
        with:
          format: csv
          dataset: |
            env.get("snowDepthDataPath")
          offset: 1
          headerRows: 0

      - id: 00000003-0000-0000-0000-000000000002
        name: SnowFeatureFilter
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["column1"] == "9";
              outputPort: default

      - id: 00000003-0000-0000-0000-000000000003
        name: SnowAttributeMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: month
              expr: |
                parse_int(env.get("__value")["column2"])
            - attribute: date
              expr: |
                parse_int(env.get("__value")["column3"])
            - attribute: groundReflectivity
              expr: |
                if parse_float(env.get("__value")["column29"]) < 10.0 { 0.1 } else { 0.7 }

      - id: 00000003-0000-0000-0000-000000000004
        name: SnowFactorMerger
        type: action
        action: FeatureMerger
        with:
          requestorAttribute:
            - month
            - date
          supplierAttribute:
            - month
            - date

      # ========================================
      # Section 6: Direct Radiation Computation (non-shadowed surfaces)
      # ========================================

      # First compute cos_theta and ray endpoints
      - id: 00000001-0000-0000-0000-000000000011
        name: ComputeCosTheta
        type: action
        action: AttributeManager
        with:
          operations:
            # cos(theta) = solar_dir · normal (dot product of unit vectors)
            - attribute: cosTheta
              method: create
              value: |
                let sdx = env.get("__value")["solarDirectionX"];
                let sdy = env.get("__value")["solarDirectionY"];
                let sdz = env.get("__value")["solarDirectionZ"];
                let nx = env.get("__value")["normalX"];
                let ny = env.get("__value")["normalY"];
                let nz = env.get("__value")["normalZ"];
                let cos_th = sdx * nx + sdy * ny + sdz * nz;
                if cos_th < 0.0 { 0.0 } else { cos_th }

      # Compute DT using the cos_theta from previous step
      # month is already an integer from ConvertDateTimeToIntegers
      - id: 00000001-0000-0000-0000-00000000001d
        name: ComputeRadiation
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: radiationSunny
              method: create
              value: |
                let p = env.get("monthlyTransmissivity")[env.get("__value").month - 1];
                let h_rad = env.get("__value").solarAltitude * math::PI / 180.0;
                let m = 1.0 / math::sin(h_rad);
                let beta_m = math::pow(p, m);
                let DT = env.get("directNormalIrradianceFactor") * beta_m * env.get("__value").cosTheta * env.get("__value").cellArea;

                let dN = 1 - beta_m;
                let dD = 1 - 1.4 * math::ln(p);
                let SH = env.get("directNormalIrradianceFactor") * math::sin(h_rad) * (dN / dD) * 0.5;
                let tilt_rad = env.get("__value").slope * math::PI / 180.0;
                let ST = SH * (1 + math::cos(tilt_rad)) / 2;

                let TH = env.get("directNormalIrradianceFactor") * math::sin(h_rad) + SH;
                let RT = TH * (1 - math::cos(tilt_rad)) / 2 * env.get("__value").groundReflectivity;

                DT + ST + RT

            - attribute: radiationCloudy
              method: create
              value: |
                let p = 1.0 - env.get("monthlyTransmissivity")[env.get("__value").month - 1];
                let h_rad = env.get("__value").solarAltitude * math::PI / 180.0;
                let m = 1.0 / math::sin(h_rad);
                let beta_m = math::pow(p, m);
                let DT = env.get("directNormalIrradianceFactor") * beta_m * env.get("__value").cosTheta * env.get("__value").cellArea;

                let dN = 1 - beta_m;
                let dD = 1 - 1.4 * math::ln(p);
                let SH = env.get("directNormalIrradianceFactor") * math::sin(h_rad) * (dN / dD) * 0.5;
                let tilt_rad = env.get("__value").slope * math::PI / 180.0;
                let ST = SH * (1 + math::cos(tilt_rad)) / 2;

                let TH = env.get("directNormalIrradianceFactor") * math::sin(h_rad) + SH;
                let RT = TH * (1 - math::cos(tilt_rad)) / 2 * env.get("__value").groundReflectivity;

                DT + ST + RT

      # ========================================
      # Section 6b: Monthly Radiation with Cloud Factor
      # ========================================

      # Cloud Factor Calculator subgraph - computes sunny ratio per month
      - id: 00000001-0000-0000-0000-000000000050
        name: CloudFactorCalculator
        type: subGraph
        subGraphId: b2f4a1c8-7e3d-4b9a-8c5f-1a2e3b4c5d6e

      # Aggregate radiationSunny and radiationCloudy by year/month/cell/surface
      - id: 00000001-0000-0000-0000-000000000051
        name: MonthlyDTAggregator
        type: action
        action: StatisticsCalculator
        with:
          groupBy:
            - year
            - month
            - cellId
            - surfaceId
            - gmlId
          calculations:
            - newAttribute: radiationSunnySum
              expr: |
                env.get("__value")["radiationSunny"]
            - newAttribute: radiationCloudySum
              expr: |
                env.get("__value")["radiationCloudy"]

      # Merge cloud factor (sunnyRatio) with monthly DT sums
      - id: 00000001-0000-0000-0000-000000000052
        name: CloudFactorDTMerger
        type: action
        action: FeatureMerger
        with:
          requestorAttribute:
            - year
            - month
          supplierAttribute:
            - year
            - month

      # Calculate radiationPerMonth using sunny ratio
      - id: 00000001-0000-0000-0000-000000000053
        name: CalcradiationPerMonth
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: radiationPerMonth
              method: create
              value: |
                let sunny_ratio = env.get("__value")["sunnyRatio"] ?? 0.0;
                let dt_sunny = env.get("__value")["radiationSunnySum"] ?? 0.0;
                let dt_cloudy = env.get("__value")["radiationCloudySum"] ?? 0.0;
                sunny_ratio * dt_sunny + (1.0 - sunny_ratio) * dt_cloudy

      # ========================================
      # Section 6c: Total Radiation Aggregation for 3D Tiles
      # ========================================

      # Aggregate radiationPerMonth across all months per cell for unique cellId in ImageRasterizer
      - id: 00000001-0000-0000-0000-000000000071
        name: TotalRadiationAggregator
        type: action
        action: StatisticsCalculator
        with:
          groupBy:
            - cellId
            - surfaceId
            - gmlId
          calculations:
            - newAttribute: totalSolarRadiation
              expr: |
                env.get("__value")["radiationPerMonth"]
            - newAttribute: totalSolarPower
              expr: |
                let dt = env.get("__value")["radiationPerMonth"] ?? 0.0;
                dt * env.get("photovoltaicConversionEfficiency") * env.get("lossConstant")

      # Aggregate total radiation per surface (sum across all cells of a roof surface)
      - id: 00000001-0000-0000-0000-000000000074
        name: SurfaceRadiationAggregator
        type: action
        action: StatisticsCalculator
        with:
          groupBy:
            - surfaceId
            - gmlId
          calculations:
            - newAttribute: totalSolarRadiation
              expr: |
                env.get("__value")["radiationPerMonth"]
            - newAttribute: totalSolarPower
              expr: |
                let dt = env.get("__value")["radiationPerMonth"] ?? 0.0;
                dt * env.get("photovoltaicConversionEfficiency") * env.get("lossConstant")

      # Merge per-surface solar totals onto roof geometry features
      - id: 00000001-0000-0000-0000-000000000075
        name: SolarAttributeMerger
        type: action
        action: FeatureMerger
        with:
          requestorAttribute:
            - surfaceId
          supplierAttribute:
            - surfaceId

      # Add Japanese-named schema attributes for 3D Tiles output
      - id: 00000001-0000-0000-0000-000000000073
        name: AddSolarSchemaAttributes
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: 予測日射量
              method: create
              value: |
                env.get("__value")["totalSolarRadiation"] ?? ()
            - attribute: 予測発電量
              method: create
              value: |
                env.get("__value")["totalSolarPower"] ?? ()
            - attribute: シミュレーション開始日時
              method: create
              value: |
                env.get("startTime")
            - attribute: シミュレーション終了日時
              method: create
              value: |
                env.get("endTime")

      # ========================================
      # Section 6d: Textured 3D Tiles Output
      # ========================================

      # Normalize radiation per day and by maxRadiationPerDay to get t in [0, 1]
      - id: 00000001-0000-0000-0000-000000000070
        name: NormalizeRadiationForColorMapping
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: normalizedRadiation
              method: create
              value: |
                let start_str = env.get("startTime");
                let s_date_parts = start_str.split("-");
                let s_year = parse_float(s_date_parts[0]);
                let s_month = parse_float(s_date_parts[1]);
                let s_day_val = parse_float(s_date_parts[2][..2]);
                let s_a = math::floor((14.0 - s_month) / 12.0);
                let s_y = s_year + 4800.0 - s_a;
                let s_m = s_month + 12.0 * s_a - 3.0;
                let s_jdn = s_day_val + math::floor((153.0 * s_m + 2.0) / 5.0) + 365.0 * s_y + math::floor(s_y / 4.0) - math::floor(s_y / 100.0) + math::floor(s_y / 400.0) - 32045.0;
                let end_str = env.get("endTime");
                let e_date_parts = end_str.split("-");
                let e_year = parse_float(e_date_parts[0]);
                let e_month = parse_float(e_date_parts[1]);
                let e_day_val = parse_float(e_date_parts[2][..2]);
                let e_a = math::floor((14.0 - e_month) / 12.0);
                let e_y = e_year + 4800.0 - e_a;
                let e_m = e_month + 12.0 * e_a - 3.0;
                let e_jdn = e_day_val + math::floor((153.0 * e_m + 2.0) / 5.0) + 365.0 * e_y + math::floor(e_y / 4.0) - math::floor(e_y / 100.0) + math::floor(e_y / 400.0) - 32045.0;
                let num_days_raw = e_jdn - s_jdn;
                let num_days = if num_days_raw <= 0.0 { 1.0 } else { num_days_raw };
                let dt = env.get("__value")["totalSolarRadiation"] ?? 0.0;
                let max_rad = env.get("maxRadiationPerDay") ?? 7.5;
                let t_raw = dt / num_days / max_rad;
                if t_raw < 0.0 { 0.0 } else if t_raw > 1.0 { 1.0 } else { t_raw }

      # Force 2D for rasterization (project 3D cells to 2D plane)
      - id: 00000001-0000-0000-0000-00000000005f
        name: CellTwoDimensionForcer
        type: action
        action: TwoDimensionForcer

      # Convert radiationPerMonth to RGB colors for rasterization
      - id: 00000001-0000-0000-0000-000000000060
        name: RadiationToColorMapper
        type: action
        action: AttributeManager
        with:
          operations:
            # Map normalized radiation t in [0,1] to blue-cyan-yellow-red color gradient
            # r = clamp(4t-1), g = clamp(4t) - clamp(4t-3), b = 1 - clamp(4t-1)
            - attribute: color_r
              method: create
              value: |
                let t = env.get("__value")["normalizedRadiation"] ?? 0.0;
                let v = 4.0 * t - 1.0;
                let r = if v < 0.0 { 0.0 } else if v > 1.0 { 1.0 } else { v };
                math::round(255.0 * r)
            - attribute: color_g
              method: create
              value: |
                let t = env.get("__value")["normalizedRadiation"] ?? 0.0;
                let v1_raw = 4.0 * t;
                let v1 = if v1_raw < 0.0 { 0.0 } else if v1_raw > 1.0 { 1.0 } else { v1_raw };
                let v2_raw = 4.0 * t - 3.0;
                let v2 = if v2_raw < 0.0 { 0.0 } else if v2_raw > 1.0 { 1.0 } else { v2_raw };
                math::round(255.0 * (v1 - v2))
            - attribute: color_b
              method: create
              value: |
                let t = env.get("__value")["normalizedRadiation"] ?? 0.0;
                let v = 4.0 * t - 1.0;
                let clamped = if v < 0.0 { 0.0 } else if v > 1.0 { 1.0 } else { v };
                math::round(255.0 * (1.0 - clamped))

      # Merge colors back to original cell polygons (which have geometry)
      # The aggregation pipeline loses geometry, so we need to restore it from CellIdCounter
      - id: 00000001-0000-0000-0000-000000000068
        name: CellGeometryMerger
        type: action
        action: FeatureMerger
        with:
          requestorAttribute:
            - cellId
          supplierAttribute:
            - cellId

      # Extract bounds (especially maxZ) before forcing to 2D
      - id: 00000001-0000-0000-0000-000000000069
        name: CellBoundsExtractor
        type: action
        action: BoundsExtractor
        with:
          zmax: maxZ

      # Filter to keep only roof surfaces for texture assignment
      - id: 00000001-0000-0000-0000-00000000006a
        name: FilterRoofForTexture
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["featureType"] == "bldg:RoofSurface";
              outputPort: default

      # ImageRasterizer: creates texture from colored cells and assigns UV to roof geometry
      - id: 00000001-0000-0000-0000-000000000061
        name: ImageRasterizer
        type: action
        action: ImageRasterizer
        with:
          imageWidth: 2048
          saveTo: |
            file::join_path(env.get("workerArtifactPath"), "roof_radiation_texture.png")
          onOverlap:
            max: |
              env.get("__value")["maxZ"]

      # Reproject textured geometry from projected CRS to WGS84
      - id: 00000001-0000-0000-0000-000000000062
        name: TexturedHorizontalReprojector
        type: action
        action: HorizontalReprojector
        with:
          sourceEpsgCode: |
            env.get("prcs")
          targetEpsgCode: |
            6697

      # BoundsExtractor for textured geometry
      - id: 00000001-0000-0000-0000-000000000063
        name: TexturedBoundsExtractor
        type: action
        action: BoundsExtractor
        with:
          xmin: _xmin
          xmax: _xmax
          ymin: _ymin
          ymax: _ymax
          zmin: _zmin
          zmax: _zmax

      # Calculate center coordinates for tiling
      - id: 00000001-0000-0000-0000-000000000064
        name: TexturedCenterCoords
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: _x
              method: create
              value: |
                (env.get("__value")._xmin + env.get("__value")._xmax) * 0.5
            - attribute: _y
              method: create
              value: |
                (env.get("__value")._ymin + env.get("__value")._ymax) * 0.5

      # Vertical reprojection for textured geometry
      - id: 00000001-0000-0000-0000-000000000065
        name: TexturedVerticalReprojector
        type: action
        action: VerticalReprojector
        with:
          reprojectorType: jgd2011ToWgs84

      # Write textured 3D Tiles
      - id: 00000001-0000-0000-0000-000000000066
        name: Textured3DTilesWriter
        type: action
        action: Cesium3DTilesWriter
        with:
          minZoom: 15
          maxZoom: 18
          attachTexture: true
          dracoCompression: false
          output: |
            file::join_path(env.get("workerArtifactPath"), "textured_roof_3dtiles")
          compressOutput: |
            file::join_path(env.get("workerArtifactPath"), "textured_roof_3dtiles.zip")

      # ========================================
      # Section 7: Reflection Computation
      # ========================================

      - id: 00000004-0000-0000-0000-000000000010
        name: ReflectionOutputFilter
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                let v = env.get("outputReflection");
                v == true || v == "true";
              outputPort: default

      - id: 00000001-0000-0000-0000-000000000013
        name: ComputeReflection
        type: action
        action: AttributeManager
        with:
          operations:
            # Reflection direction: R = I - 2(I·N)N where I is incident direction (opposite of solar)
            # I = -solarDirection, I·N = -cosTheta, so R = -solarDirection + 2*cosTheta*normal
            - attribute: reflectDirX
              method: create
              value: |
                -env.get("__value")["solarDirectionX"] + 2.0 * env.get("__value").cosTheta * env.get("__value")["normalX"]
            - attribute: reflectDirY
              method: create
              value: |
                -env.get("__value")["solarDirectionY"] + 2.0 * env.get("__value").cosTheta * env.get("__value")["normalY"]
            - attribute: reflectDirZ
              method: create
              value: |
                -env.get("__value")["solarDirectionZ"] + 2.0 * env.get("__value").cosTheta * env.get("__value")["normalZ"]

      - id: 00000001-0000-0000-0000-000000000014
        name: RayIntersectorReflect
        type: action
        action: RayIntersector
        with:
          # All rays are checked with all geometries
          pairId: |
            "all"
          closestIntersectionOnly: "true"
          includeRayOrigin: "false"
          tolerance: "0.01"
          geomId: |
            env.get("__value")["gmlId"] ?? ""
          ray:
            posX: rayOriginX
            posY: rayOriginY
            posZ: rayOriginZ
            dirX: reflectDirX
            dirY: reflectDirY
            dirZ: reflectDirZ

      # Extract intersection point coordinates (BoundsExtractor on a point)
      - id: 00000001-0000-0000-0000-00000000001b
        name: ReflectionBoundsExtractor
        type: action
        action: BoundsExtractor
        with:
          xmin: reflectHitX
          ymin: reflectHitY
          zmin: reflectHitZ
          xmax: _reflectXmax
          ymax: _reflectYmax
          zmax: _reflectZmax

      - id: 00000001-0000-0000-0000-000000000016
        name: ReflectionWriter
        type: action
        action: CsvWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("workerArtifactPath"), "反射シミュレーション結果.csv")

      # ========================================
      # Area Computation Branch (for CSV per-m2 values)
      # ========================================

      # Compute sloped area of each roof surface polygon
      - id: 00000001-0000-0000-0000-0000000000d0
        name: RoofAreaCalculator
        type: action
        action: AreaCalculator
        with:
          areaType: slopedArea
          outputAttribute: surfaceArea
          multiplier: 1.0

      # Aggregate area per surface (sum across split polygons within a surface)
      - id: 00000001-0000-0000-0000-0000000000d1
        name: SurfaceAreaAggregator
        type: action
        action: StatisticsCalculator
        with:
          groupBy:
            - surfaceId
            - gmlId
          calculations:
            - newAttribute: totalSurfaceArea
              expr: |
                env.get("__value")["surfaceArea"]

      # Aggregate area per building (sum across surfaces)
      - id: 00000001-0000-0000-0000-0000000000d2
        name: BuildingAreaAggregator
        type: action
        action: StatisticsCalculator
        with:
          groupBy:
            - gmlId
          calculations:
            - newAttribute: totalRoofArea
              expr: |
                env.get("__value")["totalSurfaceArea"]

      # Merge building area into building radiation results
      - id: 00000001-0000-0000-0000-0000000000d3
        name: BuildingAreaMerger
        type: action
        action: FeatureMerger
        with:
          requestorAttribute:
            - gmlId
          supplierAttribute:
            - gmlId

      # Merge surface area into surface radiation results
      - id: 00000001-0000-0000-0000-0000000000d4
        name: SurfaceAreaMerger
        type: action
        action: FeatureMerger
        with:
          requestorAttribute:
            - surfaceId
          supplierAttribute:
            - surfaceId

      # ========================================
      # CSV 1: Building Solar Potential
      # ========================================

      # Aggregate radiation per building (gmlId)
      - id: 00000001-0000-0000-0000-0000000000c0
        name: BuildingRadiationAggregator
        type: action
        action: StatisticsCalculator
        with:
          groupBy:
            - gmlId
          calculations:
            - newAttribute: totalSolarRadiation
              expr: |
                env.get("__value")["radiationPerMonth"]
            - newAttribute: totalSolarPower
              expr: |
                let dt = env.get("__value")["radiationPerMonth"] ?? 0.0;
                dt * env.get("photovoltaicConversionEfficiency") * env.get("lossConstant")

      # Map building attributes to Japanese column names
      - id: 00000001-0000-0000-0000-0000000000c5
        name: BuildingPotentialMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: 建物ID
              expr: env.get("__value")["gmlId"]
            - attribute: 太陽日射量(kWh)
              expr: env.get("__value")["totalSolarRadiation"]
            - attribute: 太陽日射量(kWh/m2)
              expr: |
                let area = env.get("__value")["totalRoofArea"] ?? 0.0;
                if area > 0.0 { env.get("__value")["totalSolarRadiation"] / area } else { 0.0 }
            - attribute: 太陽発電量(kWh)
              expr: env.get("__value")["totalSolarPower"]
            - attribute: 太陽発電量(kWh/m2)
              expr: |
                let area = env.get("__value")["totalRoofArea"] ?? 0.0;
                if area > 0.0 { env.get("__value")["totalSolarPower"] / area } else { 0.0 }
            - attribute: 受光面積(m2)
              expr: env.get("__value")["totalRoofArea"] ?? 0.0

      # Write building potential CSV
      - id: 00000001-0000-0000-0000-0000000000c1
        name: BuildingPotentialWriter
        type: action
        action: CsvWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("workerArtifactPath"), "建物ポテンシャル推計結果.csv")

      # ========================================
      # CSV 4: Per-Surface Radiation
      # ========================================

      # Map surface attributes to Japanese column names
      - id: 00000001-0000-0000-0000-0000000000c6
        name: SurfaceRadiationMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: 建物ID
              expr: env.get("__value")["gmlId"]
            - attribute: 屋根ID
              expr: env.get("__value")["surfaceId"]
            - attribute: 単位面積あたりの日射量(kWh/m2)
              expr: |
                let area = env.get("__value")["totalSurfaceArea"] ?? 0.0;
                if area > 0.0 { env.get("__value")["totalSolarRadiation"] / area } else { 0.0 }
            - attribute: 対象面全体の日射量(kWh)
              expr: env.get("__value")["totalSolarRadiation"]
            - attribute: 太陽発電量(kWh)
              expr: env.get("__value")["totalSolarPower"]
            - attribute: 受光面積(m2)
              expr: env.get("__value")["totalSurfaceArea"] ?? 0.0

      # Write surface radiation CSV
      - id: 00000001-0000-0000-0000-0000000000c2
        name: SurfaceRadiationWriter
        type: action
        action: CsvWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("workerArtifactPath"), "面別日射量.csv")

      # ========================================
      # CSV 5: Reflection — Map to Japanese column names
      # ========================================

      - id: 00000001-0000-0000-0000-0000000000c7
        name: ReflectionMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: 建物/土地ID
              expr: env.get("__value")["gmlId"] ?? ""
            - attribute: 屋根ID
              expr: env.get("__value")["surfaceId"] ?? ""
            - attribute: 日時
              expr: env.get("__value")["solarTime"] ?? ""
            - attribute: 反射元_座標.X(m)
              expr: env.get("__value")["rayOriginX"]
            - attribute: 反射元_座標.Y(m)
              expr: env.get("__value")["rayOriginY"]
            - attribute: 反射元_座標.Z(m)
              expr: env.get("__value")["rayOriginZ"]
            - attribute: 反射先_座標.X(m)
              expr: env.get("__value")["reflectHitX"]
            - attribute: 反射先_座標.Y(m)
              expr: env.get("__value")["reflectHitY"]
            - attribute: 反射先_座標.Z(m)
              expr: env.get("__value")["reflectHitZ"]
            - attribute: 反射先
              expr: env.get("__value")["geomId"] ?? ""

      # ========================================
      # CSV 6: Area Aggregation Results
      # ========================================

      # Aggregate all buildings into single-row summary
      - id: 00000001-0000-0000-0000-0000000000c3
        name: AreaAggregator
        type: action
        action: StatisticsCalculator
        with:
          groupBy: []
          calculations:
            - newAttribute: buildingCount
              expr: |
                1
            - newAttribute: areaTotalSolarRadiation
              expr: |
                env.get("__value")["totalSolarRadiation"]
            - newAttribute: areaTotalSolarPower
              expr: |
                env.get("__value")["totalSolarPower"]
            - newAttribute: areaTotalRoofArea
              expr: |
                env.get("__value")["totalRoofArea"]

      # Map aggregation attributes to Japanese column names
      - id: 00000001-0000-0000-0000-0000000000c8
        name: AreaAggregationMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: 対象範囲内建物数
              expr: env.get("__value")["buildingCount"]
            - attribute: 太陽放射量推計(kWh/m2)
              expr: |
                let area = env.get("__value")["areaTotalRoofArea"] ?? 0.0;
                if area > 0.0 { env.get("__value")["areaTotalSolarRadiation"] / area } else { 0.0 }
            - attribute: 太陽発電量推計(kWh)
              expr: env.get("__value")["areaTotalSolarPower"]

      # Write area aggregation CSV
      - id: 00000001-0000-0000-0000-0000000000c4
        name: AreaAggregationWriter
        type: action
        action: CsvWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("workerArtifactPath"), "集計結果.csv")

      # ========================================
      # Per-LOD 3D Tiles Output Pipelines (LOD1, LOD3, LOD4)
      # ========================================

      # --- LOD1 Pipeline ---
      - id: 00000001-0000-0000-0000-0000000000a0
        name: BoundsExtractorByLod1
        type: action
        action: BoundsExtractor
        with:
          xmin: _xmin
          ymin: _ymin
          xmax: _xmax
          ymax: _ymax
          zmin: _zmin
          zmax: _zmax

      - id: 00000001-0000-0000-0000-0000000000a1
        name: AttributeManagerXYByLod1
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: _x
              method: create
              value: |
                (env.get("__value")._xmin + env.get("__value")._xmax) * 0.5
            - attribute: _y
              method: create
              value: |
                (env.get("__value")._ymin + env.get("__value")._ymax) * 0.5

      - id: 00000001-0000-0000-0000-0000000000a2
        name: VerticalReprojectorByLod1
        type: action
        action: VerticalReprojector
        with:
          reprojectorType: jgd2011ToWgs84

      - id: 00000001-0000-0000-0000-0000000000a3
        name: Cesium3DTilesWriterByLod1
        type: action
        action: Cesium3DTilesWriter
        with:
          minZoom: 15
          maxZoom: 18
          attachTexture: false
          dracoCompression: false
          output: |
            file::join_path(env.get("workerArtifactPath"), "bldg_lod1")
          compressOutput: |
            file::join_path(env.get("workerArtifactPath"), "bldg_lod1.zip")

      # --- LOD3 Pipeline ---
      - id: 00000001-0000-0000-0000-0000000000a4
        name: BoundsExtractorByLod3
        type: action
        action: BoundsExtractor
        with:
          xmin: _xmin
          ymin: _ymin
          xmax: _xmax
          ymax: _ymax
          zmin: _zmin
          zmax: _zmax

      - id: 00000001-0000-0000-0000-0000000000a5
        name: AttributeManagerXYByLod3
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: _x
              method: create
              value: |
                (env.get("__value")._xmin + env.get("__value")._xmax) * 0.5
            - attribute: _y
              method: create
              value: |
                (env.get("__value")._ymin + env.get("__value")._ymax) * 0.5

      - id: 00000001-0000-0000-0000-0000000000a6
        name: VerticalReprojectorByLod3
        type: action
        action: VerticalReprojector
        with:
          reprojectorType: jgd2011ToWgs84

      - id: 00000001-0000-0000-0000-0000000000a7
        name: Cesium3DTilesWriterByLod3
        type: action
        action: Cesium3DTilesWriter
        with:
          minZoom: 15
          maxZoom: 18
          attachTexture: false
          dracoCompression: false
          output: |
            file::join_path(env.get("workerArtifactPath"), "bldg_lod3")
          compressOutput: |
            file::join_path(env.get("workerArtifactPath"), "bldg_lod3.zip")

      # --- LOD4 Pipeline ---
      - id: 00000001-0000-0000-0000-0000000000a8
        name: BoundsExtractorByLod4
        type: action
        action: BoundsExtractor
        with:
          xmin: _xmin
          ymin: _ymin
          xmax: _xmax
          ymax: _ymax
          zmin: _zmin
          zmax: _zmax

      - id: 00000001-0000-0000-0000-0000000000a9
        name: AttributeManagerXYByLod4
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: _x
              method: create
              value: |
                (env.get("__value")._xmin + env.get("__value")._xmax) * 0.5
            - attribute: _y
              method: create
              value: |
                (env.get("__value")._ymin + env.get("__value")._ymax) * 0.5

      - id: 00000001-0000-0000-0000-0000000000aa
        name: VerticalReprojectorByLod4
        type: action
        action: VerticalReprojector
        with:
          reprojectorType: jgd2011ToWgs84

      - id: 00000001-0000-0000-0000-0000000000ab
        name: Cesium3DTilesWriterByLod4
        type: action
        action: Cesium3DTilesWriter
        with:
          minZoom: 15
          maxZoom: 18
          attachTexture: false
          dracoCompression: false
          output: |
            file::join_path(env.get("workerArtifactPath"), "bldg_lod4")
          compressOutput: |
            file::join_path(env.get("workerArtifactPath"), "bldg_lod4.zip")

    edges:
      # Section 1: CityGML Loading Pipeline
      - id: e0000001-0000-0000-0000-000000000001
        from: 00000001-0000-0000-0000-000000000001
        to: 00000001-0000-0000-0000-000000000111
        fromPort: default
        toPort: default

      - id: e0000001-0000-0000-0000-000000000101
        from: 00000001-0000-0000-0000-000000000111
        to: 00000001-0000-0000-0000-000000000002
        fromPort: default
        toPort: default

      # CityGmlReader → LodFilter
      - id: e0000001-0000-0000-0000-000000000002
        from: 00000001-0000-0000-0000-000000000002
        to: 00000001-0000-0000-0000-00000000003a
        fromPort: default
        toPort: default

      # LodFilter → KeepFeatureType (AttributeMapper)
      - id: e0000001-0000-0000-0000-00000000003a
        from: 00000001-0000-0000-0000-00000000003a
        to: 00000001-0000-0000-0000-00000000003b
        fromPort: default
        toPort: default

      # KeepFeatureType → GeometryPartExtractor
      - id: e0000001-0000-0000-0000-00000000003b
        from: 00000001-0000-0000-0000-00000000003b
        to: 00000001-0000-0000-0000-000000000004
        fromPort: default
        toPort: default

      # GeometryPartExtractor → SurfaceIdCounter
      - id: e0000001-0000-0000-0000-000000000004
        from: 00000001-0000-0000-0000-000000000004
        to: 00000001-0000-0000-0000-000000000041
        fromPort: extracted
        toPort: default

      # SurfaceIdCounter → HorizontalReprojector
      - id: e0000001-0000-0000-0000-000000000041
        from: 00000001-0000-0000-0000-000000000041
        to: 00000001-0000-0000-0000-000000000005
        fromPort: default
        toPort: default

      # Optional Roof Restriction Polygon edges
      # ShapefileReader → RoofFilterReprojector
      - id: e0000004-0000-0000-0000-000000000001
        from: 00000004-0000-0000-0000-000000000001
        to: 00000004-0000-0000-0000-000000000002
        fromPort: default
        toPort: default

      # RoofFilterReprojector → RoofSpatialFilter (filter port)
      - id: e0000004-0000-0000-0000-000000000002
        from: 00000004-0000-0000-0000-000000000002
        to: 00000004-0000-0000-0000-000000000003
        fromPort: default
        toPort: filter

      # HorizontalReprojector → RoofSpatialFilter (candidate port)
      - id: e0000004-0000-0000-0000-000000000003
        from: 00000001-0000-0000-0000-000000000005
        to: 00000004-0000-0000-0000-000000000003
        fromPort: default
        toPort: candidate

      # RoofSpatialFilter (passed) → GeometrySplitter
      - id: e0000001-0000-0000-0000-000000000005
        from: 00000004-0000-0000-0000-000000000003
        to: 00000001-0000-0000-0000-000000000006
        fromPort: passed
        toPort: default

      # Section 2: Surface Analysis (GeometryCoercer removed, direct to PolygonNormalExtractor)
      - id: e0000001-0000-0000-0000-000000000006
        from: 00000001-0000-0000-0000-000000000006
        to: 00000001-0000-0000-0000-000000000008
        fromPort: default
        toPort: default

      # PolygonNormalExtractor → FilterRoofSurfaces (filter first, then divide)
      - id: e0000001-0000-0000-0000-000000000008
        from: 00000001-0000-0000-0000-000000000008
        to: 00000001-0000-0000-0000-00000000000a
        fromPort: default
        toPort: default

      # FilterRoofSurfaces → GridDivider
      - id: e0000001-0000-0000-0000-000000000009
        from: 00000001-0000-0000-0000-00000000000a
        to: 00000001-0000-0000-0000-000000000009
        fromPort: default
        toPort: default

      # Section 3: Solar Position Calculation
      # GridDivider → GridCellIdCounter
      - id: e0000001-0000-0000-0000-00000000000a
        from: 00000001-0000-0000-0000-000000000009
        to: 00000001-0000-0000-0000-000000000029
        fromPort: default
        toPort: default

      # GridCellIdCounter → AreaCalculator (area computed once per cell, before timestep expansion)
      - id: e0000001-0000-0000-0000-000000000029
        from: 00000001-0000-0000-0000-000000000029
        to: 00000001-0000-0000-0000-00000000000c
        fromPort: default
        toPort: default

      # AreaCalculator → SunPositionCalculator
      - id: e0000001-0000-0000-0000-000000000040
        from: 00000001-0000-0000-0000-00000000000c
        to: 00000001-0000-0000-0000-00000000000b
        fromPort: default
        toPort: default

      # SunPositionCalculator → ConvertDateTimeToIntegers
      - id: e0000001-0000-0000-0000-00000000000b
        from: 00000001-0000-0000-0000-00000000000b
        to: 00000001-0000-0000-0000-000000000040
        fromPort: default
        toPort: default

      # ConvertDateTimeToIntegers → GeometryRemover
      - id: e0000001-0000-0000-0000-00000000000c
        from: 00000001-0000-0000-0000-000000000040
        to: 00000001-0000-0000-0000-000000000031
        fromPort: default
        toPort: default

      # GeometryRemover → ComputeCosTheta
      - id: e0000001-0000-0000-0000-000000000030
        from: 00000001-0000-0000-0000-000000000031
        to: 00000001-0000-0000-0000-000000000011
        fromPort: default
        toPort: default

      # Section 4: Ray Setup
      # Branch: Building geometries to ray intersector (from SpatialFilter output)
      - id: e0000001-0000-0000-0000-00000000000f
        from: 00000004-0000-0000-0000-000000000003
        to: 00000001-0000-0000-0000-000000000010
        fromPort: passed
        toPort: geom

      # PreRayAttributeMapper → RayIntersectorShadow (ray)
      - id: e0000001-0000-0000-0000-000000000010
        from: 00000001-0000-0000-0000-000000000032
        to: 00000001-0000-0000-0000-000000000010
        fromPort: default
        toPort: ray




      # RayIntersector no_intersection → ComputeRadiation
      - id: e0000001-0000-0000-0000-000000000035
        from: 00000001-0000-0000-0000-000000000010
        to: 00000001-0000-0000-0000-00000000001d
        fromPort: no_intersection
        toPort: default

      # ComputeCosTheta → SnowFactorMerger (requestor)
      - id: e0000003-0000-0000-0000-000000000004
        from: 00000001-0000-0000-0000-000000000011
        to: 00000003-0000-0000-0000-000000000004
        fromPort: default
        toPort: requestor

      # SnowFactorMerger (merged) → PreRayAttributeMapper
      - id: e0000001-0000-0000-0000-00000000001c
        from: 00000003-0000-0000-0000-000000000004
        to: 00000001-0000-0000-0000-000000000032
        fromPort: merged
        toPort: default

      # Section 6b: Monthly Radiation with Cloud Factor edges
      # ComputeRadiation → MonthlyDTAggregator
      - id: e0000001-0000-0000-0000-000000000050
        from: 00000001-0000-0000-0000-00000000001d
        to: 00000001-0000-0000-0000-000000000051
        fromPort: default
        toPort: default

      # MonthlyDTAggregator (aggregated results) → CloudFactorDTMerger (requestor)
      - id: e0000001-0000-0000-0000-000000000051
        from: 00000001-0000-0000-0000-000000000051
        to: 00000001-0000-0000-0000-000000000052
        fromPort: default
        toPort: requestor

      # CloudFactorCalculator → CloudFactorDTMerger (supplier)
      - id: e0000001-0000-0000-0000-000000000052
        from: 00000001-0000-0000-0000-000000000050
        to: 00000001-0000-0000-0000-000000000052
        fromPort: default
        toPort: supplier

      # CloudFactorDTMerger (merged) → CalcradiationPerMonth
      - id: e0000001-0000-0000-0000-000000000053
        from: 00000001-0000-0000-0000-000000000052
        to: 00000001-0000-0000-0000-000000000053
        fromPort: merged
        toPort: default

      # Snow Factor Sub-flow edges
      # SnowCSVReader → SnowFeatureFilter
      - id: e0000003-0000-0000-0000-000000000001
        from: 00000003-0000-0000-0000-000000000001
        to: 00000003-0000-0000-0000-000000000002
        fromPort: default
        toPort: default

      # SnowFeatureFilter → SnowAttributeMapper
      - id: e0000003-0000-0000-0000-000000000002
        from: 00000003-0000-0000-0000-000000000002
        to: 00000003-0000-0000-0000-000000000003
        fromPort: default
        toPort: default

      # SnowAttributeMapper → SnowFactorMerger (supplier)
      - id: e0000003-0000-0000-0000-000000000003
        from: 00000003-0000-0000-0000-000000000003
        to: 00000003-0000-0000-0000-000000000004
        fromPort: default
        toPort: supplier

      # Section 7: Reflection Computation (conditional on outputReflection)
      # RayIntersector no_intersection → ReflectionOutputFilter
      - id: e0000001-0000-0000-0000-000000000013
        from: 00000001-0000-0000-0000-000000000010
        to: 00000004-0000-0000-0000-000000000010
        fromPort: no_intersection
        toPort: default

      # ReflectionOutputFilter → ComputeReflection (only when outputReflection=true)
      - id: e0000004-0000-0000-0000-000000000011
        from: 00000004-0000-0000-0000-000000000010
        to: 00000001-0000-0000-0000-000000000013
        fromPort: default
        toPort: default

      # Building geometries to reflection ray intersector
      - id: e0000001-0000-0000-0000-000000000014
        from: 00000004-0000-0000-0000-000000000003
        to: 00000001-0000-0000-0000-000000000014
        fromPort: passed
        toPort: geom

      # Reflection rays to ray intersector
      - id: e0000001-0000-0000-0000-000000000015
        from: 00000001-0000-0000-0000-000000000013
        to: 00000001-0000-0000-0000-000000000014
        fromPort: default
        toPort: ray

      # Reflection intersection results → ReflectionBoundsExtractor
      - id: e0000001-0000-0000-0000-000000000016
        from: 00000001-0000-0000-0000-000000000014
        to: 00000001-0000-0000-0000-00000000001b
        fromPort: intersection
        toPort: default

      # ReflectionBoundsExtractor → ReflectionMapper
      - id: e0000001-0000-0000-0000-00000000001b
        from: 00000001-0000-0000-0000-00000000001b
        to: 00000001-0000-0000-0000-0000000000c7
        fromPort: default
        toPort: default

      # ReflectionMapper → ReflectionWriter
      - id: e0000001-0000-0000-0000-0000000000c7
        from: 00000001-0000-0000-0000-0000000000c7
        to: 00000001-0000-0000-0000-000000000016
        fromPort: default
        toPort: default

      # ========================================
      # Section 6c: Total Radiation & 3D Tiles Output edges
      # ========================================

      # CalcradiationPerMonth → TotalRadiationAggregator (per-cell aggregation for coloring)
      - id: e0000001-0000-0000-0000-000000000071
        from: 00000001-0000-0000-0000-000000000053
        to: 00000001-0000-0000-0000-000000000071
        fromPort: default
        toPort: default

      # TotalRadiationAggregator → NormalizeRadiation
      - id: e0000001-0000-0000-0000-000000000072
        from: 00000001-0000-0000-0000-000000000071
        to: 00000001-0000-0000-0000-000000000070
        fromPort: default
        toPort: default

      # CalcradiationPerMonth → SurfaceRadiationAggregator (per-surface aggregation for 3DTiles attrs)
      - id: e0000001-0000-0000-0000-000000000073
        from: 00000001-0000-0000-0000-000000000053
        to: 00000001-0000-0000-0000-000000000074
        fromPort: default
        toPort: default

      # SurfaceRadiationAggregator → SolarAttributeMerger (supplier)
      - id: e0000001-0000-0000-0000-000000000074
        from: 00000001-0000-0000-0000-000000000074
        to: 00000001-0000-0000-0000-000000000075
        fromPort: default
        toPort: supplier

      # FilterRoofForTexture → SolarAttributeMerger (requestor - roof features with surfaceId)
      - id: e0000001-0000-0000-0000-000000000075
        from: 00000001-0000-0000-0000-00000000006a
        to: 00000001-0000-0000-0000-000000000075
        fromPort: default
        toPort: requestor

      # SolarAttributeMerger (merged) → AddSolarSchemaAttributes
      - id: e0000001-0000-0000-0000-000000000076
        from: 00000001-0000-0000-0000-000000000075
        to: 00000001-0000-0000-0000-000000000073
        fromPort: merged
        toPort: default

      # AddSolarSchemaAttributes → ImageRasterizer (textureCoordinates port)
      - id: e0000001-0000-0000-0000-000000000077
        from: 00000001-0000-0000-0000-000000000073
        to: 00000001-0000-0000-0000-000000000061
        fromPort: default
        toPort: textureCoordinates

      # ========================================
      # Section 6d: Textured 3D Tiles Output edges
      # ========================================

      # NormalizeRadiation → RadiationToColorMapper
      - id: e0000001-0000-0000-0000-000000000070
        from: 00000001-0000-0000-0000-000000000070
        to: 00000001-0000-0000-0000-000000000060
        fromPort: default
        toPort: default

      # GridCellIdCounter → CellGeometryMerger (requestor - original cell polygons with geometry and stable cellId)
      - id: e0000001-0000-0000-0000-000000000068
        from: 00000001-0000-0000-0000-000000000029
        to: 00000001-0000-0000-0000-000000000068
        fromPort: default
        toPort: requestor

      # RadiationToColorMapper → CellGeometryMerger (supplier - colors by cellId)
      - id: e0000001-0000-0000-0000-000000000069
        from: 00000001-0000-0000-0000-000000000060
        to: 00000001-0000-0000-0000-000000000068
        fromPort: default
        toPort: supplier

      # CellGeometryMerger → CellBoundsExtractor (merged polygons with colors)
      - id: e0000001-0000-0000-0000-000000000060
        from: 00000001-0000-0000-0000-000000000068
        to: 00000001-0000-0000-0000-000000000069
        fromPort: merged
        toPort: default

      # CellBoundsExtractor → CellTwoDimensionForcer
      - id: e0000001-0000-0000-0000-00000000006c
        from: 00000001-0000-0000-0000-000000000069
        to: 00000001-0000-0000-0000-00000000005f
        fromPort: default
        toPort: default

      # CellTwoDimensionForcer → ImageRasterizer (2D polygons with colors)
      - id: e0000001-0000-0000-0000-000000000061
        from: 00000001-0000-0000-0000-00000000005f
        to: 00000001-0000-0000-0000-000000000061
        fromPort: default
        toPort: default

      # RoofSpatialFilter → FilterRoofForTexture (filter only roof surfaces)
      - id: e0000001-0000-0000-0000-000000000062
        from: 00000004-0000-0000-0000-000000000003
        to: 00000001-0000-0000-0000-00000000006a
        fromPort: passed
        toPort: default

      # FilterRoofForTexture (unfiltered) → TexturedHorizontalReprojector (non-roof geometry passes through without texture)
      - id: e0000001-0000-0000-0000-00000000006b
        from: 00000001-0000-0000-0000-00000000006a
        to: 00000001-0000-0000-0000-000000000062
        fromPort: unfiltered
        toPort: default

      # ImageRasterizer → TexturedHorizontalReprojector (textured features with UV coordinates)
      - id: e0000001-0000-0000-0000-000000000063
        from: 00000001-0000-0000-0000-000000000061
        to: 00000001-0000-0000-0000-000000000062
        fromPort: textured
        toPort: default

      # TexturedHorizontalReprojector → TexturedBoundsExtractor
      - id: e0000001-0000-0000-0000-000000000064
        from: 00000001-0000-0000-0000-000000000062
        to: 00000001-0000-0000-0000-000000000063
        fromPort: default
        toPort: default

      # TexturedBoundsExtractor → TexturedCenterCoords
      - id: e0000001-0000-0000-0000-000000000065
        from: 00000001-0000-0000-0000-000000000063
        to: 00000001-0000-0000-0000-000000000064
        fromPort: default
        toPort: default

      # TexturedCenterCoords → TexturedVerticalReprojector
      - id: e0000001-0000-0000-0000-000000000066
        from: 00000001-0000-0000-0000-000000000064
        to: 00000001-0000-0000-0000-000000000065
        fromPort: default
        toPort: default

      # TexturedVerticalReprojector → Textured3DTilesWriter
      - id: e0000001-0000-0000-0000-000000000067
        from: 00000001-0000-0000-0000-000000000065
        to: 00000001-0000-0000-0000-000000000066
        fromPort: default
        toPort: default

      # ========================================
      # CSV 1: Building Solar Potential edges
      # ========================================

      # CalcradiationPerMonth → BuildingRadiationAggregator
      - id: e0000001-0000-0000-0000-0000000000c0
        from: 00000001-0000-0000-0000-000000000053
        to: 00000001-0000-0000-0000-0000000000c0
        fromPort: default
        toPort: default

      # BuildingRadiationAggregator → BuildingAreaMerger (requestor)
      - id: e0000001-0000-0000-0000-0000000000c1
        from: 00000001-0000-0000-0000-0000000000c0
        to: 00000001-0000-0000-0000-0000000000d3
        fromPort: default
        toPort: requestor

      # BuildingPotentialMapper → BuildingPotentialWriter
      - id: e0000001-0000-0000-0000-0000000000c5
        from: 00000001-0000-0000-0000-0000000000c5
        to: 00000001-0000-0000-0000-0000000000c1
        fromPort: default
        toPort: default

      # ========================================
      # CSV 4: Per-Surface Radiation edges
      # ========================================

      # SurfaceRadiationAggregator → SurfaceAreaMerger (requestor)
      - id: e0000001-0000-0000-0000-0000000000c2
        from: 00000001-0000-0000-0000-000000000074
        to: 00000001-0000-0000-0000-0000000000d4
        fromPort: default
        toPort: requestor

      # SurfaceRadiationMapper → SurfaceRadiationWriter
      - id: e0000001-0000-0000-0000-0000000000c6
        from: 00000001-0000-0000-0000-0000000000c6
        to: 00000001-0000-0000-0000-0000000000c2
        fromPort: default
        toPort: default

      # ========================================
      # CSV 6: Area Aggregation edges
      # ========================================

      # BuildingAreaMerger → AreaAggregator
      - id: e0000001-0000-0000-0000-0000000000c3
        from: 00000001-0000-0000-0000-0000000000d3
        to: 00000001-0000-0000-0000-0000000000c3
        fromPort: merged
        toPort: default

      # AreaAggregator → AreaAggregationMapper
      - id: e0000001-0000-0000-0000-0000000000c4
        from: 00000001-0000-0000-0000-0000000000c3
        to: 00000001-0000-0000-0000-0000000000c8
        fromPort: default
        toPort: default

      # AreaAggregationMapper → AreaAggregationWriter
      - id: e0000001-0000-0000-0000-0000000000c8
        from: 00000001-0000-0000-0000-0000000000c8
        to: 00000001-0000-0000-0000-0000000000c4
        fromPort: default
        toPort: default

      # ========================================
      # Area Computation Branch edges
      # ========================================

      # FilterRoofSurfaces → RoofAreaCalculator
      - id: e0000001-0000-0000-0000-0000000000d0
        from: 00000001-0000-0000-0000-00000000000a
        to: 00000001-0000-0000-0000-0000000000d0
        fromPort: default
        toPort: default

      # RoofAreaCalculator → SurfaceAreaAggregator
      - id: e0000001-0000-0000-0000-0000000000d1
        from: 00000001-0000-0000-0000-0000000000d0
        to: 00000001-0000-0000-0000-0000000000d1
        fromPort: default
        toPort: default

      # SurfaceAreaAggregator → BuildingAreaAggregator
      - id: e0000001-0000-0000-0000-0000000000d2
        from: 00000001-0000-0000-0000-0000000000d1
        to: 00000001-0000-0000-0000-0000000000d2
        fromPort: default
        toPort: default

      # BuildingAreaAggregator → BuildingAreaMerger (supplier)
      - id: e0000001-0000-0000-0000-0000000000d3
        from: 00000001-0000-0000-0000-0000000000d2
        to: 00000001-0000-0000-0000-0000000000d3
        fromPort: default
        toPort: supplier

      # BuildingAreaMerger → BuildingPotentialMapper
      - id: e0000001-0000-0000-0000-0000000000d4
        from: 00000001-0000-0000-0000-0000000000d3
        to: 00000001-0000-0000-0000-0000000000c5
        fromPort: merged
        toPort: default

      # SurfaceAreaAggregator → SurfaceAreaMerger (supplier)
      - id: e0000001-0000-0000-0000-0000000000d5
        from: 00000001-0000-0000-0000-0000000000d1
        to: 00000001-0000-0000-0000-0000000000d4
        fromPort: default
        toPort: supplier

      # SurfaceAreaMerger → SurfaceRadiationMapper
      - id: e0000001-0000-0000-0000-0000000000d6
        from: 00000001-0000-0000-0000-0000000000d4
        to: 00000001-0000-0000-0000-0000000000c6
        fromPort: merged
        toPort: default

      # ========================================
      # Per-LOD 3D Tiles Pipeline Edges
      # ========================================

      # --- LOD1 Pipeline ---
      # LodFilter (lod1) → BoundsExtractorByLod1
      - id: e0000001-0000-0000-0000-0000000000a0
        from: 00000001-0000-0000-0000-00000000003a
        to: 00000001-0000-0000-0000-0000000000a0
        fromPort: lod1
        toPort: default

      # BoundsExtractorByLod1 → AttributeManagerXYByLod1
      - id: e0000001-0000-0000-0000-0000000000a1
        from: 00000001-0000-0000-0000-0000000000a0
        to: 00000001-0000-0000-0000-0000000000a1
        fromPort: default
        toPort: default

      # AttributeManagerXYByLod1 → VerticalReprojectorByLod1
      - id: e0000001-0000-0000-0000-0000000000a2
        from: 00000001-0000-0000-0000-0000000000a1
        to: 00000001-0000-0000-0000-0000000000a2
        fromPort: default
        toPort: default

      # VerticalReprojectorByLod1 → Cesium3DTilesWriterByLod1
      - id: e0000001-0000-0000-0000-0000000000a3
        from: 00000001-0000-0000-0000-0000000000a2
        to: 00000001-0000-0000-0000-0000000000a3
        fromPort: default
        toPort: default

      # --- LOD3 Pipeline ---
      # LodFilter (lod3) → BoundsExtractorByLod3
      - id: e0000001-0000-0000-0000-0000000000a4
        from: 00000001-0000-0000-0000-00000000003a
        to: 00000001-0000-0000-0000-0000000000a4
        fromPort: lod3
        toPort: default

      # BoundsExtractorByLod3 → AttributeManagerXYByLod3
      - id: e0000001-0000-0000-0000-0000000000a5
        from: 00000001-0000-0000-0000-0000000000a4
        to: 00000001-0000-0000-0000-0000000000a5
        fromPort: default
        toPort: default

      # AttributeManagerXYByLod3 → VerticalReprojectorByLod3
      - id: e0000001-0000-0000-0000-0000000000a6
        from: 00000001-0000-0000-0000-0000000000a5
        to: 00000001-0000-0000-0000-0000000000a6
        fromPort: default
        toPort: default

      # VerticalReprojectorByLod3 → Cesium3DTilesWriterByLod3
      - id: e0000001-0000-0000-0000-0000000000a7
        from: 00000001-0000-0000-0000-0000000000a6
        to: 00000001-0000-0000-0000-0000000000a7
        fromPort: default
        toPort: default

      # --- LOD4 Pipeline ---
      # LodFilter (lod4) → BoundsExtractorByLod4
      - id: e0000001-0000-0000-0000-0000000000a8
        from: 00000001-0000-0000-0000-00000000003a
        to: 00000001-0000-0000-0000-0000000000a8
        fromPort: lod4
        toPort: default

      # BoundsExtractorByLod4 → AttributeManagerXYByLod4
      - id: e0000001-0000-0000-0000-0000000000a9
        from: 00000001-0000-0000-0000-0000000000a8
        to: 00000001-0000-0000-0000-0000000000a9
        fromPort: default
        toPort: default

      # AttributeManagerXYByLod4 → VerticalReprojectorByLod4
      - id: e0000001-0000-0000-0000-0000000000aa
        from: 00000001-0000-0000-0000-0000000000a9
        to: 00000001-0000-0000-0000-0000000000aa
        fromPort: default
        toPort: default

      # VerticalReprojectorByLod4 → Cesium3DTilesWriterByLod4
      - id: e0000001-0000-0000-0000-0000000000ab
        from: 00000001-0000-0000-0000-0000000000aa
        to: 00000001-0000-0000-0000-0000000000ab
        fromPort: default
        toPort: default

      # ========================================
      # DEM Import Pipeline Edges
      # ========================================

      # DEMFeatureCreator → DEMDirectoryDecompressor
      - id: e0000002-0000-0000-0000-000000000001
        from: 00000002-0000-0000-0000-000000000001
        to: 00000002-0000-0000-0000-000000000002
        fromPort: default
        toPort: default

      # DEMDirectoryDecompressor → DEMFeatureFilePathExtractor
      - id: e0000002-0000-0000-0000-000000000002
        from: 00000002-0000-0000-0000-000000000002
        to: 00000002-0000-0000-0000-000000000003
        fromPort: default
        toPort: default

      # DEMFeatureFilePathExtractor → DEMFeatureFilterByGml
      - id: e0000002-0000-0000-0000-000000000003
        from: 00000002-0000-0000-0000-000000000003
        to: 00000002-0000-0000-0000-000000000004
        fromPort: default
        toPort: default

      # DEMFeatureFilterByGml → DEMPLATEAU4UDXFolderExtractor
      - id: e0000002-0000-0000-0000-000000000004
        from: 00000002-0000-0000-0000-000000000004
        to: 00000002-0000-0000-0000-000000000005
        fromPort: default
        toPort: default

      # DEMPLATEAU4UDXFolderExtractor → DEMPLATEAU4CityGmlMeshBuilder
      - id: e0000002-0000-0000-0000-000000000005
        from: 00000002-0000-0000-0000-000000000005
        to: 00000002-0000-0000-0000-000000000006
        fromPort: default
        toPort: default

      # DEMPLATEAU4CityGmlMeshBuilder → RayIntersectorShadow (DEM mesh to shadow detection)
      - id: e0000002-0000-0000-0000-000000000006
        from: 00000002-0000-0000-0000-000000000006
        to: 00000001-0000-0000-0000-000000000010
        fromPort: default
        toPort: geom

      # DEMPLATEAU4CityGmlMeshBuilder → RayIntersectorReflect (DEM mesh to reflection detection)
      - id: e0000002-0000-0000-0000-000000000007
        from: 00000002-0000-0000-0000-000000000006
        to: 00000001-0000-0000-0000-000000000014
        fromPort: default
        toPort: geom
