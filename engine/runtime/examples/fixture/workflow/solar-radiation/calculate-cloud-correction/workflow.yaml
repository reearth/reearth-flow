# workflow for calculate cloud correction for solar energy
id: 2d4e1c6a-eb70-11f0-9b6c-7c70db10a7e3
name: CalculateCloudCorrectionFactor
entryGraphId: a2df1dee-eba2-11f0-b126-7c70db10a7e3
with:
  csvFile: |
    年,月,日照時間(時間),日照時間(時間)00,日照時間0.1時間未満日数(日),日照時間0.1時間未満日数(日)00,日照率40%以上日数(日),日照率40%以上日数(日)00
    2010,1,71.0,8,"","","","",""
    2010,2,83.6,8,"","","","",""
    2010,3,83.2,5,"","","","",""
    2010,4,140.9,8,"","","","",""
    2010,5,173.3,8,"","","","",""
    2010,6,190.9,8,"","","","",""
    2010,7,209.4,8,"","","","",""
    2010,8,263.3,8,"","","","",""
    2010,9,149.0,8,"","","","",""
    2010,10,132.6,8,"","","","",""
    2010,11,113.5,8,"","","","",""
    2010,12,73.1,8,"","","","",""
    2011,1,44.3,8,"","","","",""
    2011,2,127.2,8,"","","","",""
    2011,3,134.5,8,"","","","",""
    2011,4,177.7,8,"","","","",""
    2011,5,176.6,8,"","","","",""
    2011,6,141.5,8,"","","","",""
    2011,7,186.7,8,"","","","",""
    2011,8,194.3,8,"","","","",""
    2011,9,177.9,8,"","","","",""
    2011,10,169.3,8,"","","","",""
    2011,11,116.0,8,"","","","",""
    2011,12,47.2,8,"","","","",""
    2012,1,76.5,8,"","","","",""
    2012,2,80.0,8,"","","","",""
    2012,3,114.1,8,"","","","",""
    2012,4,172.9,8,"","","","",""
    2012,5,193.8,8,"","","","",""
    2012,6,177.5,8,"","","","",""
    2012,7,193.9,8,"","","","",""
    2012,8,289.5,8,"","","","",""
    2012,9,191.7,8,"","","","",""
    2012,10,184.2,8,"","","","",""
    2012,11,66.5,8,"","","","",""
    2012,12,61.5,8,"","","","",""
    2013,1,67.3,8,"","","","",""
    2013,2,80.1,8,"","","","",""
    2013,3,160.3,8,"","","","",""
    2013,4,162.9,8,"","","","",""
    2013,5,255.0,8,"","","","",""
    2013,6,186.3,8,"","","","",""
    2013,7,178.5,8,"","","","",""
    2013,8,236.1,8,"","","","",""
    2013,9,186.9,8,"","","","",""
    2013,10,131.2,8,"","","","",""
    2013,11,116.1,8,"","","","",""
    2013,12,48.5,8,"","","","",""
    2014,1,96.4,8,"","","","",""
    2014,2,88.4,8,"","","","",""
    2014,3,142.0,8,"","","","",""
    2014,4,228.3,8,"","","","",""
    2014,5,244.7,8,"","","","",""
    2014,6,199.2,8,"","","","",""
    2014,7,193.3,8,"","","","",""
    2014,8,116.7,8,"","","","",""
    2014,9,206.3,8,"","","","",""
    2014,10,176.8,5,"","","","",""
    2014,11,118.4,8,"","","","",""
    2014,12,37.7,8,"","","","",""
    2015,1,46.7,8,"","","","",""
    2015,2,73.7,8,"","","","",""
    2015,3,150.4,8,"","","","",""
    2015,4,172.9,8,"","","","",""
    2015,5,265.0,8,"","","","",""
    2015,6,171.8,8,"","","","",""
    2015,7,176.2,8,"","","","",""
    2015,8,204.5,8,"","","","",""
    2015,9,136.8,8,"","","","",""
    2015,10,198.5,8,"","","","",""
    2015,11,99.0,8,"","","","",""
    2015,12,76.7,8,"","","","",""
    2016,1,59.5,8,"","","","",""
    2016,2,107.4,8,"","","","",""
    2016,3,157.4,8,"","","","",""
    2016,4,170.2,8,"","","","",""
    2016,5,218.1,8,"","","","",""
    2016,6,152.9,8,"","","","",""
    2016,7,171.4,8,"","","","",""
    2016,8,224.6,8,"","","","",""
    2016,9,94.4,8,"","","","",""
    2016,10,139.8,8,"","","","",""
    2016,11,117.5,8,"","","","",""
    2016,12,79.4,8,"","","","",""
    2017,1,79.2,8,"","","","",""
    2017,2,85.2,8,"","","","",""
    2017,3,164.2,8,"","","","",""
    2017,4,195.2,8,"","","","",""
    2017,5,234.8,8,"","","","",""
    2017,6,209.1,8,"","","","",""
    2017,7,195.6,8,"","","","",""
    2017,8,185.3,8,"","","","",""
    2017,9,179.9,8,"","","","",""
    2017,10,107.6,5,"","","","",""
    2017,11,127.8,8,"","","","",""
    2017,12,61.6,8,"","","","",""
    2018,1,51.7,8,"","","","",""
    2018,2,100.7,8,"","","","",""
    2018,3,152.1,5,"","","","",""
    2018,4,183.0,8,"","","","",""
    2018,5,172.8,8,"","","","",""
    2018,6,182.4,8,"","","","",""
    2018,7,278.2,8,"","","","",""
    2018,8,221.2,8,"","","","",""
    2018,9,113.7,8,"","","","",""
    2018,10,156.6,8,"","","","",""
    2018,11,153.5,8,"","","","",""
    2018,12,49.1,5,"","","","",""
    2019,1,64.7,5,"","","","",""
    2019,2,93.4,8,"","","","",""
    2019,3,122.8,5,"","","","",""
    2019,4,161.3,5,"","","","",""
    2019,5,303.0,8,"","","","",""
    2019,6,176.6,8,"","","","",""
    2019,7,145.0,8,"","","","",""
    2019,8,220.6,8,"","","","",""
    2019,9,185.5,8,"","","","",""
    2019,10,119.9,8,"","","","",""
    2019,11,156.2,8,"","","","",""
    2019,12,95.2,8,"","","","",""
    2020,1,65.4,8,"","","","",""
    2020,2,90.8,8,"","","","",""
    2020,3,155.1,8,"","","","",""
    2020,4,187.9,8,"","","","",""
    2020,5,182.3,8,"","","","",""
    2020,6,194.1,8,"","","","",""
    2020,7,72.3,8,"","","","",""
    2020,8,241.7,8,"","","","",""
    2020,9,162.7,5,"","","","",""
    2020,10,154.0,8,"","","","",""
    2020,11,135.5,8,"","","","",""
    2020,12,54.9,5,"","","","",""
    2021,1,66.7,8,"","","","",""
    2021,2,111.4,8,"","","","",""
    2021,3,175.4,5,"","","","",""
    2021,4,238.9,8,"","","","",""
    2021,5,160.5,8,"","","","",""
    2021,6,180.5,8,"","","","",""
    2021,7,207.9,8,"","","","",""
    2021,8,164.0,8,"","","","",""
    2021,9,164.8,8,"","","","",""
    2021,10,192.6,8,"","","","",""
    2021,11,146.2,8,"","","","",""
    2021,12,63.8,8,"","","","",""
    2022,1,76.0,8,"","","","",""
    2022,2,86.3,8,"","","","",""
    2022,3,148.4,8,"","","","",""
    2022,4,211.8,8,"","","","",""
    2022,5,237.5,8,"","","","",""
    2022,6,225.3,8,"","","","",""
    2022,7,192.0,8,"","","","",""
    2022,8,179.9,8,"","","","",""
    2022,9,156.0,8,"","","","",""
    2022,10,162.1,8,"","","","",""
    2022,11,158.4,8,"","","","",""
    2022,12,52.9,8,"","","","",""
    2023,1,81.6,8,"","","","",""
    2023,2,95.8,8,"","","","",""
    2023,3,206.4,8,"","","","",""
    2023,4,193.5,8,"","","","",""
    2023,5,223.3,8,"","","","",""
    2023,6,162.9,8,"","","","",""
    2023,7,233.9,8,"","","","",""
    2023,8,261.3,8,"","","","",""
    2023,9,158.7,8,"","","","",""
    2023,10,174.5,8,"","","","",""
    2023,11,121.8,8,"","","","",""
    2023,12,77.8,8,"","","","",""
graphs:
  - id: a2df1dee-eba2-11f0-b126-7c70db10a7e3
    name: CloudFactorWorkflow
    nodes:
      - id: c4ea198e-eba2-11f0-b93c-7c70db10a7e3
        name: CsvReader
        type: action
        action: CsvReader
        with:
          format: csv
          inline: |
            env.get("csvFile")

      - id: 9444dbf6-eba3-11f0-bdcb-7c70db10a7e3
        name: RenameAttributes
        type: action
        action: AttributeManager
        with:
          operations:
          - attribute: year
            method: create
            value:
              env.get("__value")["年"];
          - attribute: 年
            method: remove

          - attribute: month
            method: create
            value:
              env.get("__value")["月"];
          - attribute: 月
            method: remove

          - attribute: daylight_hours
            method: create
            value:
              env.get("__value")["日照時間(時間)"];
          - attribute: 日照時間(時間)
            method: remove

          - attribute: daylight_hours_num
            method: create
            value:
              env.get("__value")["日照時間(時間)00"];
          - attribute: 日照時間(時間)00
            method: remove

          - attribute: days_less_then_1h_daylight
            method: create
            value:
              env.get("__value")["日照時間0.1時間未満日数(日)"];
          - attribute: 日照時間0.1時間未満日数(日)
            method: remove

          - attribute: days_less_then_1h_daylight_num
            method: create
            value:
              env.get("__value")["日照時間0.1時間未満日数(日)00"];
          - attribute: 日照時間0.1時間未満日数(日)00
            method: remove

          - attribute: days_over_40%_daylight_late
            method: create
            value:
              env.get("__value")["日照率40%以上日数(日)"];
          - attribute: 日照率40%以上日数(日)
            method: remove

          - attribute: days_over_40%_daylight_late_num
            method: create
            value:
              env.get("__value")["日照率40%以上日数(日)00"];
          - attribute: 日照率40%以上日数(日)00
            method: remove



      - id: fe5bafa8-ef7f-11f0-90ad-6c02e0440ed6
        name: PrepareExtraAttribute
        type: action
        action: AttributeManager
        with:
          operations:
          - attribute: max_daylight_hours
            method: create
            value: |
              let month = env.get("__value")["month"];
              if month == "1" {
                310
              } else if month == "2" {
                308
              } else if month == "3" {
                372
              } else if month == "4" {
                390
              } else if month == "5" {
                434
              } else if month == "6" {
                450
              } else if month == "7" {
                465
              } else if month == "8" {
                434
              } else if month == "9" {
                390
              } else if month == "10" {
                372
              } else if month == "11" {
                330
              } else if month == "12" {
                310
              } else {
                372
              }

          - attribute: transmissivity
            method: create
            value: |
              let month = env.get("__value")["month"];
              if month == "1" {
                0.75
              } else if month == "2" {
                0.72
              } else if month == "3" {
                0.67
              } else if month == "4" {
                0.64
              } else if month == "5" {
                0.64
              } else if month == "6" {
                0.62
              } else if month == "7" {
                0.63
              } else if month == "8" {
                0.64
              } else if month == "9" {
                0.68
              } else if month == "10" {
                0.71
              } else if month == "11" {
                0.74
              } else if month == "12" {
                0.75
              } else {
                0.7
              }


      # Calculate averages grouped by month and add year attribute
      - id: b26d26ee-ec37-11f0-8e87-7c70db10a7e3
        name: AggregateByMonth
        type: action
        action: AttributeAggregator
        with:
          # Define the grouping attributes (what to group by)
          aggregateAttributes:
            - newAttribute: month
              attribute: month

          # Define multiple calculations to perform on the same grouping
          calculations:
            # Calculate averages directly instead of sums then division
            - calculation: |
                let v = env.get("__value")["daylight_hours"];
                parse_float(v)
              calculationAttribute: daylight_hours
              method: avg

            - calculation: |
                let v = env.get("__value")["daylight_hours_num"];
                parse_float(v)
              calculationAttribute: daylight_hours_num
              method: avg

            - calculation: |
                env.get("__value")["max_daylight_hours"]
              calculationAttribute: max_daylight_hours
              method: avg

            - calculation: |
                env.get("__value")["transmissivity"]
              calculationAttribute: transmissivity
              method: avg

            # Add the year attribute with value 9999
            - calculation: |
                9999
              calculationAttribute: year
              method: max  # Any method works for a constant value

      - id: 4624d686-ec5e-11f0-a279-7c70db10a7e3
        name: TestFilter_2
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["period"] == "period_year"
              outputPort: yearPort
            - expr: |
                env.get("__value")["period"] == "period_month"
              outputPort: monthPort
            - expr: |
                env.get("__value")["period"] == "period_day"
              outputPort: datePort
            - expr: |
                env.get("__value")["year"] == 9999
              outputPort: year9999Port

      # Aggregator for year, month, date features (using new AttributeAggregator to calculate averages)
      - id: 4624d686-ec5e-11f0-a279-7c70db10a7e4
        name: Aggregator_2
        type: action
        action: AttributeAggregator
        with:
          # Define the grouping attributes (what to group by)
          aggregateAttributes:
            - newAttribute: year
              attribute: year

          # Define multiple calculations to perform on the same grouping
          calculations:
            # Calculate averages directly
            - calculation: |
                let v = env.get("__value")["daylight_hours"];
                parse_float(v)
              calculationAttribute: daylight_hours
              method: avg

            - calculation: |
                let v = env.get("__value")["daylight_hours_num"];
                parse_float(v)
              calculationAttribute: daylight_hours_num
              method: avg

            - calculation: |
                let v = env.get("__value")["transmissivity"];
                parse_float(v)
              calculationAttribute: transmissivity
              method: avg

      # Aggregator for 9999-year features (using new AttributeAggregator to calculate averages)
      - id: 4624d686-ec5e-11f0-a279-7c70db10a7e5
        name: Aggregator_4
        type: action
        action: AttributeAggregator
        with:
          # Define the grouping attributes (what to group by)
          aggregateAttributes:
            - newAttribute: year
              attribute: year

          # Define multiple calculations to perform on the same grouping
          calculations:
            # Calculate averages directly
            - calculation: |
                env.get("__value")["daylight_hours"]
              calculationAttribute: daylight_hours
              method: avg

            - calculation: |
                env.get("__value")["daylight_hours_num"]
              calculationAttribute: daylight_hours_num
              method: avg

            - calculation: |
                env.get("__value")["transmissivity"]
              calculationAttribute: transmissivity
              method: avg

      # ExpressionEvaluator_6 equivalent - calculates sunshine rate
      - id: 4624d686-ec5e-11f0-a279-7c70db10a7e8
        name: ExpressionEvaluator_6
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: sunshine_rate
              method: create
              value: |
                let daylight_hours_value = env.get("__value")["daylight_hours"];
                let max_daylight_hours_value = env.get("__value")["max_daylight_hours"] ?? 0.0;
                if max_daylight_hours_value != 0.0 {
                  daylight_hours_value / max_daylight_hours_value
                } else {
                  0.0
                }

      # ExpressionEvaluator_8 equivalent - calculates cloud rate
      - id: 4624d686-ec5e-11f0-a279-7c70db10a7e9
        name: ExpressionEvaluator_8
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: cloud_rate
              method: create
              value: |
                1.0 - env.get("__value")["sunshine_rate"]

      # ExpressionEvaluator_7 equivalent - creates is_not_9999 flag
      - id: 00557d1e-ec71-11f0-8212-7c70db10a7e3
        name: ExpressionEvaluator_7
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: is_not_9999
              method: create
              value: |
                let year_value = env.get("__value")["year"];
                if year_value != 9999 {
                  1
                } else {
                  0
                }

      # StatisticsCalculator_5 equivalent - performs statistics calculations
      - id: 35a4b566-ec71-11f0-bc8b-7c70db10a7e3
        name: StatisticsCalculator_5
        type: action
        action: StatisticsCalculator
        with:
          groupBy:
            - year
          calculations:
            - newAttribute: sum_is_not_9999
              expr: |
                env.get("__value")["is_not_9999"] ?? 0.0
            - newAttribute: sum_sunshine_rate
              expr: |
                env.get("__value")["sunshine_rate"] ?? 0.0
            - newAttribute: sum_cloud_rate
              expr: |
                env.get("__value")["cloud_rate"] ?? 0.0

      # AttributeCreator_6 equivalent - creates join key
      - id: 78dd336c-ec71-11f0-a5ee-7c70db10a7e3
        name: AttributeCreator_6
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: join_key
              method: create
              value: |
                "key"

      - id: cf028708-eba2-11f0-baa6-7c70db10a7e3
        name: DummyOutput
        type: action
        action: NoopSink

    edges:
      - id: bcdf7d4c-eba2-11f0-995a-7c70db10a7e3
        from: c4ea198e-eba2-11f0-b93c-7c70db10a7e3
        to: 9444dbf6-eba3-11f0-bdcb-7c70db10a7e3
        fromPort: default
        toPort: default

      - id: f113d102-eba3-11f0-ae93-7c70db10a7e3
        from: 9444dbf6-eba3-11f0-bdcb-7c70db10a7e3
        to: fe5bafa8-ef7f-11f0-90ad-6c02e0440ed6
        fromPort: default
        toPort: default

      - id: 18d630d8-ef80-11f0-b0a2-6c02e0440ed6
        from: fe5bafa8-ef7f-11f0-90ad-6c02e0440ed6
        to: b26d26ee-ec37-11f0-8e87-7c70db10a7e3
        fromPort: default
        toPort: default

      # Connect the new AttributeAggregator directly to TestFilter_2
      - id: 4353493c-ec5a-11f0-8f0d-7c70db10a7e3
        from: b26d26ee-ec37-11f0-8e87-7c70db10a7e3
        to: 4624d686-ec5e-11f0-a279-7c70db10a7e3
        fromPort: default
        toPort: default

      # edge connect PrepareAttribute to TestFilter_2 (backup connection)
      - id: 26b3234c-ec5f-11f0-9544-7c70db10a7e3
        from: 9444dbf6-eba3-11f0-bdcb-7c70db10a7e3
        to: 4624d686-ec5e-11f0-a279-7c70db10a7e3
        fromPort: default
        toPort: default

      # Connect TestFilter_2 outputs to different aggregators
      - id: 3794a212-ec5a-11f0-9030-7c70db10a7e4
        from: 4624d686-ec5e-11f0-a279-7c70db10a7e3
        to: 4624d686-ec5e-11f0-a279-7c70db10a7e4
        fromPort: yearPort
        toPort: default

      - id: 3794a212-ec5a-11f0-9030-7c70db10a7e5
        from: 4624d686-ec5e-11f0-a279-7c70db10a7e3
        to: 4624d686-ec5e-11f0-a279-7c70db10a7e5
        fromPort: year9999Port
        toPort: default

      # Connect Aggregator_2 directly to ExpressionEvaluator_6 (since it now calculates averages directly)
      - id: 3794a212-ec5a-11f0-9030-7c70db10a7e6
        from: 4624d686-ec5e-11f0-a279-7c70db10a7e4
        to: 4624d686-ec5e-11f0-a279-7c70db10a7e8
        fromPort: default
        toPort: default

      # Connect Aggregator_4 directly to ExpressionEvaluator_6 (since it now calculates averages directly)
      - id: 3794a212-ec5a-11f0-9030-7c70db10a7e7
        from: 4624d686-ec5e-11f0-a279-7c70db10a7e5
        to: 4624d686-ec5e-11f0-a279-7c70db10a7e8
        fromPort: default
        toPort: default

      # Connect ExpressionEvaluator_6 to ExpressionEvaluator_8
      - id: e76300b0-ec70-11f0-8c1a-7c70db10a7e3
        from: 4624d686-ec5e-11f0-a279-7c70db10a7e8
        to: 4624d686-ec5e-11f0-a279-7c70db10a7e9
        fromPort: default
        toPort: default

      # Connect ExpressionEvaluator_8 to ExpressionEvaluator_7
      - id: f05a8bfc-ec70-11f0-870f-7c70db10a7e3
        from: 4624d686-ec5e-11f0-a279-7c70db10a7e9
        to: 00557d1e-ec71-11f0-8212-7c70db10a7e3
        fromPort: default
        toPort: default

      # Connect ExpressionEvaluator_7 to StatisticsCalculator_5
      - id: 2b2b8e02-ec71-11f0-8282-7c70db10a7e3
        from: 00557d1e-ec71-11f0-8212-7c70db10a7e3
        to: 35a4b566-ec71-11f0-bc8b-7c70db10a7e3
        fromPort: default
        toPort: default

      # Connect StatisticsCalculator_5 to AttributeCreator_6
      - id: 4c8c746c-ec71-11f0-9a9a-7c70db10a7e3
        from: 35a4b566-ec71-11f0-bc8b-7c70db10a7e3
        to: 78dd336c-ec71-11f0-a5ee-7c70db10a7e3
        fromPort: default
        toPort: default

      # Connect AttributeCreator_6 to final output
      - id: ed2159d2-ef6a-11f0-a8f5-6c02e0440ed6
        from: 78dd336c-ec71-11f0-a5ee-7c70db10a7e3
        to: cf028708-eba2-11f0-baa6-7c70db10a7e3
        fromPort: default
        toPort: default

