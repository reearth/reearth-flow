id: a9952b0d-e085-4a0b-bb76-fa36b969c96b
name: SurfaceValidation01
nodes:
  - id: 5d8f3c2e-9a4b-4e1c-8f7a-3c5d9e2b8a1f
    name: InputRouter
    type: action
    action: InputRouter
    with:
      routingPort: default

  - id: e9f2c5b8-3a7d-4c1e-8b6f-2d9a5c8e1b4f
    name: PLATEAU3.LodSplitterWithDM
    type: subGraph
    subGraphId: 7e98d856-1438-4148-bdcb-91747ef2e405

  # SurfaceValidator2D (LOD0)
  - id: 3c8d9e7f-2a5b-4f1c-8e6a-9d3c5b8e1a4f
    name: PLATEAU3.SurfaceValidator2D
    type: subGraph
    subGraphId: 8a5b1c9d-2e4f-4a3b-9c5d-1e6f8a2b4c7d

  - id: b1f5a9c3-7e2d-4a8c-9f6b-2d8e5c3a7b9f
    name: AttributeManagerLod0InvalidSurface
    type: action
    action: AttributeManager
    with:
      operations:
        - attribute: gmlFilename
          method: rename
          value: filename
        - attribute: featureType
          method: rename
          value: feature_type
        - attribute: gmlId
          method: rename
          value: gml_id
        - attribute: issue
          method: create
          value: |
            if env.get("__value").validationResult?.details == () {
              return "UnknownError";
            }
            env.get("__value").validationResult.details[0][0]

        # remove
        - attribute: validationResult
          method: remove
        - attribute: surfaceId
          method: remove
        - attribute: dirCodelists
          method: remove
        - attribute: featureIndex
          method: remove
        - attribute: featureId
          method: remove
        - attribute: gmlPath
          method: remove
        - attribute: fileIndex
          method: remove
        - attribute: holeCount
          method: remove
        - attribute: maxLod
          method: remove
        - attribute: cityGmlAttributes
          method: remove
        - attribute: featureParentId
          method: remove
        - attribute: dumpGeometry
          method: remove
        - attribute: gmlName
          method: remove
        - attribute: geometryName
          method: remove
        - attribute: gmlRootId
          method: remove
        #
        - attribute: baseCityCode
          method: remove
        - attribute: cityCode
          method: remove
        - attribute: extension
          method: remove
        - attribute: package
          method: remove
        - attribute: root
          method: remove
        - attribute: admin
          method: remove
        - attribute: area
          method: remove
        - attribute: dirRoot
          method: remove
        - attribute: udxDirs
          method: remove
        - attribute: codelists
          method: remove
        - attribute: dirSchemas
          method: remove
        - attribute: schemas
          method: remove
        - attribute: objectListPath
          method: remove

  - id: a7b3c9e5-4f8d-4c2e-9a1b-6e3f5d8c2a7b
    name: FeatureWriterLod0IncorrectOrientation
    type: action
    action: FeatureWriter
    with:
      format: csv
      output: |
        file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "02_建築物_LOD0面の向きエラー.csv")

  - id: f8e2a4c6-5d9b-4f7e-8c3a-1e6d4b8f2c5a
    name: FeatureWriterLod0InvalidSurface
    type: action
    action: FeatureWriter
    with:
      format: csv
      output: |
        file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "02_建築物_LOD0面のエラー.csv")

  # SurfaceValidator3D (LOD1)
  - id: 950407af-eec5-49ee-902c-2b41f31150d3
    name: PLATEAU3.SurfaceValidator3D_LOD1
    type: subGraph
    subGraphId: 8a5b1c9d-2e4f-4a3b-9c5d-1e6f8a2b4c7d

  - id: c2e8f4a6-9b3d-4e7c-8a5f-1d9b6e4c7f2a
    name: AttributeManagerLod1InvalidSurface
    type: action
    action: AttributeManager
    with:
      operations:
        - attribute: gmlFilename
          method: rename
          value: filename
        - attribute: featureType
          method: rename
          value: feature_type
        - attribute: gmlId
          method: rename
          value: gml_id
        - attribute: issue
          method: create
          value: |
            let value = env.get("__value");
            if value.validationResult?.details != () {
              return value.validationResult.details[0][0];
            }
            if "issue" in value {
              return value.issue;
            }
            "UnknownError"

        # remove
        - attribute: validationResult
          method: remove
        - attribute: surfaceId
          method: remove
        - attribute: dirCodelists
          method: remove
        - attribute: featureIndex
          method: remove
        - attribute: featureId
          method: remove
        - attribute: gmlPath
          method: remove
        - attribute: fileIndex
          method: remove
        - attribute: holeCount
          method: remove
        - attribute: maxLod
          method: remove
        - attribute: cityGmlAttributes
          method: remove
        - attribute: featureParentId
          method: remove
        - attribute: dumpGeometry
          method: remove
        - attribute: gmlName
          method: remove
        - attribute: geometryName
          method: remove
        - attribute: gmlRootId
          method: remove
        #
        - attribute: baseCityCode
          method: remove
        - attribute: cityCode
          method: remove
        - attribute: extension
          method: remove
        - attribute: package
          method: remove
        - attribute: root
          method: remove
        - attribute: admin
          method: remove
        - attribute: area
          method: remove
        - attribute: dirRoot
          method: remove
        - attribute: udxDirs
          method: remove
        - attribute: codelists
          method: remove
        - attribute: dirSchemas
          method: remove
        - attribute: schemas
          method: remove
        - attribute: objectListPath
          method: remove

  - id: d5a7b9f3-6e4c-4d8a-9f2b-3c7e8d5a6b9f
    name: FeatureWriterLod1InvalidSurface
    type: action
    action: FeatureWriter
    with:
      format: csv
      output: |
        file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "02_建築物_LOD1境界面のエラー.csv")

  # SurfaceValidator3D (LOD2,3,4)
  # FIXME: replace this with GeometryFilter.
  #   Send `Surface`s to `SurfaceValidator3D` and `Solid`s to `SolidBoundaryValidator`
  - id: 4f7a9b2e-5c8d-4e3a-9f6b-1d4c7e9a2b5f
    name: Dummy_GeometryFilter
    type: action
    action: NoopProcessor

  - id: 3b6e9c5d-8f2a-4d7b-9e3c-6a1f4b9e2c5d
    name: PLATEAU3.SurfaceValidator3D_LOD2-4
    type: subGraph
    subGraphId: 8a5b1c9d-2e4f-4a3b-9c5d-1e6f8a2b4c7d

  - id: 7f2a5c8d-4b9e-4c3a-9f6d-2e8b5c7a4f9d
    name: AttributeManagerLod2-4InvalidSurface
    type: action
    action: AttributeManager
    with:
      operations:
        - attribute: gmlFilename
          method: rename
          value: filename
        - attribute: featureType
          method: rename
          value: feature_type
        - attribute: gmlId
          method: rename
          value: gml_id
        - attribute: issue
          method: create
          value: |
            let value = env.get("__value");
            if value.validationResult?.details != () {
              return value.validationResult.details[0][0];
            }
            if "issue" in value {
              return value.issue;
            }
            "UnknownError"

        # remove
        - attribute: validationResult
          method: remove
        - attribute: surfaceId
          method: remove
        - attribute: dirCodelists
          method: remove
        - attribute: featureIndex
          method: remove
        - attribute: featureId
          method: remove
        - attribute: gmlPath
          method: remove
        - attribute: fileIndex
          method: remove
        - attribute: holeCount
          method: remove
        - attribute: maxLod
          method: remove
        - attribute: cityGmlAttributes
          method: remove
        - attribute: featureParentId
          method: remove
        - attribute: dumpGeometry
          method: remove
        - attribute: gmlName
          method: remove
        - attribute: geometryName
          method: remove
        - attribute: gmlRootId
          method: remove
        #
        - attribute: baseCityCode
          method: remove
        - attribute: cityCode
          method: remove
        - attribute: extension
          method: remove
        - attribute: package
          method: remove
        - attribute: root
          method: remove
        - attribute: admin
          method: remove
        - attribute: area
          method: remove
        - attribute: dirRoot
          method: remove
        - attribute: udxDirs
          method: remove
        - attribute: codelists
          method: remove
        - attribute: dirSchemas
          method: remove
        - attribute: schemas
          method: remove
        - attribute: objectListPath
          method: remove

  - id: 9e3c6b8f-5a2d-4f7e-8c1a-4d9b6e3c8f5a
    name: FeatureWriterLod2-4InvalidSurface
    type: action
    action: FeatureWriter
    with:
      format: csv
      output: |
        file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "02_建築物_LOD2以上境界面のエラー.csv")

  # Output
  - id: 5e2c9b7a-8d4f-4b1e-9c6a-3f5d8b2e7c4a
    name: OutputRouter
    type: action
    action: OutputRouter
    with:
      routingPort: default

edges:
  - id: 8c4d7e2a-5b6f-4918-a3e5-9d1c8b7a6e4f
    from: 5d8f3c2e-9a4b-4e1c-8f7a-3c5d9e2b8a1f
    to: e9f2c5b8-3a7d-4c1e-8b6f-2d9a5c8e1b4f
    fromPort: default
    toPort: default

  - id: 2f5a8c9d-6e3b-4c7a-9f8e-1d4c7b5a9e2f
    from: e9f2c5b8-3a7d-4c1e-8b6f-2d9a5c8e1b4f
    to: 3c8d9e7f-2a5b-4f1c-8e6a-9d3c5b8e1a4f
    fromPort: lod0
    toPort: default

  - id: 9b7d5e3c-4f8a-4e2b-9c1a-8d6f5b3e7c2a
    from: 3c8d9e7f-2a5b-4f1c-8e6a-9d3c5b8e1a4f
    to: a7b3c9e5-4f8d-4c2e-9a1b-6e3f5d8c2a7b
    fromPort: inCorrectOrientation
    toPort: default

  - id: 6d4c8e2b-7a5f-4b3e-8c9a-5e2d9b6c8f1a
    from: a7b3c9e5-4f8d-4c2e-9a1b-6e3f5d8c2a7b
    to: 5e2c9b7a-8d4f-4b1e-9c6a-3f5d8b2e7c4a
    fromPort: default
    toPort: default

  - id: 7c1e5b9d-3f8a-4e2c-9b6d-8a5c2e7f4b1c
    from: 3c8d9e7f-2a5b-4f1c-8e6a-9d3c5b8e1a4f
    to: b1f5a9c3-7e2d-4a8c-9f6b-2d8e5c3a7b9f
    fromPort: invalidSurface
    toPort: default

  - id: e3c7d1b5-9a4f-4e8b-8c2d-6f1a9e3b8c5d
    from: b1f5a9c3-7e2d-4a8c-9f6b-2d8e5c3a7b9f
    to: f8e2a4c6-5d9b-4f7e-8c3a-1e6d4b8f2c5a
    fromPort: default
    toPort: default

  - id: 4b6e8f2d-9c3a-4e7f-8b1d-5a9c2e6f8b3d
    from: f8e2a4c6-5d9b-4f7e-8c3a-1e6d4b8f2c5a
    to: 5e2c9b7a-8d4f-4b1e-9c6a-3f5d8b2e7c4a
    fromPort: default
    toPort: default

  - id: 6a4ed27d-58b6-4021-ae4c-d919534e5fb3
    from: e9f2c5b8-3a7d-4c1e-8b6f-2d9a5c8e1b4f
    to: 950407af-eec5-49ee-902c-2b41f31150d3
    fromPort: lod1
    toPort: default

  - id: 8f3b5d9e-7c2a-4e6f-9d3b-5a8c1e4f7b2d
    from: 950407af-eec5-49ee-902c-2b41f31150d3
    to: c2e8f4a6-9b3d-4e7c-8a5f-1d9b6e4c7f2a
    fromPort: invalidSurface
    toPort: default

  - id: 2a6c8f4d-5e9b-4c7a-8f2d-9b5e3c6a8f1d
    from: c2e8f4a6-9b3d-4e7c-8a5f-1d9b6e4c7f2a
    to: d5a7b9f3-6e4c-4d8a-9f2b-3c7e8d5a6b9f
    fromPort: default
    toPort: default

  - id: 7e1d9c5b-3f8a-4e2c-9b6d-8a5c2e7f4b1c
    from: d5a7b9f3-6e4c-4d8a-9f2b-3c7e8d5a6b9f
    to: 5e2c9b7a-8d4f-4b1e-9c6a-3f5d8b2e7c4a
    fromPort: default
    toPort: default

  # LodSplitterWithDM to FeatureFilter
  - id: 9d3f6a8e-4c7b-4e2a-8f5d-2b9c5e8a1f6d
    from: e9f2c5b8-3a7d-4c1e-8b6f-2d9a5c8e1b4f
    to: 4f7a9b2e-5c8d-4e3a-9f6b-1d4c7e9a2b5f
    fromPort: lod2
    toPort: default

  - id: 8e5b7c4f-2a9d-4f6e-9c3b-7a4f8e2c5b9d
    from: e9f2c5b8-3a7d-4c1e-8b6f-2d9a5c8e1b4f
    to: 4f7a9b2e-5c8d-4e3a-9f6b-1d4c7e9a2b5f
    fromPort: lod3
    toPort: default

  - id: 6c2e9f5a-7b4d-4c8e-9f2a-5d8c3e6f9b2a
    from: e9f2c5b8-3a7d-4c1e-8b6f-2d9a5c8e1b4f
    to: 4f7a9b2e-5c8d-4e3a-9f6b-1d4c7e9a2b5f
    fromPort: lod4
    toPort: default

  # Dummy_GeometryFilter to SurfaceValidator3D_LOD2-4
  - id: 1a5f3c8d-9e2b-4d7a-8c6f-5b9e3d2a6f8c
    from: 4f7a9b2e-5c8d-4e3a-9f6b-1d4c7e9a2b5f
    to: 3b6e9c5d-8f2a-4d7b-9e3c-6a1f4b9e2c5d
    fromPort: default
    toPort: default

  # SurfaceValidator3D_LOD2-4 to AttributeManagerLod2-4InvalidSurface
  - id: 2b6f4d9e-3c8a-4e5b-9d7c-6a8f2e5c9b4d
    from: 3b6e9c5d-8f2a-4d7b-9e3c-6a1f4b9e2c5d
    to: 7f2a5c8d-4b9e-4c3a-9f6d-2e8b5c7a4f9d
    fromPort: invalidSurface
    toPort: default

  # AttributeManagerLod2-4InvalidSurface to FeatureWriterLod2-4InvalidSurface
  - id: 3c7f5e0a-4d9b-4f6c-8e4a-7b0f3c6d8e5a
    from: 7f2a5c8d-4b9e-4c3a-9f6d-2e8b5c7a4f9d
    to: 9e3c6b8f-5a2d-4f7e-8c1a-4d9b6e3c8f5a
    fromPort: default
    toPort: default

  # FeatureWriterLod2-4InvalidSurface to OutputRouter
  - id: 4d8f6f1b-5e0c-4f7d-9f5b-8c1f4d7e0f6b
    from: 9e3c6b8f-5a2d-4f7e-8c1a-4d9b6e3c8f5a
    to: 5e2c9b7a-8d4f-4b1e-9c6a-3f5d8b2e7c4a
    fromPort: default
    toPort: default
