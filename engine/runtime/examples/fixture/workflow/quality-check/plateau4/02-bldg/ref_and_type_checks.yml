id: 34e55bec-9185-4a66-9c41-3dbddc1e64fa
name: ReferenceAndTypeChecker
nodes:
  - id: ab309f69-4758-491b-831c-75ea5c0f05fe
    name: InputRouter
    type: action
    action: InputRouter
    with:
      routingPort: default

  - id: 911ebdb1-a05e-48f4-a208-c0653f1f1731
    name: UnmatchedXlinkDetector
    type: action
    action: PLATEAU4.UnmatchedXlinkDetector
    with:
      attribute: gmlPath

  - id: 691a328a-f39b-403e-b62f-7525771b6f14
    name: L-bldg-Summary
    type: action
    action: NoopSink

  - id: 88c90fea-04d6-4e54-8ab1-4dc6386f6699
    name: AttributeManagerFrom
    type: action
    action: AttributeManager
    with:
      operations:
        - attribute: Attribute
          method: create
          value: |
            "参照元 xlink:href"
        - attribute: unmatchedXlinkFromTag
          method: rename
          value: unmatchedXlinkTag
        - attribute: unmatchedXlinkFromId
          method: rename
          value: unmatchedXlinkId

  - id: 2d024ca7-cb00-47bb-aa50-12a395a6c8b8
    name: AttributeManagerTo
    type: action
    action: AttributeManager
    with:
      operations:
        - attribute: Attribute
          method: create
          value: |
            "参照先 gml:id"
        - attribute: unmatchedXlinkToTag
          method: rename
          value: unmatchedXlinkTag
        - attribute: unmatchedXlinkToId
          method: rename
          value: unmatchedXlinkId

  - id: 7c7dd820-2c7e-4e79-ab3f-1566fc4bd2ca
    name: AttributeMapperL-bldg-06
    type: action
    action: AttributeMapper
    with:
      mappers:
        - attribute: Index
          expr: |
            env.get("__value").fileIndex
        - attribute: Filename
          expr: |
            file::extract_filename(env.get("__value").gmlPath)
        - attribute: gmlFilename
          expr: |
            file::extract_filename(env.get("__value").gmlPath)
        - attribute: "Building gml:id"
          expr: |
            env.get("__value").gmlId
        - attribute: "Unmatched Xlink Tag"
          expr: |
            collection::join_array((env.get("__value").unmatchedXlinkTag ?? []), ",")
        - attribute: Attribute
          expr: |
            env.get("__value").Attribute
        - attribute: "Unmatched Xlink ID"
          expr: |
            collection::join_array((env.get("__value").unmatchedXlinkId ?? []), ",")

  - id: 99d8e9f0-1a2b-3c4d-5e6f-7a8b9c0d1e2f
    name: AttributeManagerLbldg06
    type: action
    action: AttributeManager
    with:
      operations:
        - attribute: gmlFilename
          method: remove

  - id: adba8857-9de2-43bd-8cde-b83bc08a58f6
    name: FileWriterTsvL-bldg-06
    type: action
    action: FeatureWriter
    with:
      format: csv
      output: |
        file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "02_建築物_L-bldg-06エラー.csv")

  - id: 77a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c
    name: Lbldg06ErrorCounter
    type: action
    action: StatisticsCalculator
    with:
      groupBy:
      - gmlFilename
      calculations:
        - newAttribute: _num_lbldg06_error
          expr: "1"

  - id: 88b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d
    name: ErrorCount-Lbldg06
    type: action
    action: OutputRouter
    with:
      routingPort: errorCountLbldg06

  # t-bldg-02
  - id: 1c480edd-fa61-4b43-b851-8cfc560f5859
    name: BuildingInstallationGeometryTypeChecker
    type: action
    action: PLATEAU4.BuildingInstallationGeometryTypeChecker

  - id: 690f9475-1821-4f50-8315-f00f53251a00
    name: FeatureFilterByBuildingInstallationGeometryType
    type: action
    action: FeatureFilter
    with:
      conditions:
        - expr: |
            !(env.get("__value").geomTag in ["gml:MultiSurface", "gml:Solid"])
          outputPort: default

  - id: 38b305d1-d716-48da-b578-419e15f66b4b
    name: AttributeMapperT-bldg-02
    type: action
    action: AttributeMapper
    with:
      mappers:
        - attribute: Index
          expr: |
            env.get("__value").fileIndex
        - attribute: Filename
          expr: |
            file::extract_filename(env.get("__value").gmlPath)
        - attribute: "Building gml:id"
          expr: |
            env.get("__value").bldgGmlId
        - attribute: "BuildingInstallation gml:id"
          expr: |
            env.get("__value").instGmlId
        - attribute: "GeometryType"
          expr: |
            env.get("__value").geomTag

  - id: 2bae2659-e981-4eb1-8cbe-ce0352584a10
    name: FileWriterTsvT-bldg-02
    type: action
    action: FeatureWriter
    with:
      format: csv
      output: |
        file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "02_建築物_T-bldg-02エラー.csv")

  - id: 35e0e6d2-44f4-4e75-abce-5280c2b80a5d
    name: StatisticsCalculatorT-bldg-02
    type: action
    action: StatisticsCalculator
    with:
      groupBy:
      - "cityGmlPath"
      calculations:
        - newAttribute: instGmlIdTotalCount
          expr: |
            let gml_id = env.get("__value").instGmlId ?? "";
            if gml_id != "" {
              1
            } else {
              0
            }

  - id: 630081e4-0ea1-4fd3-ba31-8154b2980258
    name: NoopT-bldg-02
    type: action
    action: NoopSink

  - id: 99a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c
    name: InvalidBldgInstGeomTypeCounter
    type: action
    action: StatisticsCalculator
    with:
      groupBy:
      - gmlFilename
      calculations:
        - newAttribute: _num_invalid_bldginst_geom_type
          expr: "1"

  - id: 88d2c3e4-5f6a-7b8c-9d0e-1f2a3b4c5d6e
    name: ErrorCount-InvalidBldgInstGeomType
    type: action
    action: OutputRouter
    with:
      routingPort: errorCountInvalidBldgInstGeomType

  - id: aab0c1d2-3e4f-5a6b-7c8d-9e0f1a2b3c4d
    name: FileOutputRouter
    type: action
    action: OutputRouter
    with:
      routingPort: fileOutput

edges:
  - id: 93431d4e-fcd2-4308-af3c-9da9441ac911
    from: ab309f69-4758-491b-831c-75ea5c0f05fe
    to: 911ebdb1-a05e-48f4-a208-c0653f1f1731
    fromPort: default
    toPort: default

  - id: 6941c617-dc23-4aa9-b794-b7d409212ccb
    from: 911ebdb1-a05e-48f4-a208-c0653f1f1731
    to: 691a328a-f39b-403e-b62f-7525771b6f14
    fromPort: summary
    toPort: default

  - id: abcb0569-faf7-4317-80d8-fb80a0e5b0d7
    from: 911ebdb1-a05e-48f4-a208-c0653f1f1731
    to: 88c90fea-04d6-4e54-8ab1-4dc6386f6699
    fromPort: unMatchedXlinkFrom
    toPort: default

  - id: 9830a9fb-73ed-42c2-b2eb-c2315560ae49
    from: 911ebdb1-a05e-48f4-a208-c0653f1f1731
    to: 2d024ca7-cb00-47bb-aa50-12a395a6c8b8
    fromPort: unMatchedXlinkTo
    toPort: default

  - id: 6e42817f-c316-40d0-b972-17ad2409a350
    from: 88c90fea-04d6-4e54-8ab1-4dc6386f6699
    to: 7c7dd820-2c7e-4e79-ab3f-1566fc4bd2ca
    fromPort: default
    toPort: default

  - id: 59fcfbd3-9e08-4117-bd5d-43854c6af81f
    from: 2d024ca7-cb00-47bb-aa50-12a395a6c8b8
    to: 7c7dd820-2c7e-4e79-ab3f-1566fc4bd2ca
    fromPort: default
    toPort: default

  - id: f398a1bc-8dc3-4b14-a971-3e765afea9ef
    from: 7c7dd820-2c7e-4e79-ab3f-1566fc4bd2ca
    to: 99d8e9f0-1a2b-3c4d-5e6f-7a8b9c0d1e2f
    fromPort: default
    toPort: default

  - id: 88e8f9a0-1b2c-3d4e-5f6a-7b8c9d0e1f2a
    from: 99d8e9f0-1a2b-3c4d-5e6f-7a8b9c0d1e2f
    to: adba8857-9de2-43bd-8cde-b83bc08a58f6
    fromPort: default
    toPort: default

  - id: 55a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c
    from: 7c7dd820-2c7e-4e79-ab3f-1566fc4bd2ca
    to: 77a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c
    fromPort: default
    toPort: default

  - id: 66b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d
    from: 77a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c
    fromPort: default
    to: 88b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d
    toPort: default

  - id: 50c97ada-42ba-494e-a844-d3256f998a60
    from: ab309f69-4758-491b-831c-75ea5c0f05fe
    to: 1c480edd-fa61-4b43-b851-8cfc560f5859
    fromPort: default
    toPort: default

  - id: 9ac13613-ccca-42fd-afd1-77fa2635e288
    from: 1c480edd-fa61-4b43-b851-8cfc560f5859
    to: 690f9475-1821-4f50-8315-f00f53251a00
    fromPort: default
    toPort: default

  - id: c79def35-473d-406a-8478-0335aa9ae4c1
    from: 690f9475-1821-4f50-8315-f00f53251a00
    to: 38b305d1-d716-48da-b578-419e15f66b4b
    fromPort: default
    toPort: default

  - id: 4205ee4c-4a1b-4628-b602-6127b994a8a0
    from: 38b305d1-d716-48da-b578-419e15f66b4b
    to: 2bae2659-e981-4eb1-8cbe-ce0352584a10
    fromPort: default
    toPort: default

  - id: ddac9d6a-fe63-4bf2-a640-5e2a541176a2
    from: 690f9475-1821-4f50-8315-f00f53251a00
    to: 35e0e6d2-44f4-4e75-abce-5280c2b80a5d
    fromPort: default
    toPort: default

  - id: ad6ddebd-4302-46f1-8df7-1358be238470
    from: 35e0e6d2-44f4-4e75-abce-5280c2b80a5d
    to: 630081e4-0ea1-4fd3-ba31-8154b2980258
    fromPort: default
    toPort: default

  - id: 77a7b8c9-0d1e-2f3a-4b5c-6d7e8f9a0b1c
    from: 690f9475-1821-4f50-8315-f00f53251a00
    fromPort: default
    to: 99a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c
    toPort: default

  - id: 66b6c7d8-9e0f-1a2b-3c4d-5e6f7a8b9c0d
    from: 99a1b2c3-4d5e-6f7a-8b9c-0d1e2f3a4b5c
    fromPort: default
    to: 88d2c3e4-5f6a-7b8c-9d0e-1f2a3b4c5d6e
    toPort: default

  # === Beginning of FileOutput ===
  - id: 0a1b2c3d-4e5f-6a7b-8c9d-0e1f2a3b4c5d
    from: adba8857-9de2-43bd-8cde-b83bc08a58f6  # FileWriterTsvL-bldg-06
    fromPort: default
    to: aab0c1d2-3e4f-5a6b-7c8d-9e0f1a2b3c4d  # FileOutputRouter
    toPort: default

  - id: 1b2c3d4e-5f6a-7b8c-9d0e-1f2a3b4c5d6e
    from: 2bae2659-e981-4eb1-8cbe-ce0352584a10  # FileWriterTsvT-bldg-02
    fromPort: default
    to: aab0c1d2-3e4f-5a6b-7c8d-9e0f1a2b3c4d  # FileOutputRouter
    toPort: default
  # === End of FileOutput ===

# Export error count ports for aggregation in parent workflow
ports:
  outputs:
    - id: errorCountLbldg06
      nodeId: 88b2c3d4-5e6f-7a8b-9c0d-1e2f3a4b5c6d
      port: default
    - id: errorCountInvalidBldgInstGeomType
      nodeId: 88d2c3e4-5f6a-7b8c-9d0e-1f2a3b4c5d6e
      port: default
    - id: fileOutput
      nodeId: aab0c1d2-3e4f-5a6b-7c8d-9e0f1a2b3c4d
      port: default
