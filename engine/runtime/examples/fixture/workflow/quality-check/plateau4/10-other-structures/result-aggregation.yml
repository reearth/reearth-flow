id: p8062ae8-f2a9-11f0-8ef7-7c70db10a7f2
name: PLATEAU4.ResultAggregation
nodes:
- id: q8062ae8-f2a9-11f0-8ef7-7c70db10a7f3
  name: InputRouterSurfaceValidation
  type: action
  action: InputRouter
  with:
    routingPort: surface_validation_results
- id: r8062ae8-f2a9-11f0-8ef7-7c70db10a7f4
  name: InputRouterSolidValidation
  type: action
  action: InputRouter
  with:
    routingPort: solid_validation_results
- id: s8062ae8-f2a9-11f0-8ef7-7c70db10a7f5
  name: InputRouterGmlNameValidation
  type: action
  action: InputRouter
  with:
    routingPort: gml_name_validation_results
- id: t8062ae8-f2a9-11f0-8ef7-7c70db10a7f6
  name: FeatureMerger
  type: action
  action: FeatureMerger
  with:
    requestorAttributeValue: |
      env.get("__value").feature_type + "_" + env.get("__value").lod
    supplierAttributeValue: |
      env.get("__value").feature_type + "_" + env.get("__value").lod
    joinAttributes:
      - attributeName: _num_incorrect_orientation
        conflictResolution: useRequestor
      - attributeName: _surface_issues
        conflictResolution: useRequestor
      - attributeName: _num_not_closed_solid
        conflictResolution: useRequestor
      - attributeName: _num_other_solid_issue
        conflictResolution: useRequestor
      - attributeName: "コード化されていないgml_nameあり"
        conflictResolution: useRequestor
- id: u8062ae8-f2a9-11f0-8ef7-7c70db10a7f7
  name: AttributeManagerResults
  type: action
  action: AttributeManager
  with:
    operations:
      - attribute: Index
        method: create
        value: |
          env.get("__value").file_index
      - attribute: Folder
        method: create
        value: |
          env.get("__value").folder_package
      - attribute: Filename
        method: create
        value: |
          env.get("__value").gml_filename
      - attribute: "フィーチチャータイプ"
        method: create
        value: |
          env.get("__value").feature_type
      - attribute: LOD
        method: create
        value: |
          env.get("__value").lod
      - attribute: "インスタンス数"
        method: create
        value: |
          env.get("__value").gml_id.total_count
      - attribute: "面のエラー"
        method: create
        value: |
          env.get("__value")._surface_issues
      - attribute: "面の向き不正"
        method: create
        value: |
          env.get("__value")._num_incorrect_orientation
      - attribute: "非水密立体"
        method: create
        value: |
          env.get("__value")._num_not_closed_solid
      - attribute: "立体のエラー"
        method: create
        value: |
          env.get("__value")._num_other_solid_issue
      - attribute: "コード化されていないgml_nameあり"
        method: create
        value: |
          env.get("__value")["コード化されていないgml_nameあり"]
- id: v8062ae8-f2a9-11f0-8ef7-7c70db10a7f8
  name: Sorter
  type: action
  action: Sorter
  with:
    sortBy:
      - attribute: Folder
        order: ascending
      - attribute: LOD
        order: ascending
- id: w8062ae8-f2a9-11f0-8ef7-7c70db10a7f9
  name: PythonCallerErrorCounter
  type: action
  action: PythonCaller
  with:
    script: |
      import fme
      import fmeobjects
      import json

      TARGET_FIELDS = [
        "面のエラー",
        "面の向き不正", 
        "非水密立体",
        "立体のエラー",
        "コード化されていないgml_nameあり"
      ]

      class ErrorCounter(object):
          def __init__(self):
              self.errorCounter = {}
              for attr in TARGET_FIELDS:
                  self.errorCounter[attr] = 0
              self.feature = None
              
          def input(self, feature):
              if self.feature == None:
                  self.feature = feature
              for attr in TARGET_FIELDS:
                  try:
                      n = int(feature.getAttribute(attr))
                      self.errorCounter[attr] += n
                  except:
                      pass
                      
          def process_group(self):
              if self.feature:
                  result = []
                  for k, v in self.errorCounter.items():
                      result.append({
                          "name": k,
                          "count": v,
                      })
                  result = json.dumps(result, indent=3, ensure_ascii=False)
                  self.feature.setAttribute("_result", result)
                  self.pyoutput(self.feature)
                  
              self.__init__()
              
          def close(self):
              pass

          def has_support_for(self, support_type):
              if support_type == fmeobjects.FME_SUPPORT_FEATURE_TABLE_SHIM:
                  # If this is set to return True, FME will pass features to the input() method that
                  # come from a feature table object. This allows for significant performance gains
                  # when processing large numbers of features.
                  # To enable this, the following conditions must be met:
                  #   1) features passed into the input() method cannot be copied or cached for later use
                  #   2) features cannot be read or modified after being passed to self.pyoutput()
                  #   3) Group Processing must not be enabled
                  # Violations will cause undefined behavior.
                  return False
              
              return False
    className: ErrorCounter
    groupBy:
      - Folder
      - LOD
- id: x8062ae8-f2a9-11f0-8ef7-7c70db10a7fa
  name: AttributeManagerSummary
  type: action
  action: AttributeManager
  with:
    operations:
      - attribute: _dest_filename
        method: create
        value: |
          "summary_" + env.get("__value").Folder + "_lod" + env.get("__value").LOD + ".json"
      - attribute: data_file_data
        method: rename
        newName: _result
- id: y8062ae8-f2a9-11f0-8ef7-7c70db10a7fb
  name: OutputRouter
  type: action
  action: OutputRouter
  with:
    routingPort: default
edges:
- id: z8062ae8-f2a9-11f0-8ef7-7c70db10a7fc
  from: q8062ae8-f2a9-11f0-8ef7-7c70db10a7f3
  to: t8062ae8-f2a9-11f0-8ef7-7c70db10a7f6
  fromPort: default
  toPort: requestor
- id: a8062ae8-f2a9-11f0-8ef7-7c70db10a7fd
  from: r8062ae8-f2a9-11f0-8ef7-7c70db10a7f4
  to: t8062ae8-f2a9-11f0-8ef7-7c70db10a7f6
  fromPort: default
  toPort: supplier
- id: b8062ae8-f2a9-11f0-8ef7-7c70db10a7fe
  from: s8062ae8-f2a9-11f0-8ef7-7c70db10a7f5
  to: t8062ae8-f2a9-11f0-8ef7-7c70db10a7f6
  fromPort: default
  toPort: supplier
- id: c8062ae8-f2a9-11f0-8ef7-7c70db10a7ff
  from: t8062ae8-f2a9-11f0-8ef7-7c70db10a7f6
  to: u8062ae8-f2a9-11f0-8ef7-7c70db10a7f7
  fromPort: merged
  toPort: default
- id: d8062ae8-f2a9-11f0-8ef7-7c70db10a800
  from: u8062ae8-f2a9-11f0-8ef7-7c70db10a7f7
  to: v8062ae8-f2a9-11f0-8ef7-7c70db10a7f8
  fromPort: default
  toPort: default
- id: e8062ae8-f2a9-11f0-8ef7-7c70db10a801
  from: v8062ae8-f2a9-11f0-8ef7-7c70db10a7f8
  to: w8062ae8-f2a9-11f0-8ef7-7c70db10a7f9
  fromPort: default
  toPort: default
- id: f8062ae8-f2a9-11f0-8ef7-7c70db10a802
  from: w8062ae8-f2a9-11f0-8ef7-7c70db10a7f9
  to: x8062ae8-f2a9-11f0-8ef7-7c70db10a7fa
  fromPort: default
  toPort: default
- id: g8062ae8-f2a9-11f0-8ef7-7c70db10a803
  from: x8062ae8-f2a9-11f0-8ef7-7c70db10a7fa
  to: y8062ae8-f2a9-11f0-8ef7-7c70db10a7fb
  fromPort: default
  toPort: default