id: c2l3m4n5-p6q7-8901-bcde-fab1
name: PLATEAU4.ResultAggregation
nodes:
- id: c3m4n5o6-q7r8-9012-cdef-abc2
  name: InputRouterSurfaceValidation
  type: action
  action: InputRouter
  with:
    routingPort: surface_validation_results
- id: d4n5o6p7-r8s9-0123-defg-bcd3
  name: InputRouterSolidValidation
  type: action
  action: InputRouter
  with:
    routingPort: solid_validation_results
- id: e5o6p7q8-s9t0-1234-efgh-cde4
  name: InputRouterGmlNameValidation
  type: action
  action: InputRouter
  with:
    routingPort: gml_name_validation_results
- id: f6p7q8r9-t0u1-2345-fghi-def5
  name: FeatureMergerResults
  type: action
  action: FeatureMerger
  with:
    requestorAttributeValue: |
      env.get("__value").feature_type + "_" + env.get("__value").lod
    supplierAttributeValue: |
      env.get("__value").feature_type + "_" + env.get("__value").lod
    joinAttributes:
    - attributeName: _num_incorrect_orientation
      conflictResolution: useRequestor
    - attributeName: _surface_issues
      conflictResolution: useRequestor
    - attributeName: _num_not_closed_solid
      conflictResolution: useRequestor
    - attributeName: _num_other_solid_issue
      conflictResolution: useRequestor
    - attributeName: has_uncoded_gml_name
      conflictResolution: useRequestor
- id: g7q8r9s0-u1v2-3456-ghij-efg6
  name: AttributeManagerResults
  type: action
  action: AttributeManager
  with:
    operations:
    - attribute: Index
      method: create
      value: |
        env.get("__value").file_index
    - attribute: Folder
      method: create
      value: |
        env.get("__value").folder_package
    - attribute: Filename
      method: create
      value: |
        env.get("__value").gml_filename
    - attribute: "フィーチチャータイプ"
      method: create
      value: |
        env.get("__value").feature_type
    - attribute: LOD
      method: create
      value: |
        env.get("__value").lod
    - attribute: "インスタンス数"
      method: create
      value: |
        env.get("__value").gml_id.total_count
    - attribute: "面のエラー"
      method: create
      value: |
        env.get("__value")._surface_issues
    - attribute: "面の向き不正"
      method: create
      value: |
        env.get("__value")._num_incorrect_orientation
    - attribute: "非水密立体"
      method: create
      value: |
        env.get("__value")._num_not_closed_solid
    - attribute: "立体のエラー"
      method: create
      value: |
        env.get("__value")._num_other_solid_issue
    - attribute: "コード化されていないgml_nameあり"
      method: create
      value: |
        env.get("__value").has_uncoded_gml_name
- id: h8r9s0t1-v2w3-4567-hijk-fgh7
  name: Sorter
  type: action
  action: Sorter
  with:
    sortBy:
    - attribute: Folder
      order: ascending
    - attribute: LOD
      order: ascending
- id: i9s0t1u2-w3x4-5678-ijkl-ghi8
  name: PythonCallerErrorCounter
  type: action
  action: PythonCaller
  with:
    script: |
      import fme
      import fmeobjects
      import json

      TARGET_FIELDS = [
        "面のエラー",
        "面の向き不正", 
        "非水密立体",
        "立体のエラー",
        "コード化されていないgml_nameあり"
      ]

      class ErrorCounter(object):
          def __init__(self):
              self.errorCounter = {}
              for attr in TARGET_FIELDS:
                  self.errorCounter[attr] = 0
              self.feature = None
              
          def input(self, feature):
              if self.feature == None:
                  self.feature = feature
              for attr in TARGET_FIELDS:
                  try:
                      n = int(feature.getAttribute(attr))
                      self.errorCounter[attr] += n
                  except:
                      pass
                      
          def process_group(self):
              if self.feature:
                  result = []
                  for k, v in self.errorCounter.items():
                      result.append({
                          "name": k,
                          "count": v,
                      })
                  result = json.dumps(result, indent=3, ensure_ascii=False)
                  self.feature.setAttribute("_result", result)
                  self.pyoutput(self.feature)
                  
              self.__init__()
              
          def close(self):
              pass

          def has_support_for(self, support_type):
              if support_type == fmeobjects.FME_SUPPORT_FEATURE_TABLE_SHIM:
                  return False
              
              return False
    className: ErrorCounter
    groupBy:
    - Folder
    - LOD
- id: j0t1u2v3-x4y5-6789-jklm-hij9
  name: AttributeManagerSummary
  type: action
  action: AttributeManager
  with:
    operations:
    - attribute: _dest_filename
      method: create
      value: |
        "summary_" + env.get("__value").Folder + "_lod" + env.get("__value").LOD + ".json"
    - attribute: data_file_data
      method: rename
      newName: _result
- id: k1u2v3w4-y5z6-7890-klmn-ijk0
  name: OutputRouter
  type: action
  action: OutputRouter
  with:
    routingPort: default
edges:
- id: l2v3w4x5-z6a7-8901-lmno-jkl1
  from: c3m4n5o6-q7r8-9012-cdef-abc2
  to: f6p7q8r9-t0u1-2345-fghi-def5
  fromPort: default
  toPort: requestor
- id: m3w4x5y6-a7b8-9012-mnop-klm2
  from: d4n5o6p7-r8s9-0123-defg-bcd3
  to: f6p7q8r9-t0u1-2345-fghi-def5
  fromPort: default
  toPort: supplier
- id: n4x5y6z7-b8c9-0123-nopq-lmn3
  from: e5o6p7q8-s9t0-1234-efgh-cde4
  to: f6p7q8r9-t0u1-2345-fghi-def5
  fromPort: default
  toPort: supplier
- id: o5y6z7a8-c9d0-1234-opqr-mno4
  from: f6p7q8r9-t0u1-2345-fghi-def5
  to: g7q8r9s0-u1v2-3456-ghij-efg6
  fromPort: merged
  toPort: default
- id: p6z7a8b9-d0e1-2345-pqrs-nop5
  from: g7q8r9s0-u1v2-3456-ghij-efg6
  to: h8r9s0t1-v2w3-4567-hijk-fgh7
  fromPort: default
  toPort: default
- id: q7a8b9c0-e1f2-3456-qrst-opq6
  from: h8r9s0t1-v2w3-4567-hijk-fgh7
  to: i9s0t1u2-w3x4-5678-ijkl-ghi8
  fromPort: default
  toPort: default
- id: r8b9c0d1-f2g3-4567-rstu-pqr7
  from: i9s0t1u2-w3x4-5678-ijkl-ghi8
  to: j0t1u2v3-x4y5-6789-jklm-hij9
  fromPort: default
  toPort: default
- id: s9c0d1e2-g3h4-5678-stuv-qrs8
  from: j0t1u2v3-x4y5-6789-jklm-hij9
  to: k1u2v3w4-y5z6-7890-klmn-ijk0
  fromPort: default
  toPort: default