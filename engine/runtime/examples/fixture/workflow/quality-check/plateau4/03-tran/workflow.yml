# yaml-language-server: $schema=https://raw.githubusercontent.com/reearth/reearth-flow/main/engine/schema/workflow.json
id: b9ca5efa-c20d-4587-891c-5bda5c869db4
name: "PLATEAU4-quality-check-03-tran-surface-orientation"
entryGraphId: 742b6f3e-2a63-490a-aec2-829b10fea5f2
with:
  cityGmlPath:
  schemas:
  codelists:
  outputPath:
graphs:
  - !include ../../../../graphs/lod_splitter_with_dm.yml
  - !include ../../../../graphs/surface_validator.yml
  - id: 742b6f3e-2a63-490a-aec2-829b10fea5f2
    name: entry_point
    nodes:
      - id: f9248705-3024-40b0-b729-66507ca6640d
        name: FeatureCreator
        type: action
        action: FeatureCreator
        with:
          creator: |
            [
              #{
                cityGmlPath: env.get("cityGmlPath"),
                cityCode: env.get("cityCode") ?? file::extract_filename(env.get("cityGmlPath"))[0..5],
                baseCityCode: env.get("cityCode") ?? file::extract_filename(env.get("cityGmlPath"))[0..5],
                schemas: env.get("schemas"),
                codelists: env.get("codelists"),
              },
            ]

      - id: 613c6d22-bf1c-4bbb-ba97-d85dd78d81ce
        name: DirectoryDecompressor
        type: action
        action: DirectoryDecompressor
        with:
          archiveAttributes:
            - codelists
            - schemas

      - id: 01c49595-446f-482f-94db-5027f390b6cd
        name: FeatureFilePathExtractor
        type: action
        action: FeatureFilePathExtractor
        with:
          destPrefix: "udx"
          sourceDataset: |
            env.get("__value")["cityGmlPath"]
          extractArchive: true

      - id: 24286bb9-1c30-49b7-afd8-e8dc73c85ed0
        name: FeatureFilterByGml
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value").extension == "gml"
              outputPort: default

      - id: c29be788-be8d-43a2-97bf-3e15228a72a1
        name: FeatureCounterFileIndex
        type: action
        action: FeatureCounter
        with:
          countStart: 1
          outputAttribute: fileIndex

      - id: 33cb26b6-bba2-4600-ae1b-df5d7c0b4678
        name: PLATEAU4.UDXFolderExtractor
        type: action
        action: PLATEAU4.UDXFolderExtractor
        with:
          cityGmlPath: |
            env.get("__value")["path"]
          codelistsPath: codelists
          schemasPath: schemas

      - id: 242e339a-c7df-4be4-82f7-3223a6ed2145
        name: FeatureCityGmlReader
        type: action
        action: FeatureCityGmlReader
        with:
          format: citygml
          flatten: true
          dataset: |
            env.get("__value")["path"]

      # Unreferenced XLink detection for L-TRAN-03
      - id: 6f556405-1fdb-4807-8e3b-f18da79fbe1a
        name: TransportationXlinkDetector
        type: action
        action: PLATEAU4.TransportationXlinkDetector
        with:
          cityGmlPath: |
            env.get("__value")["path"]

      # Map attributes for XLink CSV output
      - id: 95a3af4f-4004-422b-bf86-d64181861bd5
        name: XlinkAttributeMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: Folder
              expr: |
                env.get("__value")["package"] ?? ""
            - attribute: Index
              expr: |
                env.get("__value")["fileIndex"] ?? ""
            - attribute: Filename
              expr: |
                env.get("__value")["name"] ?? ""
            - attribute: FeatureType
              expr: |
                env.get("__value")["featureType"] ?? ""
            - attribute: LOD
              expr: |
                env.get("__value")["lod"] ?? ""
            - attribute: "gml:id"
              expr: |
                env.get("__value")["gmlId"] ?? ""
            - attribute: "未参照"
              expr: |
                env.get("__value")["unreferenced"] ?? ""

      # Write XLink CSV output
      - id: 737996be-8410-4447-9986-bba01fe9ce0c
        name: XlinkCsvWriter
        type: action
        action: FeatureWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("outputPath"), "03_交通_xlink参照エラー.csv")

      - id: 51431704-ac14-41cd-988b-88141dc6e326
        name: PLATEAU3.LodSplitterWithDM
        type: subGraph
        subGraphId: 7e98d856-1438-4148-bdcb-91747ef2e405

      # Surface validator 2D for LOD1 and LOD2
      - id: e28b5f31-4826-4775-a343-a12ecb7f90f9
        name: PLATEAU3.SurfaceValidator2D
        type: subGraph
        subGraphId: 8a5b1c9d-2e4f-4a3b-9c5d-1e6f8a2b4c7d

      # Surface validator 3D for LOD3
      - id: abf4b25e-6c1f-46fd-b5f8-07d43d137abf
        name: PLATEAU3.SurfaceValidator3D
        type: subGraph
        subGraphId: 8a5b1c9d-2e4f-4a3b-9c5d-1e6f8a2b4c7d

      # Attribute Mapper for surface validation errors
      - id: d44341fa-7de4-41f5-abfd-7e0a3b1d9be8
        name: SurfaceValidationAttributeMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: Folder
              expr: |
                env.get("__value")["package"] ?? ""
            - attribute: Index
              expr: |
                env.get("__value")["fileIndex"] ?? ""
            - attribute: Filename
              expr: |
                env.get("__value")["name"] ?? ""
            - attribute: FeatureType
              expr: |
                env.get("__value")["featureType"] ?? ""
            - attribute: LOD
              expr: |
                env.get("__value")["lod"] ?? ""
            - attribute: "gml:id"
              expr: |
                env.get("__value")["featureId"] ?? ""
            - attribute: issue
              expr: |
                let value = env.get("__value");
                if value.validationResult?.details != () {
                  return value.validationResult.details[0][0];
                }
                if "issue" in value {
                  return value.issue;
                }
                "UnknownError"

      # Extract surface orientation
      - id: d60f93c1-c55e-49ee-9332-657f4408ba05
        name: OrientationExtractor
        type: action
        action: OrientationExtractor
        with:
          outputAttribute: orientation

      # Filter for incorrect orientation (clockwise/right_hand_rule)
      - id: 1c385359-698d-40df-aed8-e8b9b0eaac67
        name: FilterIncorrectOrientation
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["orientation"] == "clockwise"
              outputPort: incorrectOrientation

      # Map attributes for CSV output
      - id: 0740c8ce-3c27-416f-9a13-5b2086090426
        name: AttributeMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: Folder
              expr: |
                env.get("__value")["package"] ?? ""
            - attribute: Index
              expr: |
                env.get("__value")["fileIndex"] ?? ""
            - attribute: Filename
              expr: |
                env.get("__value")["name"] ?? ""
            - attribute: FeatureType
              expr: |
                env.get("__value")["featureType"] ?? ""
            - attribute: LOD
              expr: |
                env.get("__value")["lod"] ?? ""
            - attribute: "gml:id"
              expr: |
                env.get("__value")["featureId"] ?? ""

            # The error count is always 1
            - attribute: "エラー数"
              expr: |
                1

            # We hardcode the following two attributes since coming here means the orientation is incorrect
            - attribute: "エラー内容"
              expr: |
                "Incorrect Orientation"
            - attribute: "面の向き"
              expr: |
                "right_hand_rule"

      # Write CSV output
      - id: 2b0d83b3-2c7a-4314-b609-e4f7db379902
        name: CsvWriter
        type: action
        action: FeatureWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("outputPath"), "03_交通_面の向き不正.csv")

      # L-TRAN-02: Adjacent surface overlap detection
      # Filter out features with package == "rwy"
      - id: ce7f18e8-c2cb-42e9-9b2e-9dd72f5ad964
        name: FeatureFilterExcludeRwy
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["package"] != "rwy"
              outputPort: notRwy

      # Convert surfaces to 2D for overlap detection
      - id: b4d2d577-28a0-43a3-8a23-0ae562be1d04
        name: TwoDimensionForcer
        type: action
        action: TwoDimensionForcer

      # Dissolve geometries by feature ID to get boundaries
      - id: c93837eb-e050-46f3-9c97-66d7273fe1e5
        name: Dissolver
        type: action
        action: Dissolver
        with:
          groupBy:
            - lod
            - fileIndex
            - gmlId
            - package
          tolerance: 0.000000001

      # FeatureSorter
      - id: 0c979585-82b2-41aa-909c-00d9b8d017d0
        name: FeatureSorter
        type: action
        action: FeatureSorter
        with:
          attributes: ["package"]
          order: ascending

      # Extract geometry to attribute for later replacement
      - id: 37e634aa-67c0-4f70-8fdc-939854a3cc21
        name: GeometryExtractor
        type: action
        action: GeometryExtractor
        with:
          outputAttribute: 2d_geometry

      # Coerce to LineString to extract boundaries
      - id: 959ca2a3-0b83-4e3b-b2b7-2bf6559db2f9
        name: GeometryCoercer
        type: action
        action: GeometryCoercer
        with:
          coercerType: lineString

      # Separate LOD1 and LOD2,3
      - id: effce2ee-bc3b-4256-8efb-27622e141f05
        name: FeatureFilterLOD
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["lod"] == "1"
              outputPort: lod1
            - expr: |
                env.get("__value")["lod"] == "2" || env.get("__value")["lod"] == "3"
              outputPort: lod23

      # Detect overlaps between different Road instances for LOD1
      - id: b684d916-5efe-4dfa-be20-fed9b101239d
        name: LineOnLineOverlayerLOD1
        type: action
        action: LineOnLineOverlayer
        with:
          groupBy:
            - lod
            - package
          tolerance: 0.000000001

      # Detect overlaps between different Road instances for LOD2 and LOD3
      - id: 5dab814a-c4c6-47e0-8688-1c5667c775fb
        name: LineOnLineOverlayerLOD23
        type: action
        action: LineOnLineOverlayer
        with:
          groupBy:
            - lod
            - package
          tolerance: 0.000000001

      # Filter features with overlaps (lines that have overlap attribute > 1)
      - id: b03dfe7a-a32a-4334-90a1-23c7486576dc
        name: FilterOverlaps
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["overlayCount"] > 1
              outputPort: hasLineOverlap

      # Attach the overlap index
      - id: db59af73-a1b7-49d3-92c3-e8485cb047bd
        name: OverlapCounter
        type: action
        action: FeatureCounter
        with:
          countStart: 1
          outputAttribute: overlapIndex

      # List exploder for line-on-line overlaps
      - id: 227427f0-9267-4faa-ac6e-76e81f3ca5c2
        name: ListExploderForLineOverlaps
        type: action
        action: ListExploder
        with:
          sourceAttribute: overlaidLists

      # DuplicateFilter to remove duplicates based on gmlId
      - id: f94ccdb2-2133-4b0d-886d-9c933c0d645f
        name: DuplicateFilterLineOverlaps
        type: action
        action: AttributeDuplicateFilter
        with:
          filterBy: ["gmlId"]

      # Replace geometry from attribute
      - id: 2261a5c9-46a4-45ce-a292-d277a3dc0ebc
        name: GeometryReplacer
        type: action
        action: GeometryReplacer
        with:
          sourceAttribute: 2d_geometry

      # AreaOnAreaOverlayer to find overlapping areas
      - id: e85ef1d5-a8fb-49e8-895a-b0a055c7b4c0
        name: AreaOnAreaOverlayer
        type: action
        action: AreaOnAreaOverlayer
        with:
          groupBy:
            - overlapIndex
            - lod
            - package
          generateList: areaOverlapList
          tolerance: 0.000000001

      # Filter for overlapping areas
      - id: b0568e70-1c73-4ee0-8bae-8db3687e3d7d
        name: FilterAreaOverlaps
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["overlayCount"] > 1
              outputPort: hasAreaOverlap

      # Attach area overlap index
      - id: ee3e5022-7f8c-4b9b-ab71-cba35cab287b
        name: AreaOverlapCounter
        type: action
        action: FeatureCounter
        with:
          countStart: 0
          outputAttribute: areaOverlapIndex

      # Concatenate gmlId from each element in areaOverlapList
      - id: 8d7f5e2a-1b3c-4f9e-a7d8-3e9b6c4a2f1d
        name: ListConcatenator
        type: action
        action: ListConcatenator
        with:
          list: areaOverlapList
          attribute: gmlId
          separateCharacter: ","
          outputAttributeName: concatenatedGmlIds

      # DuplicateFilter to remove duplicates based on gmlId
      - id: 518572d2-8561-4b60-ab28-fcd66d90afa2
        name: DuplicateFilter
        type: action
        action: AttributeDuplicateFilter
        with:
          filterBy: ["concatenatedGmlIds"]

      # List exploder for area overlaps
      - id: 2ccf00f0-202b-4bf5-b2a1-0c27a0e82a37
        name: ListExploderForAreaOverlaps
        type: action
        action: ListExploder
        with:
          sourceAttribute: areaOverlapList

      # Attribute Mapper
      - id: 787f4304-c435-4d76-bd66-1fe3fb4ffc80
        name: OverlapAttributeMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: Folder
              expr: |
                env.get("__value")["package"] ?? ""
            - attribute: Index
              expr: |
                env.get("__value")["fileIndex"] ?? ""
            - attribute: Filename
              expr: |
                env.get("__value")["name"] ?? ""
            - attribute: FeatureType
              expr: |
                env.get("__value")["gmlName"] ?? ""
            - attribute: LOD
              expr: |
                env.get("__value")["lod"] ?? ""
            - attribute: "gml:id"
              expr: |
                env.get("__value")["gmlId"] ?? ""
            - attribute: "隣接ID"
              expr: |
                env.get("__value")["areaOverlapIndex"] ?? ""

      # Feature Writer
      - id: e1eb4eb2-b045-4cdb-aa43-922dd5e03a79
        name: OverlapCsvWriter
        type: action
        action: FeatureWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("outputPath"), "03_交通_隣接面重複.csv")

      # Write surface validation errors to CSV
      - id: 41bd7fb9-6e5b-4ac6-985f-a9abb40fb1c1
        name: SurfaceValidationCsvWriter
        type: action
        action: FeatureWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("outputPath"), "03_交通_面のエラー.csv")

      # ===== Error Summary Output (Phase 1-10) =====
      # Phase 1: File info extraction
      - id: eac6a0cc-0785-4a12-852c-50cdd6f94f13
        name: FileInfoExtractor
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: Index
              expr: |
                env.get("__value").fileIndex
            - attribute: Filename
              expr: |
                env.get("__value").name

      # Phase 2: Error counters - Count errors by filename for each error type
      # XLink error counter
      - id: f34d9a25-1b29-4ead-93ea-873cc5589bf1
        name: XlinkErrorCounter
        type: action
        action: StatisticsCalculator
        with:
          aggregateName: Filename
          aggregateAttribute: Filename
          calculations:
            - newAttribute: _num_unreferenced_surface
              expr: "1"

      # Orientation error counter
      - id: bb0de8b2-31f1-44ba-b996-0c8559deb61a
        name: OrientationErrorCounter
        type: action
        action: StatisticsCalculator
        with:
          aggregateName: Filename
          aggregateAttribute: Filename
          calculations:
            - newAttribute: _num_incorrect_orientation
              expr: "1"

      # Overlap error counter
      - id: 63c507b8-49e4-4e4c-a498-e997eba27e09
        name: OverlapErrorCounter
        type: action
        action: StatisticsCalculator
        with:
          aggregateName: Filename
          aggregateAttribute: Filename
          calculations:
            - newAttribute: _num_overlaps
              expr: "1"

      # Surface validation error counter
      - id: 2ca88ff0-efc6-43ca-8c2b-f17606314754
        name: SurfaceValidationErrorCounter
        type: action
        action: StatisticsCalculator
        with:
          aggregateName: Filename
          aggregateAttribute: Filename
          calculations:
            - newAttribute: _surface_issues
              expr: "1"

      # Phase 3: FeatureMerger for aggregating error counts
      - id: 71fde7fe-d34a-4318-893a-4d648c09361d
        name: ErrorSummaryMerger
        type: action
        action: FeatureMerger
        with:
          requestorAttributeValue: |
            env.get("__value").Filename
          supplierAttributeValue: |
            env.get("__value").Filename

      # Phase 4: AttributeMapper for CSV formatting
      - id: 47d5cc94-c05c-4a37-bf8a-6e1eb118b44f
        name: SummaryAttributeMapper
        type: action
        action: AttributeMapper
        with:
          mappers:
            - attribute: Index
              expr: |
                env.get("__value").Index
            - attribute: Filename
              expr: |
                env.get("__value").Filename
            - attribute: "L-TRAN-03 xlink参照エラー"
              expr: |
                env.get("__value")._num_unreferenced_surface ?? 0
            - attribute: "Z-TRAN-01 面の向き不正"
              expr: |
                env.get("__value")._num_incorrect_orientation ?? 0
            - attribute: "L-TRAN-02 隣接面重複"
              expr: |
                env.get("__value")._num_overlaps ?? 0
            - attribute: "面のエラー"
              expr: |
                env.get("__value")._surface_issues ?? 0

      # Phase 5: CSV output
      - id: be20e492-76d2-4afc-a985-e040f43d55fb
        name: CSVSummaryWriter
        type: action
        action: FeatureWriter
        with:
          format: csv
          output: |
            file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "03_交通_検査結果一覧.csv")

      # Phase 6: StatisticsCalculator for JSON aggregation
      - id: 9068494f-dee6-41ca-aef2-3e493441ece2
        name: StatisticsCalculator
        type: action
        action: StatisticsCalculator
        with:
          calculations:
            - newAttribute: "L-TRAN-03 xlink参照エラー"
              expr: |
                env.get("__value")["L-TRAN-03 xlink参照エラー"] ?? 0
            - newAttribute: "Z-TRAN-01 面の向き不正"
              expr: |
                env.get("__value")["Z-TRAN-01 面の向き不正"] ?? 0
            - newAttribute: "L-TRAN-02 隣接面重複"
              expr: |
                env.get("__value")["L-TRAN-02 隣接面重複"] ?? 0
            - newAttribute: "面のエラー"
              expr: |
                env.get("__value")["面のエラー"] ?? 0
            - newAttribute: totalErrorCount
              expr: |
                let total = 0;
                let keys = ["L-TRAN-03 xlink参照エラー", "Z-TRAN-01 面の向き不正",
                            "L-TRAN-02 隣接面重複", "面のエラー"];
                for key in keys {
                  total += env.get("__value")[key] ?? 0;
                }
                total

      # Phase 7: JSON output with converter
      - id: df88ca31-bbfd-4322-aff2-86990e91a694
        name: JSONSummaryWriter
        type: action
        action: FeatureWriter
        with:
          format: json
          converter: |
            if env.get("__features").is_empty() {
              []
            } else {
              let result = [];
              let feature = env.get("__features")[0];
              for key in feature.keys() {
                result.push(#{
                  name: key,
                  count: feature[key],
                });
              }
              result
            }
          output: |
            file::join_path(env.get("workerArtifactPath") ?? env.get("outputPath"), "summary_tran.json")

      # Phase 8: Calculate total errors for no-error check
      - id: 8afa5b80-2470-4ecf-a7b9-ae9d6185e8fb
        name: StatisticsCalculatorTotalErrors
        type: action
        action: StatisticsCalculator
        with:
          calculations:
            - newAttribute: totalErrorCount
              expr: |
                env.get("__value")["totalErrorCount"] ?? 0

      # Phase 9: Filter for no errors
      - id: c105a305-322f-4710-b999-0c8c044f264a
        name: FeatureFilterNoErrors
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value")["totalErrorCount"] == 0
              outputPort: default

      # Phase 10: Write qc_result_ok file
      - id: 6f05d51b-3587-4625-8b9d-5f0ca614eed5
        name: FileWriterQcResultOk
        type: action
        action: FileWriter
        with:
          format: json
          converter: '[]'
          output: |
            let filename = file::extract_filename_without_ext(env.get("cityGmlPath")) + "_qc_result_ok";
            let dirname = env.get("workerArtifactPath") ?? env.get("outputPath");
            file::join_path(dirname, filename)

      # Phase 11: ZipFileWriter - Bundle all output files
      - id: 02fb12bf-a5fc-4b0e-a568-178f5f3a3992
        name: ZipFileWriter
        type: action
        action: ZipFileWriter
        with:
          output: |
            let filename = file::extract_filename_without_ext(env.get("cityGmlPath")) + "_qc_result.zip";
            let dirname = env.get("workerArtifactPath") ?? env.get("outputPath");
            file::join_path(dirname, filename)

    edges:
      # Data preparation flow
      - id: 7613b326-d3d7-4fdc-b7e1-9821e120ac49
        from: f9248705-3024-40b0-b729-66507ca6640d
        to: 613c6d22-bf1c-4bbb-ba97-d85dd78d81ce
        fromPort: default
        toPort: default
      - id: 110ccc6a-0412-41f0-9e71-0ad6ee2e53c0
        from: 613c6d22-bf1c-4bbb-ba97-d85dd78d81ce
        to: 01c49595-446f-482f-94db-5027f390b6cd
        fromPort: default
        toPort: default
      - id: ecc67084-2d61-47f5-94c4-1ea30df4f6d1
        from: 01c49595-446f-482f-94db-5027f390b6cd
        to: 24286bb9-1c30-49b7-afd8-e8dc73c85ed0
        fromPort: default
        toPort: default
      - id: 9f39e824-4dd8-4adc-b2c8-ccad2979c359
        from: 24286bb9-1c30-49b7-afd8-e8dc73c85ed0
        to: c29be788-be8d-43a2-97bf-3e15228a72a1
        fromPort: default
        toPort: default
      - id: aace82c7-f1cd-4130-aeda-d21e22d97c4a
        from: c29be788-be8d-43a2-97bf-3e15228a72a1
        to: 33cb26b6-bba2-4600-ae1b-df5d7c0b4678
        fromPort: default
        toPort: default
      - id: 31d8d432-82c6-47e4-9cf2-4acafc87a848
        from: 33cb26b6-bba2-4600-ae1b-df5d7c0b4678
        to: 242e339a-c7df-4be4-82f7-3223a6ed2145
        fromPort: default
        toPort: default
      - id: 3c9b1831-266b-492b-a51f-dbf3848882c2
        from: 242e339a-c7df-4be4-82f7-3223a6ed2145
        to: 51431704-ac14-41cd-988b-88141dc6e326
        fromPort: default
        toPort: default

      # XLink detection flow
      - id: 30d1bde3-8025-47aa-983e-1f5429069aa4
        from: 33cb26b6-bba2-4600-ae1b-df5d7c0b4678
        to: 6f556405-1fdb-4807-8e3b-f18da79fbe1a
        fromPort: default
        toPort: default
      - id: e83f9f48-1a4b-4e9f-acd2-27f1b4567820
        from: 6f556405-1fdb-4807-8e3b-f18da79fbe1a
        to: 95a3af4f-4004-422b-bf86-d64181861bd5
        fromPort: failed
        toPort: default
      - id: 0fb08160-93df-4ef9-93b7-97fe0c69cb73
        from: 95a3af4f-4004-422b-bf86-d64181861bd5
        to: 737996be-8410-4447-9986-bba01fe9ce0c
        fromPort: default
        toPort: default

      # Connect LOD splitter to surface validators
      # LOD1 and LOD2 go to SurfaceValidator2D
      - id: e23edb68-8299-4a9f-a722-f82b73c82d88
        from: 51431704-ac14-41cd-988b-88141dc6e326
        to: e28b5f31-4826-4775-a343-a12ecb7f90f9
        fromPort: lod1
        toPort: default
      - id: 53ce90b4-72b4-4473-89ff-da0d0388ba85
        from: 51431704-ac14-41cd-988b-88141dc6e326
        to: e28b5f31-4826-4775-a343-a12ecb7f90f9
        fromPort: lod2
        toPort: default

      # LOD3 goes to SurfaceValidator3D
      - id: e44eff90-4ce0-4dc2-8c66-78e553ef4560
        from: 51431704-ac14-41cd-988b-88141dc6e326
        to: abf4b25e-6c1f-46fd-b5f8-07d43d137abf
        fromPort: lod3
        toPort: default

      # Connect SurfaceValidator2D invalidSurface to SurfaceValidationAttributeMapper
      - id: bf52a96b-2a23-4866-9646-1a8a7e17ade3
        from: e28b5f31-4826-4775-a343-a12ecb7f90f9
        to: d44341fa-7de4-41f5-abfd-7e0a3b1d9be8
        fromPort: invalidSurface
        toPort: default

      # Connect SurfaceValidator3D invalidSurface to SurfaceValidationAttributeMapper
      - id: 06d601c8-0bf2-4be0-b4ef-c942e2336373
        from: abf4b25e-6c1f-46fd-b5f8-07d43d137abf
        to: d44341fa-7de4-41f5-abfd-7e0a3b1d9be8
        fromPort: invalidSurface
        toPort: default

      # Connect SurfaceValidator2D incorrectOrientation to AttributeMapper (for LOD1/2)
      - id: f57856b7-7b32-4a0d-88a4-2bfadaf2f9a3
        from: e28b5f31-4826-4775-a343-a12ecb7f90f9
        to: 0740c8ce-3c27-416f-9a13-5b2086090426
        fromPort: inCorrectOrientation
        toPort: default

      # Connect SurfaceValidator3D to OrientationExtractor (for LOD3)
      - id: cf5b54cd-a548-4694-a7db-35a4d682852c
        from: abf4b25e-6c1f-46fd-b5f8-07d43d137abf
        to: d60f93c1-c55e-49ee-9332-657f4408ba05
        fromPort: inCorrectOrientation
        toPort: default

      # OrientationExtractor to Filter
      - id: 05a6d315-61a1-4021-acaa-606cb1a7435a
        from: d60f93c1-c55e-49ee-9332-657f4408ba05
        to: 1c385359-698d-40df-aed8-e8b9b0eaac67
        fromPort: default
        toPort: default

      # Filter to AttributeMapper
      - id: bbd0c116-cf6c-4f5f-b7c1-3c6011c013d3
        from: 1c385359-698d-40df-aed8-e8b9b0eaac67
        to: 0740c8ce-3c27-416f-9a13-5b2086090426
        fromPort: incorrectOrientation
        toPort: default

      # AttributeMapper to FeatureWriter
      - id: 298fa998-d16c-4d64-bfa0-05d73b250a22
        from: 0740c8ce-3c27-416f-9a13-5b2086090426
        to: 2b0d83b3-2c7a-4314-b609-e4f7db379902
        fromPort: default
        toPort: default

      # L-TRAN-02: Adjacent surface overlap detection flow
      # Connect LOD splitter to FeatureFilterExcludeRwy
      - id: 9b5b6c2f-d521-481b-a084-b2589634dc8a
        from: 51431704-ac14-41cd-988b-88141dc6e326
        to: ce7f18e8-c2cb-42e9-9b2e-9dd72f5ad964
        fromPort: lod1
        toPort: default
      - id: cc467fa8-0515-45ce-84db-0374ecdee681
        from: 51431704-ac14-41cd-988b-88141dc6e326
        to: ce7f18e8-c2cb-42e9-9b2e-9dd72f5ad964
        fromPort: lod2
        toPort: default
      - id: e5f3ce38-c40e-49f8-bbf0-597030bba716
        from: 51431704-ac14-41cd-988b-88141dc6e326
        to: ce7f18e8-c2cb-42e9-9b2e-9dd72f5ad964
        fromPort: lod3
        toPort: default

      # FeatureFilterExcludeRwy to TwoDimensionForcer
      - id: 015f1f92-0847-4057-b315-45696a12b141
        from: ce7f18e8-c2cb-42e9-9b2e-9dd72f5ad964
        to: b4d2d577-28a0-43a3-8a23-0ae562be1d04
        fromPort: notRwy
        toPort: default

      # TwoDimensionForcer to Dissolver
      - id: 9ddbf631-4454-467d-afd3-0b9002d530d6
        from: b4d2d577-28a0-43a3-8a23-0ae562be1d04
        to: c93837eb-e050-46f3-9c97-66d7273fe1e5
        fromPort: default
        toPort: default

      # Dissolver to FeatureSorter
      - id: c472919a-4b86-462f-8570-34a149f69382
        from: c93837eb-e050-46f3-9c97-66d7273fe1e5
        to: 0c979585-82b2-41aa-909c-00d9b8d017d0
        fromPort: area
        toPort: default

      # FeatureSorter to GeometryExtractor
      - id: c472919a-4b86-462f-8570-34a149f69382
        from: 0c979585-82b2-41aa-909c-00d9b8d017d0
        to: 37e634aa-67c0-4f70-8fdc-939854a3cc21
        fromPort: default
        toPort: default

      # GeometryExtractor to GeometryCoercer
      - id: 540b650d-b550-4fe5-8d72-66107fda66b2
        from: 37e634aa-67c0-4f70-8fdc-939854a3cc21
        to: 959ca2a3-0b83-4e3b-b2b7-2bf6559db2f9
        fromPort: default
        toPort: default

      # GeometryCoercer to FeatureFilterLOD
      - id: 9e5df03b-f07c-4b25-a01a-4de8dadb1a57
        from: 959ca2a3-0b83-4e3b-b2b7-2bf6559db2f9
        to: effce2ee-bc3b-4256-8efb-27622e141f05
        fromPort: default
        toPort: default

      # FeatureFilterLOD lod1 to LineOnLineOverlayerLod1
      - id: d1e30405-9e8e-4930-8f64-f80d32f72954
        from: effce2ee-bc3b-4256-8efb-27622e141f05
        to: b684d916-5efe-4dfa-be20-fed9b101239d
        fromPort: lod1
        toPort: default
      # FeatureFilterLOD lod23 to LineOnLineOverlayerLod23
      - id: 69f70254-fef9-49d2-b5b7-b318bce298e0
        from: effce2ee-bc3b-4256-8efb-27622e141f05
        to: 5dab814a-c4c6-47e0-8688-1c5667c775fb
        fromPort: lod23
        toPort: default

      # LineOnLineOverlayerLod1 to FilterOverlaps
      - id: caa8a9ba-bb76-423e-8417-4dc51c7f2daf
        from: b684d916-5efe-4dfa-be20-fed9b101239d
        to: b03dfe7a-a32a-4334-90a1-23c7486576dc
        fromPort: line
        toPort: default

      # LineOnLineOverlayerLod23 to FilterOverlaps
      - id: 73682593-5b59-48e0-9d78-2e0034e0c5b9
        from: 5dab814a-c4c6-47e0-8688-1c5667c775fb
        to: b03dfe7a-a32a-4334-90a1-23c7486576dc
        fromPort: line
        toPort: default

      # FilterOverlaps to OverlapCounter
      - id: fb3be6c3-e4b3-49ee-b814-7859c3a40b01
        from: b03dfe7a-a32a-4334-90a1-23c7486576dc
        to: db59af73-a1b7-49d3-92c3-e8485cb047bd
        fromPort: hasLineOverlap
        toPort: default

      # OverlapCounter to ListExploderForLineOverlaps
      - id: aa08478a-b937-4acd-aa88-0d907b2e8407
        from: db59af73-a1b7-49d3-92c3-e8485cb047bd
        to: 227427f0-9267-4faa-ac6e-76e81f3ca5c2
        fromPort: default
        toPort: default

      # ListExploderForLineOverlaps to GeometryReplacer
      - id: 9c4fcd1c-a5f6-425b-b11f-979f28cf249b
        from: 227427f0-9267-4faa-ac6e-76e81f3ca5c2
        to: 2261a5c9-46a4-45ce-a292-d277a3dc0ebc
        fromPort: default
        toPort: default

      # GeometryReplacer to AreaOnAreaOverlayer
      - id: d1f976e1-c4e7-480b-8e8d-576a4da88983
        from: 2261a5c9-46a4-45ce-a292-d277a3dc0ebc
        to: e85ef1d5-a8fb-49e8-895a-b0a055c7b4c0
        fromPort: default
        toPort: default

      # AreaOnAreaOverlayer to FilterAreaOverlaps
      - id: e57530a4-6c67-4fae-9994-be4f74aa74bb
        from: e85ef1d5-a8fb-49e8-895a-b0a055c7b4c0
        to: b0568e70-1c73-4ee0-8bae-8db3687e3d7d
        fromPort: area
        toPort: default

      # FilterAreaOverlaps to AreaOverlapCounter
      - id: a6f198a7-b3dd-4460-8169-6ae6679dfa5f
        from: b0568e70-1c73-4ee0-8bae-8db3687e3d7d
        to: ee3e5022-7f8c-4b9b-ab71-cba35cab287b
        fromPort: hasAreaOverlap
        toPort: default

      # AreaOverlapCounter to ListConcatenator
      - id: 1c083576-88e3-4ba0-a2c0-6ffe58400675
        from: ee3e5022-7f8c-4b9b-ab71-cba35cab287b
        to: 8d7f5e2a-1b3c-4f9e-a7d8-3e9b6c4a2f1d
        fromPort: default
        toPort: default

      # ListConcatenator to DuplicateFilter
      - id: 9f8e7d6c-5b4a-3e2d-1c0b-8a9f7e6d5c4b
        from: 8d7f5e2a-1b3c-4f9e-a7d8-3e9b6c4a2f1d
        to: 518572d2-8561-4b60-ab28-fcd66d90afa2
        fromPort: default
        toPort: default

      # DuplicateFilter to ListExploderForAreaOverlaps
      - id: 2b014ee0-e85f-4310-bcf9-0324f3d59bdc
        from: 518572d2-8561-4b60-ab28-fcd66d90afa2
        to: 2ccf00f0-202b-4bf5-b2a1-0c27a0e82a37
        fromPort: default
        toPort: default

      # ListExploderForAreaOverlaps to OverlapAttributeMapper
      - id: 41338518-c72c-47ff-b76f-956c71da692a
        from: 2ccf00f0-202b-4bf5-b2a1-0c27a0e82a37
        to: 787f4304-c435-4d76-bd66-1fe3fb4ffc80
        fromPort: default
        toPort: default

      # OverlapAttributeMapper to OverlapCsvWriter
      - id: 3ca83706-219c-4855-99ed-48219d3829bb
        from: 787f4304-c435-4d76-bd66-1fe3fb4ffc80
        to: e1eb4eb2-b045-4cdb-aa43-922dd5e03a79
        fromPort: default
        toPort: default

      # SurfaceValidationAttributeMapper to SurfaceValidationCsvWriter
      - id: 56b26bbe-2f32-463c-8ac8-233466b9063b
        from: d44341fa-7de4-41f5-abfd-7e0a3b1d9be8
        to: 41bd7fb9-6e5b-4ac6-985f-a9abb40fb1c1
        fromPort: default
        toPort: default

      # ===== Error Summary Output Edges =====
      # Phase 1: Extract file info from UDXFolderExtractor
      - id: 75db1ea3-bab6-4f15-a9dc-9c0b3496baea
        from: 33cb26b6-bba2-4600-ae1b-df5d7c0b4678  # PLATEAU4.UDXFolderExtractor
        to: eac6a0cc-0785-4a12-852c-50cdd6f94f13    # FileInfoExtractor
        fromPort: default
        toPort: default

      # Phase 2: Error counting flow
      # XLink errors: XlinkAttributeMapper -> XlinkErrorCounter
      - id: edfa0e88-a938-43ab-a88b-3264413ddee5
        from: 95a3af4f-4004-422b-bf86-d64181861bd5  # XlinkAttributeMapper
        to: f34d9a25-1b29-4ead-93ea-873cc5589bf1    # XlinkErrorCounter
        fromPort: default
        toPort: default

      # Orientation errors: AttributeMapper -> OrientationErrorCounter
      - id: f788476b-750f-4035-be69-a6e1f0386be0
        from: 0740c8ce-3c27-416f-9a13-5b2086090426  # AttributeMapper (orientation)
        to: bb0de8b2-31f1-44ba-b996-0c8559deb61a    # OrientationErrorCounter
        fromPort: default
        toPort: default

      # Overlap errors: OverlapAttributeMapper -> OverlapErrorCounter
      - id: b8461ecc-df69-424f-8d8e-40f32d1ed6b0
        from: 787f4304-c435-4d76-bd66-1fe3fb4ffc80  # OverlapAttributeMapper
        to: 63c507b8-49e4-4e4c-a498-e997eba27e09    # OverlapErrorCounter
        fromPort: default
        toPort: default

      # Surface validation errors: SurfaceValidationAttributeMapper -> SurfaceValidationErrorCounter
      - id: 40275163-aa6c-4c31-9e12-6a454a441aa6
        from: d44341fa-7de4-41f5-abfd-7e0a3b1d9be8  # SurfaceValidationAttributeMapper
        to: 2ca88ff0-efc6-43ca-8c2b-f17606314754    # SurfaceValidationErrorCounter
        fromPort: default
        toPort: default

      # Phase 3: FeatureMerger - File info (requestor) + Error counts (supplier)
      - id: f863a829-3e0c-434b-8282-20fb2854ae8b
        from: eac6a0cc-0785-4a12-852c-50cdd6f94f13  # FileInfoExtractor
        to: 71fde7fe-d34a-4318-893a-4d648c09361d    # ErrorSummaryMerger (requestor)
        fromPort: default
        toPort: requestor

      # Connect error counters to ErrorSummaryMerger (supplier port)
      - id: b770125a-aa3c-4d0f-9ac0-18fb7fc7d449
        from: f34d9a25-1b29-4ead-93ea-873cc5589bf1  # XlinkErrorCounter
        to: 71fde7fe-d34a-4318-893a-4d648c09361d    # ErrorSummaryMerger (supplier)
        fromPort: default
        toPort: supplier

      - id: 21934c03-7912-4572-8397-a1a524d695cf
        from: bb0de8b2-31f1-44ba-b996-0c8559deb61a  # OrientationErrorCounter
        to: 71fde7fe-d34a-4318-893a-4d648c09361d    # ErrorSummaryMerger (supplier)
        fromPort: default
        toPort: supplier

      - id: ed71bda2-8e79-489c-ad0d-4a6a8d2cb580
        from: 63c507b8-49e4-4e4c-a498-e997eba27e09  # OverlapErrorCounter
        to: 71fde7fe-d34a-4318-893a-4d648c09361d    # ErrorSummaryMerger (supplier)
        fromPort: default
        toPort: supplier

      - id: c91983fc-316f-4835-9fad-3eca52150bf7
        from: 2ca88ff0-efc6-43ca-8c2b-f17606314754  # SurfaceValidationErrorCounter
        to: 71fde7fe-d34a-4318-893a-4d648c09361d    # ErrorSummaryMerger (supplier)
        fromPort: default
        toPort: supplier

      # Phase 4: Merged and unmerged results to AttributeMapper
      - id: 93acdb8c-7952-4533-89f8-c359ab5172aa
        from: 71fde7fe-d34a-4318-893a-4d648c09361d  # ErrorSummaryMerger
        to: 47d5cc94-c05c-4a37-bf8a-6e1eb118b44f    # SummaryAttributeMapper
        fromPort: merged
        toPort: default

      - id: f8a414c1-bd6a-44bb-a87e-8bf12ae74055
        from: 71fde7fe-d34a-4318-893a-4d648c09361d  # ErrorSummaryMerger
        to: 47d5cc94-c05c-4a37-bf8a-6e1eb118b44f    # SummaryAttributeMapper
        fromPort: unmerged
        toPort: default

      # Phase 5: CSV output
      - id: 2ea19a9a-f3b5-4ab2-84ba-6ee07853d27a
        from: 47d5cc94-c05c-4a37-bf8a-6e1eb118b44f  # SummaryAttributeMapper
        to: be20e492-76d2-4afc-a985-e040f43d55fb    # CSVSummaryWriter
        fromPort: default
        toPort: default

      # Phase 6: StatisticsCalculator for JSON aggregation
      - id: 8a5c90d6-2b7c-4828-968c-5d66e0a9a64e
        from: 47d5cc94-c05c-4a37-bf8a-6e1eb118b44f  # SummaryAttributeMapper
        to: 9068494f-dee6-41ca-aef2-3e493441ece2    # StatisticsCalculator
        fromPort: default
        toPort: default

      # Phase 7: JSON output
      - id: 6f64d3d9-f3f7-4ff6-833c-eae4b69c6da2
        from: 9068494f-dee6-41ca-aef2-3e493441ece2  # StatisticsCalculator
        to: df88ca31-bbfd-4322-aff2-86990e91a694    # JSONSummaryWriter
        fromPort: default
        toPort: default

      # Phase 8-10: qc_result_ok generation flow
      - id: c49be938-7dfc-4674-9213-2676cc26f0c5
        from: 9068494f-dee6-41ca-aef2-3e493441ece2  # StatisticsCalculator
        to: 8afa5b80-2470-4ecf-a7b9-ae9d6185e8fb    # StatisticsCalculatorTotalErrors
        fromPort: default
        toPort: default

      - id: 454c080f-90b1-4947-b232-d8a095d964b5
        from: 8afa5b80-2470-4ecf-a7b9-ae9d6185e8fb  # StatisticsCalculatorTotalErrors
        to: c105a305-322f-4710-b999-0c8c044f264a    # FeatureFilterNoErrors
        fromPort: default
        toPort: default

      - id: 8f5e3ef3-8a3b-479b-a391-d7825374c1ab
        from: c105a305-322f-4710-b999-0c8c044f264a  # FeatureFilterNoErrors
        to: 6f05d51b-3587-4625-8b9d-5f0ca614eed5    # FileWriterQcResultOk
        fromPort: default
        toPort: default

      # Phase 11: ZipFileWriter Connections - Bundle all output files
      # Connect CSVSummaryWriter to ZipFileWriter
      - id: 26c2676e-00b1-4a87-b7b5-21a2b60131d1
        from: be20e492-76d2-4afc-a985-e040f43d55fb  # CSVSummaryWriter
        to: 02fb12bf-a5fc-4b0e-a568-178f5f3a3992    # ZipFileWriter
        fromPort: default
        toPort: default

      # Connect JSONSummaryWriter to ZipFileWriter
      - id: 0491c7c1-9b70-43af-af23-f9e711a81408
        from: df88ca31-bbfd-4322-aff2-86990e91a694  # JSONSummaryWriter
        to: 02fb12bf-a5fc-4b0e-a568-178f5f3a3992    # ZipFileWriter
        fromPort: default
        toPort: default

      # Connect XlinkCsvWriter to ZipFileWriter
      - id: 83a79efd-1131-4f54-83b7-d3a923195f07
        from: 737996be-8410-4447-9986-bba01fe9ce0c  # XlinkCsvWriter
        to: 02fb12bf-a5fc-4b0e-a568-178f5f3a3992    # ZipFileWriter
        fromPort: default
        toPort: default

      # Connect CsvWriter (orientation) to ZipFileWriter
      - id: c2b7112c-8b89-458a-ba93-908b844d2fce
        from: 2b0d83b3-2c7a-4314-b609-e4f7db379902  # CsvWriter (orientation)
        to: 02fb12bf-a5fc-4b0e-a568-178f5f3a3992    # ZipFileWriter
        fromPort: default
        toPort: default

      # Connect OverlapCsvWriter to ZipFileWriter
      - id: 496536ab-a092-4817-8467-8992635fbe87
        from: e1eb4eb2-b045-4cdb-aa43-922dd5e03a79  # OverlapCsvWriter
        to: 02fb12bf-a5fc-4b0e-a568-178f5f3a3992    # ZipFileWriter
        fromPort: default
        toPort: default

      # Connect SurfaceValidationCsvWriter to ZipFileWriter
      - id: 0f6e2287-9318-422c-9b4c-494e873d996e
        from: 41bd7fb9-6e5b-4ac6-985f-a9abb40fb1c1  # SurfaceValidationCsvWriter
        to: 02fb12bf-a5fc-4b0e-a568-178f5f3a3992    # ZipFileWriter
        fromPort: default
        toPort: default