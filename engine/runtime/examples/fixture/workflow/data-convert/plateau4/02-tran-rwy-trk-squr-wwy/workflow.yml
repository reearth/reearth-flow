# yaml-language-server: $schema=https://raw.githubusercontent.com/reearth/reearth-flow/main/engine/schema/workflow.json
id: d6a556db-dfac-4ca1-9275-c490ef2d1ad8
name: "PLATEAU4-DataConvert-02-tran-rwy-trk-squr-wwy"
entryGraphId: 34bf873b-3364-46b0-8153-efeb9568bb3c
with:
  cityGmlPath:
  cityCode:
  codelistsPath:
  schemasPath:
  targetPackages:
    - tran
    - rwy
    - trk
    - squr
    - wwy
  outputPath:
graphs:
  - !include ../../../../graphs/plateau4/folder_and_file_path_reader.yml
  - id: 2bb6aed2-b4eb-4192-8d2a-d1f1f4dbf878
    name: PLATEAU4.LodSplitterWithDM
    nodes:
      - id: ac4d1c78-d41e-42f0-add9-257546b9f7f3
        name: InputRouter
        type: action
        action: InputRouter
        with:
          routingPort: default
      
      - id: e619bb44-2002-48a1-9913-7759967ebb71
        name: DmSplit
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__feature_type") == "uro:DmGeometricAttribute"
              outputPort: DmGeometricAttribute

      - id: 074348e3-37b3-402a-8d71-ba3c14f70cde
        name: FeatureFilterByLod
        type: action
        action: FeatureFilter
        with:
          conditions:
            - expr: |
                env.get("__value").lod == "0"
              outputPort: lod0
            - expr: |
                env.get("__value").lod == "1"
              outputPort: lod1
            - expr: |
                env.get("__value").lod == "2"
              outputPort: lod2
            - expr: |
                env.get("__value").lod == "3"
              outputPort: lod3
            - expr: |
                env.get("__value").lod == "4"
              outputPort: lod4

      - id: 99d63efa-503b-460d-aa03-3ee64b7cb8c6
        name: DmGeometricAttributeRouter
        type: action
        action: OutputRouter
        with:
          routingPort: DmGeometricAttribute

      - id: 817bd315-ed17-463d-8e1d-dd73ee580038
        name: Lod0Router
        type: action
        action: OutputRouter
        with:
          routingPort: lod0

      - id: 5f41eaa6-ec16-4779-a0bb-3125c7f5b64e
        name: Lod1Router
        type: action
        action: OutputRouter
        with:
          routingPort: lod1

      - id: 9404228a-2385-437f-b3df-82717685b003
        name: Lod2Router
        type: action
        action: OutputRouter
        with:
          routingPort: lod2

      - id: 54ae1ee3-c3d1-4f8b-9f7c-1a98e04d87f3
        name: Lod3Router
        type: action
        action: OutputRouter
        with:
          routingPort: lod3

      - id: dcbcf260-4eb9-438d-99f5-5452926604ee
        name: Lod4Router
        type: action
        action: OutputRouter
        with:
          routingPort: lod4

    edges:
      - id: a1b2c3d4-e5f6-7a8b-9c0d-1e2f3a4b5c6d
        from: ac4d1c78-d41e-42f0-add9-257546b9f7f3
        to: e619bb44-2002-48a1-9913-7759967ebb71
        fromPort: default
        toPort: default
      - id: a07d260b-46c8-4660-b6d7-b8e9b9db1291
        from: e619bb44-2002-48a1-9913-7759967ebb71
        to: 074348e3-37b3-402a-8d71-ba3c14f70cde
        fromPort: unfiltered
        toPort: default
      - id: aae790c3-bdf3-4a97-a5ff-d665d82474c4
        from: e619bb44-2002-48a1-9913-7759967ebb71
        to: 99d63efa-503b-460d-aa03-3ee64b7cb8c6
        fromPort: DmGeometricAttribute
        toPort: default
      - id: b2c3d4e5-f6a7-8b9c-0d1e-2f3a4b5c6d7e
        from: 074348e3-37b3-402a-8d71-ba3c14f70cde
        to: 817bd315-ed17-463d-8e1d-dd73ee580038
        fromPort: lod0
        toPort: default
      - id: c3d4e5f6-a7b8-9c0d-1e2f-3a4b5c6d7e8f
        from: 074348e3-37b3-402a-8d71-ba3c14f70cde
        to: 5f41eaa6-ec16-4779-a0bb-3125c7f5b64e
        fromPort: lod1
        toPort: default
      - id: d4e5f6a7-b8c9-0d1e-2f3a-4b5c6d7e8f9a
        from: 074348e3-37b3-402a-8d71-ba3c14f70cde
        to: 9404228a-2385-437f-b3df-82717685b003
        fromPort: lod2
        toPort: default
      - id: e5f6a7b8-c9d0-1e2f-3a4b-5c6d7e8f9a0b
        from: 074348e3-37b3-402a-8d71-ba3c14f70cde
        to: 54ae1ee3-c3d1-4f8b-9f7c-1a98e04d87f3
        fromPort: lod3
        toPort: default
      - id: f6a7b8c9-d0e1-2f3a-4b5c-6d7e8f9a0b1c
        from: 074348e3-37b3-402a-8d71-ba3c14f70cde
        to: dcbcf260-4eb9-438d-99f5-5452926604ee
        fromPort: lod4
        toPort: default

  - id: 34bf873b-3364-46b0-8153-efeb9568bb3c
    name: entry_point
    nodes:
      - id: 90f40a3e-61d3-48e2-a328-e7226c2ad1ae
        name: FeatureCreator
        type: action
        action: FeatureCreator
        with:
          creator: |
            [
              #{
                cityGmlPath: env.get("cityGmlPath"),
                cityCode: env.get("cityCode") ?? file::extract_filename(env.get("cityGmlPath"))[0..5],
              },
            ]

      - id: d376f32b-7ce8-4721-8b9e-bfa39d71b860
        name: FolderAndFilePathReader
        type: subGraph
        subGraphId: c6863b71-953b-4d15-af56-396fc93fc617

      - id: ded2e272-e05c-4918-86b3-aa9f763da6e6
        name: FeatureReaderByCityGml
        type: action
        action: FeatureCityGmlReader
        with:
          format: citygml
          flatten: true
          dataset: |
            env.get("__value")["path"]

      - id: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6e
        name: AttributeManagerPreFlattener
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: meshcode
              method: create
              value: |
                let file = file::extract_filename(env.get("__value")["path"]);
                file.split("_")[0]
            - attribute: gml_id
              method: create
              value: |
                env.get("__feature_id") ?? env.get("__value")["gmlId"]
            - attribute: feature_type
              method: create
              value: env.get("__value")["featureType"] ?? env.get("__value")["gmlName"]

      - id: 5daabfc0-2bda-4f8d-b206-d7a388469f7a
        name: AttributeFlattener
        type: action
        action: PLATEAU4.AttributeFlattener

      - id: c32a279d-97be-4584-b282-4d65627b1132
        name: LodSplitterWithDM
        type: subGraph
        subGraphId: 2bb6aed2-b4eb-4192-8d2a-d1f1f4dbf878

      - id: 8f3a2b1c-4d5e-6f7a-8b9c-0d1e2f3a4b5c
        name: FeatureTypeFilterTrafficArea
        type: action
        action: FeatureTypeFilter
        with:
          targetTypes:
            - "tran:TrafficArea"
            - "tran:AuxiliaryTrafficArea"

      - id: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d
        name: FeatureTypeFilterTrafficAreaLod3
        type: action
        action: FeatureTypeFilter
        with:
          targetTypes:
            - "tran:TrafficArea"
            - "tran:AuxiliaryTrafficArea"

      - id: 3e4f5a6b-7c8d-9e0f-1a2b-3c4d5e6f7a8b
        name: VerticalReprojectorLod3
        type: action
        action: VerticalReprojector
        with:
          reprojectorType: jgd2011ToWgs84

      - id: 5f6a7b8c-9d0e-1f2a-3b4c-5d6e7f8a9b0c
        name: AttributeManagerByLod3
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: cityCode
              method: rename
              value: city_code
            - attribute: cityName
              method: rename
              value: city_name
            - attribute: lod
              method: remove
            - attribute: gmlId
              method: remove
            - attribute: fileIndex
              method: remove
            - attribute: root
              method: remove
            - attribute: cityGmlPath
              method: remove
            - attribute: admin
              method: remove
            - attribute: area
              method: remove
            - attribute: package
              method: remove
            - attribute: extension
              method: remove
            - attribute: dirRoot
              method: remove
            - attribute: gmlRootId
              method: remove
            - attribute: maxLod
              method: remove
            - attribute: dirSchemas
              method: remove
            - attribute: dirCodelists
              method: remove
            - attribute: path
              method: remove
            - attribute: name
              method: remove
            - attribute: udxDirs
              method: remove
            - attribute: featureType
              method: remove
            - attribute: gmlName
              method: remove

      - id: 4f5a6b7c-8d9e-0f1a-2b3c-4d5e6f7a8b9c
        name: Cesium3DTilesWriterLod3
        type: action
        action: Cesium3DTilesWriter
        with:
          minZoom: 15
          maxZoom: 18
          attachTexture: false
          dracoCompression: false
          output: |
            file::join_path(env.get("outputPath"), "tran_lod3")

      - id: 2ccf7b99-4123-446e-8ff7-049be1c604c7
        name: AttributeManagerByLod0-2
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: cityCode
              method: rename
              value: city_code
            - attribute: cityName
              method: rename
              value: city_name
            - attribute: lod
              method: rename
              value: _lod
            - attribute: gmlId
              method: remove
            - attribute: fileIndex
              method: remove
            - attribute: root
              method: remove
            - attribute: cityGmlPath
              method: remove
            - attribute: admin
              method: remove
            - attribute: area
              method: remove
            - attribute: package
              method: remove
            - attribute: extension
              method: remove
            - attribute: dirRoot
              method: remove
            - attribute: gmlRootId
              method: remove
            - attribute: maxLod
              method: remove
            - attribute: dirSchemas
              method: remove
            - attribute: dirCodelists
              method: remove
            - attribute: path
              method: remove
            - attribute: name
              method: remove
            - attribute: udxDirs
              method: rename
              value: _udxDirs
            - attribute: featureType
              method: remove
            - attribute: gmlName
              method: remove

      - id: 1f8b3c4e-5a2d-4e1f-9b7c-3d5e6f8a9b0c
        name: FeatureSorter
        type: action
        action: FeatureSorter
        with:
          attributes:
            # sorting is required by MVT writer and dissolver
            # must sort by output path, not feature type
            - _udxDirs
            - _lod
          order: ascending

      # corresponding to FME's 2DForcer_lod0-2
      - id: 8a9b7c6d-5e4f-3a2b-1c0d-9e8f7a6b5c4d
        name: TwoDimensionForcer
        type: action
        action: TwoDimensionForcer

      # Filter geometry types: polygons go to Dissolver, linestrings bypass
      - id: 6f7a8b9c-0d1e-2f3a-4b5c-6d7e8f9a0b1c
        name: GeometryFilter
        type: action
        action: GeometryFilter
        with:
          filterType: geometryType

      # Dissolve polygons in MultiPolygon, due to the bug it is temporarily disabled
      # - id: 9f8e7d6c-5b4a-3c2d-1e0f-8a9b7c6d5e4f
      #   name: Dissolver
      #   type: action
      #   action: Dissolver
      #   with:
      #     groupBy:
      #       - gml_id
      #       - _udxDirs
      #       - _lod
      #     attributeAccumulationMode: useOne

      - id: b4c8d9e0-f1a2-3b4c-5d6e-7f8a9b0c1d2e
        name: FeatureSorterPreMVT
        type: action
        action: FeatureSorter
        with:
          attributes:
            - _udxDirs
            - _lod
            - feature_type
          order: ascending

      - id: 7a17c4f9-dd4d-44b0-936c-50c394272016
        name: MVTWriter
        type: action
        action: MVTWriter
        with:
          layerName: |
            env.get("__value").feature_type.split(":")[1]
          minZoom: 8
          maxZoom: 16
          output: |
            file::join_path(env.get("outputPath"), env.get("__value")._udxDirs + "_lod" + env.get("__value")._lod)
          skipUnderscorePrefix: true
          colonToUnderscore: true

      - id: a1b2c3d4-e5f6-7890-abcd-ef1234567890
        name: AttributeManagerByDmGeometricAttribute
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: cityCode
              method: rename
              value: city_code
            - attribute: cityName
              method: rename
              value: city_name
            - attribute: lod
              method: remove
            - attribute: gmlId
              method: remove
            - attribute: fileIndex
              method: remove
            - attribute: root
              method: remove
            - attribute: cityGmlPath
              method: remove
            - attribute: admin
              method: remove
            - attribute: area
              method: remove
            - attribute: package
              method: remove
            - attribute: extension
              method: remove
            - attribute: dirRoot
              method: remove
            - attribute: gmlRootId
              method: remove
            - attribute: maxLod
              method: remove
            - attribute: dirSchemas
              method: remove
            - attribute: dirCodelists
              method: remove
            - attribute: path
              method: remove
            - attribute: name
              method: remove
            - attribute: udxDirs
              method: rename
              value: _udxDirs
            - attribute: featureType
              method: remove
            - attribute: gmlName
              method: remove

      - id: b2c3d4e5-f6a7-8901-bcde-f12345678901
        name: FeatureSorterDmGeometricAttribute
        type: action
        action: FeatureSorter
        with:
          attributes:
            - _udxDirs
          order: ascending

      - id: c3d4e5f6-a7b8-9012-cdef-123456789012
        name: TwoDimensionForcerDmGeometricAttribute
        type: action
        action: TwoDimensionForcer

      - id: d4e5f6a7-b8c9-0123-def1-234567890123
        name: MVTWriterDmGeometricAttribute
        type: action
        action: MVTWriter
        with:
          layerName: |
            env.get("__value").feature_type.split(":")[1]
          minZoom: 8
          maxZoom: 16
          output: |
            file::join_path(env.get("outputPath"), env.get("__value")._udxDirs + "_dm_geometric_attributes")
          skipUnderscorePrefix: true
          colonToUnderscore: true

    edges:
      - id: 5ebf24ab-1d98-49d5-8f58-eb7c18d27244
        from: 90f40a3e-61d3-48e2-a328-e7226c2ad1ae
        to: d376f32b-7ce8-4721-8b9e-bfa39d71b860
        fromPort: default
        toPort: default
      - id: 64196428-ea1b-4177-9d66-28331fad14f8
        from: d376f32b-7ce8-4721-8b9e-bfa39d71b860
        to: ded2e272-e05c-4918-86b3-aa9f763da6e6
        fromPort: default
        toPort: default
      - id: cf845867-6ffc-4b83-9fd5-e376a22470e2
        from: ded2e272-e05c-4918-86b3-aa9f763da6e6
        to: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6e
        fromPort: default
        toPort: default
      - id: 7e8f9a0b-1c2d-3e4f-5a6b-7c8d9e0f1a2b
        from: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6e
        to: 5daabfc0-2bda-4f8d-b206-d7a388469f7a
        fromPort: default
        toPort: default
      - id: ad52c3e6-68ff-4844-a7b2-d302fc0aef14
        from: 5daabfc0-2bda-4f8d-b206-d7a388469f7a
        to: c32a279d-97be-4584-b282-4d65627b1132
        fromPort: default
        toPort: default
      - id: 90f518e2-3ca0-404f-821c-5dffe4e57597
        from: c32a279d-97be-4584-b282-4d65627b1132
        to: 2ccf7b99-4123-446e-8ff7-049be1c604c7
        fromPort: lod0
        toPort: default
      - id: 83c68df9-a61b-4cad-8f64-ea20186e9db1
        from: c32a279d-97be-4584-b282-4d65627b1132
        to: 2ccf7b99-4123-446e-8ff7-049be1c604c7
        fromPort: lod1
        toPort: default
      - id: 7303c673-ccf3-4075-9eec-97176ced4b86
        from: c32a279d-97be-4584-b282-4d65627b1132
        to: 8f3a2b1c-4d5e-6f7a-8b9c-0d1e2f3a4b5c
        fromPort: lod2
        toPort: default
      - id: 9a8b7c6d-5e4f-3a2b-1c0d-9e8f7a6b5c4d
        from: 8f3a2b1c-4d5e-6f7a-8b9c-0d1e2f3a4b5c
        to: 2ccf7b99-4123-446e-8ff7-049be1c604c7
        fromPort: default
        toPort: default
      - id: 2b3c4d5e-6f7a-8b9c-0d1e-2f3a4b5c6d7e
        from: c32a279d-97be-4584-b282-4d65627b1132
        to: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d
        fromPort: lod3
        toPort: default
      - id: 7d8e9f0a-1b2c-3d4e-5f6a-7b8c9d0e1f2a
        from: 1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d
        to: 3e4f5a6b-7c8d-9e0f-1a2b-3c4d5e6f7a8b
        fromPort: default
        toPort: default
      - id: 8e9f0a1b-2c3d-4e5f-6a7b-8c9d0e1f2a3b
        from: 3e4f5a6b-7c8d-9e0f-1a2b-3c4d5e6f7a8b
        to: 5f6a7b8c-9d0e-1f2a-3b4c-5d6e7f8a9b0c
        fromPort: default
        toPort: default
      - id: 9f0a1b2c-3d4e-5f6a-7b8c-9d0e1f2a3b4c
        from: 5f6a7b8c-9d0e-1f2a-3b4c-5d6e7f8a9b0c
        to: 4f5a6b7c-8d9e-0f1a-2b3c-4d5e6f7a8b9c
        fromPort: default
        toPort: default
      - id: 841f1bed-a4d3-4425-a754-4f0dd7461ead
        from: 2ccf7b99-4123-446e-8ff7-049be1c604c7
        to: 1f8b3c4e-5a2d-4e1f-9b7c-3d5e6f8a9b0c
        fromPort: default
        toPort: default
      - id: 3c7d9e2f-4a5b-6c8d-9e0f-1a2b3c4d5e6f
        from: 1f8b3c4e-5a2d-4e1f-9b7c-3d5e6f8a9b0c
        to: 8a9b7c6d-5e4f-3a2b-1c0d-9e8f7a6b5c4d
        fromPort: default
        toPort: default
      # TwoDimensionForcer -> GeometryFilter
      - id: 5b6c7d8e-9f0a-1b2c-3d4e-5f6a7b8c9d0e
        from: 8a9b7c6d-5e4f-3a2b-1c0d-9e8f7a6b5c4d
        to: 6f7a8b9c-0d1e-2f3a-4b5c-6d7e8f9a0b1c
        fromPort: default
        toPort: default
      # GeometryFilter (polygon) -> Dissolver (temporarily disabled)
      - id: 8d9e0f1a-2b3c-4d5e-6f7a-8b9c0d1e2f3a
        from: 6f7a8b9c-0d1e-2f3a-4b5c-6d7e8f9a0b1c
      #   to: 9f8e7d6c-5b4a-3c2d-1e0f-8a9b7c6d5e4f
        fromPort: surface
      #   toPort: default
      # # Dissolver -> FeatureSorterPreMVT
      # - id: 4d5e6f7a-8b9c-0d1e-2f3a-4b5c6d7e8f9a
      #   from: 9f8e7d6c-5b4a-3c2d-1e0f-8a9b7c6d5e4f
        to: b4c8d9e0-f1a2-3b4c-5d6e-7f8a9b0c1d2e
      #  fromPort: area
        toPort: default
      # GeometryFilter (linestrings) -> FeatureSorterPreMVT
      - id: 9e0f1a2b-3c4d-5e6f-7a8b-9c0d1e2f3a4b
        from: 6f7a8b9c-0d1e-2f3a-4b5c-6d7e8f9a0b1c
        to: b4c8d9e0-f1a2-3b4c-5d6e-7f8a9b0c1d2e
        fromPort: curve
        toPort: default
      # FeatureSorterPreMVT -> MVTWriter
      - id: c1d2e3f4-5a6b-7c8d-9e0f-1a2b3c4d5e6f
        from: b4c8d9e0-f1a2-3b4c-5d6e-7f8a9b0c1d2e
        to: 7a17c4f9-dd4d-44b0-936c-50c394272016
        fromPort: default
        toPort: default
      # DmGeometricAttribute flow: LodSplitterWithDM -> AttributeManagerByDmGeometricAttribute
      - id: e1f2a3b4-c5d6-7e8f-9a0b-1c2d3e4f5a6b
        from: c32a279d-97be-4584-b282-4d65627b1132
        to: a1b2c3d4-e5f6-7890-abcd-ef1234567890
        fromPort: DmGeometricAttribute
        toPort: default
      # AttributeManagerByDmGeometricAttribute -> FeatureSorterDmGeometricAttribute
      - id: f2a3b4c5-d6e7-8f9a-0b1c-2d3e4f5a6b7c
        from: a1b2c3d4-e5f6-7890-abcd-ef1234567890
        to: b2c3d4e5-f6a7-8901-bcde-f12345678901
        fromPort: default
        toPort: default
      # FeatureSorterDmGeometricAttribute -> TwoDimensionForcerDmGeometricAttribute
      - id: a3b4c5d6-e7f8-9a0b-1c2d-3e4f5a6b7c8d
        from: b2c3d4e5-f6a7-8901-bcde-f12345678901
        to: c3d4e5f6-a7b8-9012-cdef-123456789012
        fromPort: default
        toPort: default
      # TwoDimensionForcerDmGeometricAttribute -> MVTWriterDmGeometricAttribute
      - id: b4c5d6e7-f8a9-0b1c-2d3e-4f5a6b7c8d9e
        from: c3d4e5f6-a7b8-9012-cdef-123456789012
        to: d4e5f6a7-b8c9-0123-def1-234567890123
        fromPort: default
        toPort: default