id: cd93ce74-eff8-479c-abec-f8a1bc24cbda
name: PLATEAU4-DataConvert-05-fld-workflow
entryGraphId: 6f9f1383-8a50-4a22-b815-5d06a9f9398a
with:
  cityGmlPath: null
  cityCode: null
  codelistsPath: null
  schemasPath: null
  codelists: null
  schemas: null
  targetPackages:
  - fld
  - tnm
  - htd
  - ifld
  - rfld
  workerArtifactPath: null
graphs:
- id: c6863b71-953b-4d15-af56-396fc93fc617
  name: FolderAndfilePathReader
  nodes:
  - id: 35038d96-5e81-4a21-a0e0-72f67eb71db5
    name: InputRouter
    type: action
    action: InputRouter
    with:
      routingPort: default
  - id: c7315341-26b3-4405-9d02-039d721cd225
    name: DirectoryDecompressor
    type: action
    action: DirectoryDecompressor
    with:
      archiveAttributes:
      - codelists
      - schemas
      findDeepestSingleFolder: true
  - id: c73fbb78-74ca-490e-8dc9-e9fa1729bea0
    name: FeatureFilePathExtractor
    type: action
    action: FeatureFilePathExtractor
    with:
      sourceDataset: |
        env.get("__value").cityGmlPath
      extractArchive: true
  - id: 9d04983e-e84e-4622-b0c6-827d7afad720
    name: FeatureFilter
    type: action
    action: FeatureFilter
    with:
      conditions:
      - expr: |
          env.get("__value").extension == "gml"
        outputPort: default
  - id: 712e4c72-950d-466d-9598-19f299668e7e
    name: PLATEAU4.UDXFolderExtractor
    type: action
    action: PLATEAU4.UDXFolderExtractor
    with:
      cityGmlPath: |
        env.get("__value")["path"]
      codelistsPath: codelists
      schemasPath: schemas
  - id: a1554a74-3caa-4880-a4a3-6dc4ab526a13
    name: FeatureFilterByPackage
    type: action
    action: FeatureFilter
    with:
      conditions:
      - expr: |
          (env.get("targetPackages") ?? []).is_empty() || env.get("__value")["package"] in env.get("targetPackages")
        outputPort: default
  - id: f3465c78-59fa-4307-bc02-67c46c2ddd98
    name: FeatureCounterByUdxDirs
    type: action
    action: FeatureCounter
    with:
      countStart: 1
      groupBy:
      - udxDirs
      outputAttribute: fileIndex
  - id: 7bad5b43-6e59-4f6b-95c4-b3043d2b950d
    name: CityCodeExtractor
    type: action
    action: PLATEAU4.CityCodeExtractor
    with:
      codelistsPathAttribute: dirCodelists
      cityCodeAttribute: cityCode
  - id: 9fccbcdb-ab58-4fda-9a47-05a45c84a7fb
    name: OutputRouter
    type: action
    action: OutputRouter
    with:
      routingPort: default
  edges:
  - id: 5d700a9c-1537-442e-bfb2-0728a9e1ec9c
    from: 35038d96-5e81-4a21-a0e0-72f67eb71db5
    to: c7315341-26b3-4405-9d02-039d721cd225
    fromPort: default
    toPort: default
  - id: 749d8e90-dbc3-4fc9-bfee-046344f5f5b9
    from: c7315341-26b3-4405-9d02-039d721cd225
    to: c73fbb78-74ca-490e-8dc9-e9fa1729bea0
    fromPort: default
    toPort: default
  - id: 1379a497-9e4e-40fb-8361-d2eeeb491762
    from: c73fbb78-74ca-490e-8dc9-e9fa1729bea0
    to: 9d04983e-e84e-4622-b0c6-827d7afad720
    fromPort: default
    toPort: default
  - id: 2379a497-9e4e-40fb-8361-d2eeeb491763
    from: 9d04983e-e84e-4622-b0c6-827d7afad720
    to: 712e4c72-950d-466d-9598-19f299668e7e
    fromPort: default
    toPort: default
  - id: 2379a497-9e4e-40fb-8361-d2eeeb491764
    from: 712e4c72-950d-466d-9598-19f299668e7e
    to: a1554a74-3caa-4880-a4a3-6dc4ab526a13
    fromPort: default
    toPort: default
  - id: 2379a497-9e4e-40fb-8361-d2eeeb491766
    from: a1554a74-3caa-4880-a4a3-6dc4ab526a13
    to: f3465c78-59fa-4307-bc02-67c46c2ddd98
    fromPort: default
    toPort: default
  - id: 0f43aebf-caf7-4f07-be97-f23b9c2c585f
    from: f3465c78-59fa-4307-bc02-67c46c2ddd98
    to: 7bad5b43-6e59-4f6b-95c4-b3043d2b950d
    fromPort: default
    toPort: default
  - id: 80462b53-a06a-4e0b-bed8-07dcda744a55
    from: 7bad5b43-6e59-4f6b-95c4-b3043d2b950d
    to: 9fccbcdb-ab58-4fda-9a47-05a45c84a7fb
    fromPort: default
    toPort: default
- id: 6f9f1383-8a50-4a22-b815-5d06a9f9398a
  name: entry_point
  nodes:
  - id: 90f40a3e-61d3-48e2-a328-e7226c2ad1ae
    name: FeatureCreator
    type: action
    action: FeatureCreator
    with:
      creator: |
        [
          #{
            cityGmlPath: env.get("cityGmlPath"),
            cityCode: env.get("cityCode") ?? file::extract_filename(env.get("cityGmlPath"))[0..5],
            codelists: env.get("codelistsPath") ?? env.get("codelists"),
            schemas: env.get("schemasPath") ?? env.get("schemas"),
          },
        ]
  - id: d376f32b-7ce8-4721-8b9e-bfa39d71b860
    name: FolderAndFilePathReader
    type: subGraph
    subGraphId: c6863b71-953b-4d15-af56-396fc93fc617
  - id: ded2e272-e05c-4918-86b3-aa9f763da6e6
    name: FeatureReaderByCityGml
    type: action
    action: FeatureCityGmlReader
    with:
      codelistsPath: env.get("__value").codelists
      flatten: true
      dataset: |
        env.get("__value")["path"]
  - id: e2441531-649a-4dcd-916f-ac59f7d56de3
    name: AttributeManagerPreFlattener
    type: action
    action: AttributeManager
    with:
      operations:
      - attribute: feature_type
        method: create
        value: env.get("__value")["featureType"] ?? env.get("__value")["gmlName"]
      - attribute: codelists
        method: remove
      - attribute: schemas
        method: remove
  - id: 6e5ed9fc-006e-4dbe-8699-4663dba795cb
    name: AttributeFlattener
    type: action
    action: PLATEAU4.AttributeFlattener
  - id: 20cb127d-fc8a-4921-8ab6-0f88438eb9e0
    name: AttributeMapper
    type: action
    action: AttributeMapper
    with:
      mappers:
      - attribute: city_code
        valueAttribute: cityCode
      - attribute: city_name
        valueAttribute: cityName
      - attribute: feature_type
        valueAttribute: feature_type
      - attribute: attributes
        valueAttribute: attributes
      - attribute: gml:name
        valueAttribute: gml:name
      - attribute: core:creationDate
        valueAttribute: core:creationDate
      - attribute: wtr:class
        valueAttribute: wtr:class
      - attribute: wtr:function
        valueAttribute: wtr:function
      - attribute: uro:description
        valueAttribute: uro:description
      - attribute: uro:rank
        valueAttribute: uro:rank
      - attribute: uro:rank_code
        valueAttribute: uro:rank_code
      - attribute: uro:rankOrg
        valueAttribute: uro:rankOrg
      - attribute: uro:rankOrg_code
        valueAttribute: uro:rankOrg_code
      - attribute: uro:adminType
        valueAttribute: uro:adminType
      - attribute: uro:scale
        valueAttribute: uro:scale
      - attribute: uro:geometrySrcDescLod1
        valueAttribute: uro:geometrySrcDescLod1
      - attribute: __package
        valueAttribute: package
      - attribute: __name
        valueAttribute: name
      - attribute: __udxDirs
        valueAttribute: udxDirs
  - id: 8b05f9d4-1cb2-4071-a1da-c968431bc0ec
    name: VerticalReprojector
    type: action
    action: VerticalReprojector
    with:
      reprojectorType: jgd2011ToWgs84
  - id: 3f7a8b2c-4d9e-5a1f-6b3c-7d8e9f0a1b2c
    name: FloodingAreaSurfaceGenerator
    type: action
    action: PLATEAU4.FloodingAreaSurfaceGenerator
  - id: b4862d31-4bb2-49b1-8f0d-6d58dd4cb385
    name: Cesium3DTilesWriterNoTexture
    type: action
    action: Cesium3DTilesWriter
    with:
      minZoom: 15
      maxZoom: 18
      attachTexture: false
      skipUnexposedAttributes: true
      output: |
        let udx_dirs = env.get("__value")["__udxDirs"];
        udx_dirs.replace("/", "_");
        file::join_path(env.get("workerArtifactPath"), udx_dirs + "_no_texture")
      compressOutput: |
        let artifact = env.get("workerArtifactPath");
        let citygml = file::extract_filename_without_ext(env.get("cityGmlPath"));
        let parts = citygml.split("_op_");
        citygml = parts[0];
        let udx_dirs = env.get("__value")["__udxDirs"];
        udx_dirs.replace("/", "_");
        let name = file::extract_filename_without_ext(env.get("__value")["__name"]);
        let lod = name.split("_").pop();
        file::join_path(artifact, citygml + "_op_" + udx_dirs + "_3dtiles_" + lod + "_no_texture.zip")
  - id: 739c7093-63e5-43b8-a1b1-1eeae82f3de1
    name: CreateDictionaryNameDict
    type: action
    action: AttributeManager
    with:
      operations:
      - attribute: dict_name
        method: create
        value: |
          let udx_dirs = env.get("__value")["__udxDirs"];
          let parts = udx_dirs.split("/");
          let last_segment = parts[parts.len() - 1];
          let name = file::extract_filename_without_ext(env.get("__value")["__name"]);
          let lod = name.split("_").pop();
          last_segment + "_" + lod
  - id: c24dbf9e-1741-4c61-99bc-618582b1e03b
    name: AttributeDuplicateFilterDict
    type: action
    action: AttributeDuplicateFilter
    with:
      filterBy:
      - __package
      - dict_name
  - id: defb033b-e2aa-4ad1-a9ff-58d9cf6dea47
    name: JsonWriterDict
    type: action
    action: JsonWriter
    with:
      output: |
        file::join_path(env.get("workerArtifactPath"), "dictionary.json")
      converter: |
        let packages = #{};
        for feature in env.get("__features") {
          let pkg = feature["__package"];
          if pkg == () { continue; }
          if packages[pkg] == () {
            packages[pkg] = [];
          }
          let scale = feature["uro:scale"];
          if scale[1] == "1" {
            scale = "計画規模";
          } else if scale[1] == "2" {
            scale = "想定最大規模";
          }
          packages[pkg].push(#{
            name: feature.dict_name,
            description: feature["uro:description"],
            admin: feature["uro:adminType"],
            scale: scale,
          });
        }
        packages
  edges:
  - id: 5ebf24ab-1d98-49d5-8f58-eb7c18d27244
    from: 90f40a3e-61d3-48e2-a328-e7226c2ad1ae
    to: d376f32b-7ce8-4721-8b9e-bfa39d71b860
    fromPort: default
    toPort: default
  - id: 7b81f501-3f07-4cec-bf9b-9cefcebdf47d
    from: d376f32b-7ce8-4721-8b9e-bfa39d71b860
    to: ded2e272-e05c-4918-86b3-aa9f763da6e6
    fromPort: default
    toPort: default
  - id: cf845867-6ffc-4b83-9fd5-e376a22470e2
    from: ded2e272-e05c-4918-86b3-aa9f763da6e6
    to: e2441531-649a-4dcd-916f-ac59f7d56de3
    fromPort: default
    toPort: default
  - id: 7e8f9a0b-1c2d-3e4f-5a6b-7c8d9e0f1a2b
    from: e2441531-649a-4dcd-916f-ac59f7d56de3
    to: 6e5ed9fc-006e-4dbe-8699-4663dba795cb
    fromPort: default
    toPort: default
  - id: ad52c3e6-68ff-4844-a7b2-d302fc0aef14
    from: 6e5ed9fc-006e-4dbe-8699-4663dba795cb
    to: 20cb127d-fc8a-4921-8ab6-0f88438eb9e0
    fromPort: default
    toPort: default
  - id: e862f11a-88a6-4c1b-a743-ba80253039df
    from: 20cb127d-fc8a-4921-8ab6-0f88438eb9e0
    to: 8b05f9d4-1cb2-4071-a1da-c968431bc0ec
    fromPort: default
    toPort: default
  - id: 92e83e72-2507-4a3e-8889-815fb6eeb68d
    from: 8b05f9d4-1cb2-4071-a1da-c968431bc0ec
    to: 3f7a8b2c-4d9e-5a1f-6b3c-7d8e9f0a1b2c
    fromPort: default
    toPort: default
  - id: 4c5d6e7f-8a9b-0c1d-2e3f-4a5b6c7d8e9f
    from: 3f7a8b2c-4d9e-5a1f-6b3c-7d8e9f0a1b2c
    to: b4862d31-4bb2-49b1-8f0d-6d58dd4cb385
    fromPort: default
    toPort: default
  - id: 48893ceb-2d37-4ca2-b5c0-184ea4128409
    from: 20cb127d-fc8a-4921-8ab6-0f88438eb9e0
    to: 739c7093-63e5-43b8-a1b1-1eeae82f3de1
    fromPort: default
    toPort: default
  - id: 1e5c26d5-2082-4fed-9890-89fb517ef184
    from: 739c7093-63e5-43b8-a1b1-1eeae82f3de1
    to: c24dbf9e-1741-4c61-99bc-618582b1e03b
    fromPort: default
    toPort: default
  - id: db2b57d8-b2e2-4094-aa82-c76b555fdb60
    from: c24dbf9e-1741-4c61-99bc-618582b1e03b
    to: defb033b-e2aa-4ad1-a9ff-58d9cf6dea47
    fromPort: default
    toPort: default
