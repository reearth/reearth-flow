# yaml-language-server: $schema=https://raw.githubusercontent.com/reearth/reearth-flow/main/schema/workflow.json
id: e89620bc-5a16-4f21-a717-a974798a004c
name: "QualityCheck-03-tran-rwy-trk-squr-wwy-workflow"
entryGraphId: 43581967-2a15-450a-ba13-e450376c3d0e
with:
  cityGmlPath:
  cityCode:
  codelistsPath:
  schemasPath:
  schemaJson: !include ../../../config/schema.txt
  targetPackages:
    - luse
    - urf
    - area
  addNsprefixToFeatureTypes: true
  extractDmGeometryAsXmlFragment: false
  outputPath:
graphs:
  - !include ../../../graphs/lod_splitter_with_dm.yml
  - !include ../../../graphs/folder_and_file_path_reader.yml
  - !include ../../../graphs/surface_validator_2d.yml
  - id: 43581967-2a15-450a-ba13-e450376c3d0e
    name: entry_point
    nodes:
      - id: f04d8a32-6ac7-4509-8cfc-6d5a318e8dd6
        name: FolderAndfilePathReader
        type: subGraph
        subGraphId: c6863b71-953b-4d15-af56-396fc93fc617

      - id: d14aa9aa-5fe4-4c40-8c80-b15fd674d5e0
        name: AttributeManager
        type: action
        action: AttributeManager
        with:
          operations:
            - attribute: destDataset
              method: create
              value: |
                if env.get("__value")["package"] == "luse" {
                  "05-1_土地利用"
                } else if env.get("__value")["package"] == "urf"{
                  "05-2_都市計画決定情報"
                } else if env.get("__value")["package"] == "area" {
                  "05-3_区域"
                } else {
                  "Invalid Package"
                }

      - id: aa4c813c-c7b4-4e86-8513-e5d7829ec70f
        name: FeatureReader
        type: action
        action: FeatureReader
        with:
          format: citygml
          dataset: |
            env.get("__value").cityGmlPath

      - id: 5dd7ed75-a71d-46cf-91f6-42745f70b022
        name: LodSplitterWithDm
        type: subGraph
        subGraphId: 7e98d856-1438-4148-bdcb-91747ef2e405

      - id: 1fb4ce1c-538a-436d-8dfa-79185e032de3
        name: AttributeAggregator
        type: action
        action: AttributeAggregator
        with:
          aggregateAttributes:
            - newAttribute: Index
              attributeValue: |
                env.get("__value").fileIndex.to_string()

            - newAttribute: Folder
              attribute: package

            - newAttribute: Filename
              attributeValue: |
                file::extract_filename(env.get("__value").cityGmlPath)

            - newAttribute: "フィーチャータイプ"
              attribute: featureType

            - newAttribute: destDataset
              attributeValue: |
                file::extract_filename(env.get("__value").cityGmlPath)

          calculation: |
            1
          calculationAttribute: "インスタンス数"
          method: count

      - id: 7debf320-37c4-414e-acab-9f2fb41e2848
        name: FileTSVWriterC02
        type: action
        action: FileWriter
        with:
          format: tsv
          output: |
            file::join_path(env.get("outputPath"), "地物インスタンス数.tsv")

      - id: 0d469855-57f4-4f0f-923c-c5aca71645e2
        name: SurfaceValidator2D
        type: subGraph
        subGraphId: f4e71783-0b7d-4d4a-9377-cf8d7f061f3b

      - id: 2ef0424c-3158-4d5a-9ce2-a4d2d5afa3b4
        name: NoopInCorrectOrientation
        type: action
        action: NoopSink

    edges:
      - id: 7b81f501-3f07-4cec-bf9b-9cefcebdf47d
        from: f04d8a32-6ac7-4509-8cfc-6d5a318e8dd6
        to: d14aa9aa-5fe4-4c40-8c80-b15fd674d5e0
        fromPort: default
        toPort: default
      - id: bb4b881e-bc51-435f-acdc-06bc6b4c0109
        from: d14aa9aa-5fe4-4c40-8c80-b15fd674d5e0
        to: aa4c813c-c7b4-4e86-8513-e5d7829ec70f
        fromPort: default
        toPort: default
      - id: 337a7047-225f-4950-8d6c-03562ace402d
        from: aa4c813c-c7b4-4e86-8513-e5d7829ec70f
        to: 5dd7ed75-a71d-46cf-91f6-42745f70b022
        fromPort: default
        toPort: default
      - id: 79f03631-6e78-4531-b368-7d93d54d54c8
        from: 5dd7ed75-a71d-46cf-91f6-42745f70b022
        to: 1fb4ce1c-538a-436d-8dfa-79185e032de3
        fromPort: lod1
        toPort: default
      - id: 84ca88cc-a0f0-4992-82d6-9b6c831f9da0
        from: 1fb4ce1c-538a-436d-8dfa-79185e032de3
        to: 7debf320-37c4-414e-acab-9f2fb41e2848
        fromPort: default
        toPort: default
      - id: 9fc119c2-2c75-4999-ba61-59a1d2835636
        from: 5dd7ed75-a71d-46cf-91f6-42745f70b022
        to: 0d469855-57f4-4f0f-923c-c5aca71645e2
        fromPort: lod1
        toPort: default
      - id: 2ef0424c-3158-4d5a-9ce2-a4d2d5afa3b4
        from: 0d469855-57f4-4f0f-923c-c5aca71645e2
        to: 2ef0424c-3158-4d5a-9ce2-a4d2d5afa3b4
        fromPort: inCorrectOrientation
        toPort: default
