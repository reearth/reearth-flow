name: Release
on:
  workflow_dispatch:
    inputs:
      version:
        required: false
        description: 'Next version (patch/minor/major for stable, "custom" for alpha/beta)'
        type: choice
        default: minor
        options:
          - patch
          - minor
          - major
          - custom
      custom_version:
        required: false
        description: 'Custom version (e.g., 0.1.0-alpha.1) - Only used when version is "custom"'
        type: string
jobs:
  release:
    name: Release (⚠️ MUST run from release branch)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/release'
    steps:
      - name: ⚠️ Verify release branch
        run: |
          if [ "${{ github.ref }}" != "refs/heads/release" ]; then
            echo "::error::This workflow must be run from the 'release' branch!"
            exit 1
          fi
          echo "✅ Running from release branch"
      - uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        id: app-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
      - name: Set up git config
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git config --global pull.rebase false
      - id: changelog
        name: Generate CHANGELOG
        uses: reearth/changelog-action@main
        with:
          version: ${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || github.event.inputs.version }}
          repo: ${{ github.repository }}
          latest: CHANGELOG_latest.md
      - name: Upload latest CHANGELOG
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: changelog-${{ steps.changelog.outputs.version }}
          path: CHANGELOG_latest.md
      - name: Commit & push to release
        env:
          TAG: v${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || steps.changelog.outputs.version }}
        run: |
          rm CHANGELOG_latest.md
          git add CHANGELOG.md
          git commit -am "$TAG"
          git tag -f $TAG
          git push origin :refs/tags/$TAG 2>/dev/null || true
          git push --atomic origin release $TAG
      - name: Get commit SHA
        id: get_sha
        run: |
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
      - name: Commit & push to main
        run: git switch main && git cherry-pick release && git push
    outputs:
      new_tag: v${{ github.event.inputs.version == 'custom' && github.event.inputs.custom_version || steps.changelog.outputs.version }}
      version: ${{ steps.changelog.outputs.version }}
      sha: ${{ steps.get_sha.outputs.sha }}
      sha_short: ${{ steps.get_sha.outputs.sha_short }}

  build:
    name: Build and release server
    runs-on: ubuntu-latest
    needs: release
    env:
      ARTIFACTS: server/api/dist/reearth-flow_*.*
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
          ref: ${{ needs.release.outputs.sha }}
      - name: Set up Go
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version-file: 'server/api/go.mod'
          check-latest: true
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@9c156ee8a17a598857849441385a2041ef570552 # v6.3.0
        with:
          distribution: goreleaser
          version: ~> v2
          args: release --clean
          workdir: server/api
        env:
          GORELEASER_CURRENT_TAG: ${{ needs.release.outputs.new_tag }}
      - name: List artifacts
        run: ls -l server/api/dist
      - name: Download latest changelog
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
        with:
          name: changelog-${{ needs.release.outputs.version }}
      - name: Truncate changelog if too long
        run: |
          MAX_SIZE=120000
          if [ -f CHANGELOG_latest.md ]; then
            SIZE=$(wc -c < CHANGELOG_latest.md)
            if [ $SIZE -gt $MAX_SIZE ]; then
              echo "Changelog is $SIZE bytes, truncating to $MAX_SIZE..."
              head -c $MAX_SIZE CHANGELOG_latest.md > CHANGELOG_truncated.md
              echo -e "\n\n... (changelog truncated due to GitHub's 125,000 character limit)" >> CHANGELOG_truncated.md
              mv CHANGELOG_truncated.md CHANGELOG_latest.md
            fi
          fi
      - name: Create GitHub release
        uses: ncipollo/release-action@440c8c1cb0ed28b9f43e4d1d670870f059653174 # v1.16.0
        with:
          allowUpdates: true
          artifacts: ${{ env.ARTIFACTS }}
          commit: ${{ needs.release.outputs.sha }}
          name: ${{ needs.release.outputs.new_tag }}
          tag: ${{ needs.release.outputs.new_tag }}
          bodyFile: CHANGELOG_latest.md
